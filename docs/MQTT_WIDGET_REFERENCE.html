<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="pandoc">
  <title>MQTT Widget Reference</title>
  <link rel="stylesheet" href="kingkiosk-docs.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='6' fill='%23f59e0b'/><text x='50%25' y='55%25' dominant-baseline='middle' text-anchor='middle' fill='white' font-weight='800' font-size='18' font-family='system-ui'>K</text></svg>">
</head>
<body>

<!-- Top Navigation -->
<nav class="top-nav">
  <a href="index.html" class="logo">
    <span class="logo-icon">K</span>
    <span>KingKiosk Docs</span>
  </a>
  <div class="nav-search-wrap">
    <div class="nav-search" id="navSearch">
      <svg class="nav-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input type="text" id="navSearchInput" class="nav-search-input" placeholder="Search docs..." autocomplete="off" spellcheck="false">
      <kbd class="nav-search-kbd">/</kbd>
    </div>
    <div class="nav-search-results" id="navSearchResults"></div>
  </div>
  <ul class="nav-links">
    <li><a href="index.html" >Home</a></li>
    <li><a href="KINGKIOSK_USER_GUIDE.html" >User Guide</a></li>
    <li><a href="MQTT_WIDGET_REFERENCE.html" class="active">MQTT Reference</a></li>
    <li><a href="CUSTOM_WIDGET_SDK.html" >Widget SDK</a></li>
    <li><a href="https://kingkiosk.kallinnovations.com" target="_blank">Website &nearr;</a></li>
  </ul>
</nav>

<!-- Sidebar Toggle (mobile) -->
<button class="sidebar-toggle" onclick="document.querySelector('.sidebar').classList.toggle('open')" aria-label="Toggle navigation">
  &#9776;
</button>

<div class="page-wrapper">

  <!-- Sidebar with TOC -->
  <aside class="sidebar">
    <div class="toc-title">On this page</div>
    <ul>
    <li><a href="#kingkiosk-mqtt-element-architecture-reference"
    id="toc-kingkiosk-mqtt-element-architecture-reference"><span
    class="toc-section-number">1</span> KingKiosk MQTT Element
    Architecture Reference</a>
    <ul>
    <li><a href="#admin-ui-contract-definitive"
    id="toc-admin-ui-contract-definitive"><span
    class="toc-section-number">1.1</span> Admin UI Contract
    (Definitive)</a></li>
    <li><a href="#table-of-contents" id="toc-table-of-contents"><span
    class="toc-section-number">1.2</span> Table of Contents</a></li>
    <li><a href="#overview" id="toc-overview"><span
    class="toc-section-number">1.3</span> Overview</a>
    <ul>
    <li><a href="#key-benefits" id="toc-key-benefits"><span
    class="toc-section-number">1.3.1</span> Key Benefits</a></li>
    <li><a href="#implementation-status-current"
    id="toc-implementation-status-current"><span
    class="toc-section-number">1.3.2</span> Implementation Status
    (Current)</a></li>
    </ul></li>
    <li><a href="#feature-server-autodiscovery"
    id="toc-feature-server-autodiscovery"><span
    class="toc-section-number">1.4</span> Feature Server
    Autodiscovery</a>
    <ul>
    <li><a href="#discovery-topic" id="toc-discovery-topic"><span
    class="toc-section-number">1.4.1</span> Discovery Topic</a></li>
    <li><a href="#client-behavior" id="toc-client-behavior"><span
    class="toc-section-number">1.4.2</span> Client Behavior</a></li>
    <li><a href="#manual-override-lock"
    id="toc-manual-override-lock"><span
    class="toc-section-number">1.4.3</span> Manual Override
    Lock</a></li>
    <li><a href="#server-implementation"
    id="toc-server-implementation"><span
    class="toc-section-number">1.4.4</span> Server
    Implementation</a></li>
    <li><a href="#example-server-announcement"
    id="toc-example-server-announcement"><span
    class="toc-section-number">1.4.5</span> Example: Server
    Announcement</a></li>
    </ul></li>
    <li><a href="#native-os-widgets" id="toc-native-os-widgets"><span
    class="toc-section-number">1.5</span> Native OS Widgets</a>
    <ul>
    <li><a href="#supported-widget-types"
    id="toc-supported-widget-types"><span
    class="toc-section-number">1.5.1</span> Supported Widget
    Types</a></li>
    <li><a href="#architecture" id="toc-architecture"><span
    class="toc-section-number">1.5.2</span> Architecture</a></li>
    <li><a href="#creating-an-os-widget"
    id="toc-creating-an-os-widget"><span
    class="toc-section-number">1.5.3</span> Creating an OS
    Widget</a></li>
    <li><a href="#widget-update-mechanisms"
    id="toc-widget-update-mechanisms"><span
    class="toc-section-number">1.5.4</span> Widget Update
    Mechanisms</a></li>
    <li><a href="#widget-lifecycle" id="toc-widget-lifecycle"><span
    class="toc-section-number">1.5.5</span> Widget Lifecycle</a></li>
    <li><a href="#mqtt-config-for-widget-extensions"
    id="toc-mqtt-config-for-widget-extensions"><span
    class="toc-section-number">1.5.6</span> MQTT Config for Widget
    Extensions</a></li>
    <li><a href="#platform-specific-implementation"
    id="toc-platform-specific-implementation"><span
    class="toc-section-number">1.5.7</span> Platform-Specific
    Implementation</a></li>
    <li><a href="#debugging" id="toc-debugging"><span
    class="toc-section-number">1.5.8</span> Debugging</a></li>
    </ul></li>
    <li><a href="#topic-structure" id="toc-topic-structure"><span
    class="toc-section-number">1.6</span> Topic Structure</a>
    <ul>
    <li><a href="#command-topics-subscribe"
    id="toc-command-topics-subscribe"><span
    class="toc-section-number">1.6.1</span> Command Topics
    (Subscribe)</a></li>
    <li><a href="#stateevent-topics-publish"
    id="toc-stateevent-topics-publish"><span
    class="toc-section-number">1.6.2</span> State/Event Topics
    (Publish)</a></li>
    </ul></li>
    <li><a href="#element-commands" id="toc-element-commands"><span
    class="toc-section-number">1.7</span> Element Commands</a>
    <ul>
    <li><a href="#topic-format" id="toc-topic-format"><span
    class="toc-section-number">1.7.1</span> Topic Format</a></li>
    <li><a href="#command-payload-format"
    id="toc-command-payload-format"><span
    class="toc-section-number">1.7.2</span> Command Payload
    Format</a></li>
    <li><a href="#notes" id="toc-notes"><span
    class="toc-section-number">1.7.3</span> Notes</a></li>
    <li><a href="#example-send-command-to-a-clock-element"
    id="toc-example-send-command-to-a-clock-element"><span
    class="toc-section-number">1.7.4</span> Example: Send command to a
    clock element</a></li>
    </ul></li>
    <li><a href="#element-state" id="toc-element-state"><span
    class="toc-section-number">1.8</span> Element State</a>
    <ul>
    <li><a href="#topic-format-1" id="toc-topic-format-1"><span
    class="toc-section-number">1.8.1</span> Topic Format</a></li>
    <li><a href="#state-payload-example-clock-widget"
    id="toc-state-payload-example-clock-widget"><span
    class="toc-section-number">1.8.2</span> State Payload Example (Clock
    Widget)</a></li>
    </ul></li>
    <li><a href="#element-events" id="toc-element-events"><span
    class="toc-section-number">1.9</span> Element Events</a>
    <ul>
    <li><a href="#topic-format-2" id="toc-topic-format-2"><span
    class="toc-section-number">1.9.1</span> Topic Format</a></li>
    <li><a href="#event-types" id="toc-event-types"><span
    class="toc-section-number">1.9.2</span> Event Types</a></li>
    <li><a href="#event-payload-example"
    id="toc-event-payload-example"><span
    class="toc-section-number">1.9.3</span> Event Payload
    Example</a></li>
    </ul></li>
    <li><a href="#system-commands" id="toc-system-commands"><span
    class="toc-section-number">1.10</span> System Commands</a>
    <ul>
    <li><a href="#topic-format-3" id="toc-topic-format-3"><span
    class="toc-section-number">1.10.1</span> Topic Format</a></li>
    <li><a href="#supported-system-commands"
    id="toc-supported-system-commands"><span
    class="toc-section-number">1.10.2</span> Supported System
    Commands</a></li>
    <li><a href="#example-create-a-clock-via-system-command"
    id="toc-example-create-a-clock-via-system-command"><span
    class="toc-section-number">1.10.3</span> Example: Create a clock via
    system command</a></li>
    </ul></li>
    <li><a href="#device-info" id="toc-device-info"><span
    class="toc-section-number">1.11</span> Device Info</a>
    <ul>
    <li><a href="#topic-format-4" id="toc-topic-format-4"><span
    class="toc-section-number">1.11.1</span> Topic Format</a></li>
    <li><a href="#info-payload" id="toc-info-payload"><span
    class="toc-section-number">1.11.2</span> Info Payload</a></li>
    </ul></li>
    <li><a href="#signed-envelope-format"
    id="toc-signed-envelope-format"><span
    class="toc-section-number">1.12</span> Signed Envelope Format</a>
    <ul>
    <li><a href="#envelope-format" id="toc-envelope-format"><span
    class="toc-section-number">1.12.1</span> Envelope Format</a></li>
    <li><a href="#signature-computation"
    id="toc-signature-computation"><span
    class="toc-section-number">1.12.2</span> Signature
    Computation</a></li>
    <li><a href="#example-python" id="toc-example-python"><span
    class="toc-section-number">1.12.3</span> Example (Python)</a></li>
    </ul></li>
    <li><a href="#widget-type-reference"
    id="toc-widget-type-reference"><span
    class="toc-section-number">1.13</span> Widget Type Reference</a>
    <ul>
    <li><a href="#common-window-geometry-keys"
    id="toc-common-window-geometry-keys"><span
    class="toc-section-number">1.13.1</span> Common Window Geometry
    Keys</a></li>
    <li><a href="#system-windowlayout-commands"
    id="toc-system-windowlayout-commands"><span
    class="toc-section-number">1.13.2</span> System (Window/Layout)
    Commands</a></li>
    <li><a href="#system-non-window-commands"
    id="toc-system-non-window-commands"><span
    class="toc-section-number">1.13.3</span> System (Non-Window)
    Commands</a></li>
    <li><a href="#map" id="toc-map"><span
    class="toc-section-number">1.13.4</span> Map</a></li>
    <li><a href="#canvas" id="toc-canvas"><span
    class="toc-section-number">1.13.5</span> Canvas</a></li>
    <li><a href="#animated-text" id="toc-animated-text"><span
    class="toc-section-number">1.13.6</span> Animated Text</a></li>
    <li><a href="#clock" id="toc-clock"><span
    class="toc-section-number">1.13.7</span> Clock</a></li>
    <li><a href="#weather-openweather"
    id="toc-weather-openweather"><span
    class="toc-section-number">1.13.8</span> Weather
    (OpenWeather)</a></li>
    <li><a href="#alarmo" id="toc-alarmo"><span
    class="toc-section-number">1.13.9</span> Alarmo</a></li>
    <li><a href="#mqtt-button-mqtt-action-status"
    id="toc-mqtt-button-mqtt-action-status"><span
    class="toc-section-number">1.13.10</span> MQTT Button (MQTT Action
    Status)</a></li>
    <li><a href="#charts" id="toc-charts"><span
    class="toc-section-number">1.13.11</span> Charts</a></li>
    <li><a href="#mqtt-gauges" id="toc-mqtt-gauges"><span
    class="toc-section-number">1.13.12</span> MQTT Gauges</a></li>
    <li><a href="#carousels" id="toc-carousels"><span
    class="toc-section-number">1.13.13</span> Carousels</a></li>
    <li><a href="#media-videoaudioimageweb"
    id="toc-media-videoaudioimageweb"><span
    class="toc-section-number">1.13.14</span> Media
    (Video/Audio/Image/Web)</a></li>
    <li><a href="#web-pdf" id="toc-web-pdf"><span
    class="toc-section-number">1.13.15</span> Web / PDF</a></li>
    <li><a href="#calendar" id="toc-calendar"><span
    class="toc-section-number">1.13.16</span> Calendar</a></li>
    <li><a href="#timers-stopwatch" id="toc-timers-stopwatch"><span
    class="toc-section-number">1.13.17</span> Timers /
    Stopwatch</a></li>
    <li><a href="#games" id="toc-games"><span
    class="toc-section-number">1.13.18</span> Games</a></li>
    <li><a href="#mqtt-image-tile" id="toc-mqtt-image-tile"><span
    class="toc-section-number">1.13.19</span> MQTT Image Tile</a></li>
    <li><a href="#led-panel-programmable-light-display"
    id="toc-led-panel-programmable-light-display"><span
    class="toc-section-number">1.13.20</span> LED Panel (Programmable
    Light Display)</a></li>
    </ul></li>
    <li><a href="#integration-examples"
    id="toc-integration-examples"><span
    class="toc-section-number">1.14</span> Integration Examples</a>
    <ul>
    <li><a href="#node-red-monitor-and-control-a-clock-widget"
    id="toc-node-red-monitor-and-control-a-clock-widget"><span
    class="toc-section-number">1.14.1</span> Node-RED: Monitor and
    Control a Clock Widget</a></li>
    <li><a href="#home-assistant-widget-state-sensor"
    id="toc-home-assistant-widget-state-sensor"><span
    class="toc-section-number">1.14.2</span> Home Assistant: Widget
    State Sensor</a></li>
    <li><a href="#python-list-all-widgets-on-a-device"
    id="toc-python-list-all-widgets-on-a-device"><span
    class="toc-section-number">1.14.3</span> Python: List All Widgets on
    a Device</a></li>
    </ul></li>
    <li><a href="#canonical-topic-summary"
    id="toc-canonical-topic-summary"><span
    class="toc-section-number">1.15</span> Canonical Topic
    Summary</a></li>
    <li><a href="#developer-guide-adding-mqtt-support-to-widgets"
    id="toc-developer-guide-adding-mqtt-support-to-widgets"><span
    class="toc-section-number">1.16</span> Developer Guide: Adding MQTT
    Support to Widgets</a>
    <ul>
    <li><a href="#add-the-mixin" id="toc-add-the-mixin"><span
    class="toc-section-number">1.16.1</span> 1. Add the Mixin</a></li>
    <li><a href="#register-in-oninit" id="toc-register-in-oninit"><span
    class="toc-section-number">1.16.2</span> 2. Register in
    onInit</a></li>
    <li><a href="#unregister-in-onclose"
    id="toc-unregister-in-onclose"><span
    class="toc-section-number">1.16.3</span> 3. Unregister in
    onClose</a></li>
    <li><a href="#handle-commands" id="toc-handle-commands"><span
    class="toc-section-number">1.16.4</span> 4. Handle Commands</a></li>
    <li><a href="#build-state" id="toc-build-state"><span
    class="toc-section-number">1.16.5</span> 5. Build State</a></li>
    <li><a href="#publish-events-optional"
    id="toc-publish-events-optional"><span
    class="toc-section-number">1.16.6</span> 6. Publish Events
    (Optional)</a></li>
    </ul></li>
    <li><a href="#appendix-a-led-panel-scripting-engine-reference"
    id="toc-appendix-a-led-panel-scripting-engine-reference"><span
    class="toc-section-number">1.17</span> Appendix A: LED Panel
    Scripting Engine Reference</a>
    <ul>
    <li><a href="#how-it-works" id="toc-how-it-works"><span
    class="toc-section-number">1.17.1</span> How It Works</a></li>
    <li><a href="#script-json-format" id="toc-script-json-format"><span
    class="toc-section-number">1.17.2</span> Script JSON Format</a></li>
    <li><a href="#the-hsl-color-model"
    id="toc-the-hsl-color-model"><span
    class="toc-section-number">1.17.3</span> The HSL Color
    Model</a></li>
    <li><a href="#expression-syntax" id="toc-expression-syntax"><span
    class="toc-section-number">1.17.4</span> Expression Syntax</a></li>
    <li><a href="#built-in-variables" id="toc-built-in-variables"><span
    class="toc-section-number">1.17.5</span> Built-in Variables</a></li>
    <li><a href="#built-in-functions" id="toc-built-in-functions"><span
    class="toc-section-number">1.17.6</span> Built-in Functions</a></li>
    <li><a href="#recipes-and-examples"
    id="toc-recipes-and-examples"><span
    class="toc-section-number">1.17.7</span> Recipes and
    Examples</a></li>
    <li><a href="#performance-tips" id="toc-performance-tips"><span
    class="toc-section-number">1.17.8</span> Performance Tips</a></li>
    </ul></li>
    </ul></li>
    </ul>
  </aside>

  <!-- Main Content -->
  <div class="content-wrapper">
    <main class="content">
      <header id="title-block-header">
        <h1 class="title">MQTT Widget Reference</h1>
        <p class="subtitle">Complete MQTT Command and Widget API
Reference</p>
        <p class="date">Last updated: February 2026</p>
      </header>
<h1 data-number="1"
id="kingkiosk-mqtt-element-architecture-reference"><span
class="header-section-number">1</span> KingKiosk MQTT Element
Architecture Reference</h1>
<p>This document describes the KingDSP-style MQTT architecture for
KingKiosk.</p>
<p>Canonical control is split into:</p>
<ol type="1">
<li><strong>System-level commands</strong> (<code>system/*</code>) -
control the device as a whole</li>
<li><strong>Element-level commands</strong> (<code>element/*</code>) -
control an individual element (typically a window tile)</li>
</ol>
<p>Legacy topic families (including <code>widget/{id}/*</code>,
<code>.../command</code>, and any window-scoped command topics) are
intentionally <strong>not supported</strong> in the current
implementation.</p>
<h2 data-number="1.1" id="admin-ui-contract-definitive"><span
class="header-section-number">1.1</span> Admin UI Contract
(Definitive)</h2>
<p>If you are building or rewriting the King Admin interface, treat the
following as the stable MQTT API contract:</p>
<ul>
<li><strong>Ingress (commands)</strong>
<ul>
<li>Device/system: <code>kingkiosk/{device_id}/system/cmd</code></li>
<li>Element-scoped (optional, only when a widget registers a handler):
<code>kingkiosk/{device_id}/element/{element_id}/cmd</code></li>
</ul></li>
<li><strong>Egress (responses)</strong>
<ul>
<li>System responses:
<code>kingkiosk/{device_id}/system/response</code></li>
<li>Element responses:
<code>kingkiosk/{device_id}/element/{element_id}/response</code></li>
</ul></li>
<li><strong>State &amp; events (for UI rendering)</strong>
<ul>
<li>Device capabilities: <code>kingkiosk/{device_id}/info</code>
(retained)</li>
<li>Element state:
<code>kingkiosk/{device_id}/element/{element_id}/state</code>
(retained)</li>
<li>Element events:
<code>kingkiosk/{device_id}/element/{element_id}/event</code>
(non-retained)</li>
</ul></li>
</ul>
<p>Rules: - Do <strong>not</strong> publish/subscribe to legacy topic
families (no <code>.../command</code>, no <code>widget/...</code>, no
window-scoped MQTT topics). - For any command, if
<code>response_topic</code> is omitted, the app will default to the
canonical system/element response topic based on the ingress topic. -
For “full coverage” control surfaces (create windows, move/resize,
tiling, etc.), rely on the <strong>System Commands</strong> section
(system/cmd). Treat element commands as widget-specific
enhancements.</p>
<h2 data-number="1.2" id="table-of-contents"><span
class="header-section-number">1.2</span> Table of Contents</h2>
<ol type="1">
<li><a href="#overview">Overview</a></li>
<li><a href="#topic-structure">Topic Structure</a></li>
<li><a href="#element-commands">Element Commands</a></li>
<li><a href="#element-state">Element State</a></li>
<li><a href="#element-events">Element Events</a></li>
<li><a href="#system-commands">System Commands</a></li>
<li><a href="#device-info">Device Info</a></li>
<li><a href="#signed-envelope-format">Signed Envelope Format</a></li>
<li><a href="#widget-type-reference">Widget Type Reference</a></li>
<li><a href="#integration-examples">Integration Examples</a></li>
</ol>
<hr />
<h2 data-number="1.3" id="overview"><span
class="header-section-number">1.3</span> Overview</h2>
<p>The architecture provides two levels of MQTT control:</p>
<ol type="1">
<li><strong>System-level commands</strong> - control the device as a
whole (screen, tiling, etc.)</li>
<li><strong>Element-level commands</strong> - direct control of an
individual element/window</li>
</ol>
<h3 data-number="1.3.1" id="key-benefits"><span
class="header-section-number">1.3.1</span> Key Benefits</h3>
<ul>
<li><strong>Granular control</strong>: Send commands directly to a
specific element</li>
<li><strong>Automatic state publishing</strong>: Registered elements can
publish their state automatically</li>
<li><strong>Event streaming</strong>: Real-time events from registered
elements (errors, state changes)</li>
<li><strong>Device discovery</strong>: Retained info topic for
capabilities discovery</li>
<li><strong>Signed envelopes</strong>: Optional HMAC signing for secure
command delivery</li>
</ul>
<h3 data-number="1.3.2" id="implementation-status-current"><span
class="header-section-number">1.3.2</span> Implementation Status
(Current)</h3>
<ul>
<li>The app subscribes to canonical element topics. <strong>Only
widgets/controllers that explicitly register</strong> will receive
element-level commands via the registration-based router.
<ul>
<li>Registration is done via <code>MqttWidgetMixin</code>
(implementation detail).</li>
<li>Unregistered elements are handled via the unified dispatcher
(window/tiling/etc.) when applicable.</li>
</ul></li>
<li><code>kingkiosk/{device_id}/system/cmd</code> is accepted by the app
and is routed to the unified dispatcher when no explicit system handler
is registered. Calendar bidirectional sync details: see
docs/CALENDAR_MQTT_SYNC.md.</li>
</ul>
<hr />
<h2 data-number="1.4" id="feature-server-autodiscovery"><span
class="header-section-number">1.4</span> Feature Server
Autodiscovery</h2>
<p>KingKiosk clients support automatic discovery of the Feature Server
(KingKiosk Core3) via MQTT. This eliminates the need for manual server
URL configuration across multiple devices.</p>
<h3 data-number="1.4.1" id="discovery-topic"><span
class="header-section-number">1.4.1</span> Discovery Topic</h3>
<p><strong>Topic:</strong> <code>kingkiosk/core3/api</code>
(retained)</p>
<p><strong>Payload Format:</strong></p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;api_url&quot;</span><span class="fu">:</span> <span class="st">&quot;http://192.168.1.100:3000&quot;</span><span class="fu">,</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="st">&quot;3.2.1&quot;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>Fields:</strong> - <code>api_url</code> (string, required):
Full HTTP/HTTPS URL to the Feature Server API endpoint -
<code>version</code> (string, optional): Server version string for
compatibility checking</p>
<h3 data-number="1.4.2" id="client-behavior"><span
class="header-section-number">1.4.2</span> Client Behavior</h3>
<p>When a KingKiosk client receives a message on
<code>kingkiosk/core3/api</code>:</p>
<ol type="1">
<li><strong>Parse and validate</strong> the <code>api_url</code>
field</li>
<li><strong>Normalize</strong> the host (extract base URL from api_url
if needed)</li>
<li><strong>Check manual override</strong> - If user has enabled “manual
override lock”, ignore the autodiscovered value</li>
<li><strong>Update server URL</strong> - If not locked, automatically
update the Feature Server connection to use the new URL</li>
<li><strong>Connect</strong> - Attempt connection to the autodiscovered
server</li>
</ol>
<h3 data-number="1.4.3" id="manual-override-lock"><span
class="header-section-number">1.4.3</span> Manual Override Lock</h3>
<p>Users can enable “manual override lock” in settings to prevent
autodiscovery from changing their manually configured server URL. This
is useful for: - Testing against a specific server instance - Using a
non-production server - Temporarily isolating a device from the main
server</p>
<p>When manual override is enabled, the client: - Still subscribes to
<code>kingkiosk/core3/api</code> - Logs incoming discovery messages (for
debugging) - <strong>Does NOT</strong> update the server URL or
reconnect</p>
<h3 data-number="1.4.4" id="server-implementation"><span
class="header-section-number">1.4.4</span> Server Implementation</h3>
<p>The Feature Server (KingKiosk Core3) should: 1. <strong>Publish on
startup</strong> to <code>kingkiosk/core3/api</code> with
<code>retain: true</code> 2. <strong>Include full URL</strong> in
<code>api_url</code> (e.g., <code>http://192.168.1.100:3000</code>) 3.
<strong>Re-publish on config change</strong> if the server URL
changes</p>
<h3 data-number="1.4.5" id="example-server-announcement"><span
class="header-section-number">1.4.5</span> Example: Server
Announcement</h3>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mosquitto_pub</span> <span class="at">-h</span> broker.local <span class="at">-t</span> <span class="st">&quot;kingkiosk/core3/api&quot;</span> <span class="at">-r</span> <span class="at">-m</span> <span class="st">&#39;{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="st">  &quot;api_url&quot;: &quot;http://192.168.1.100:3000&quot;,</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="st">  &quot;version&quot;: &quot;3.2.1&quot;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="st">}&#39;</span></span></code></pre></div>
<hr />
<h2 data-number="1.5" id="native-os-widgets"><span
class="header-section-number">1.5</span> Native OS Widgets</h2>
<p>KingKiosk supports creating native home screen widgets (Android) and
home/lock screen widgets (iOS) that update via MQTT independently of the
main app. This is achieved by adding the <code>os_widget: true</code>
parameter to supported widget creation commands.</p>
<h3 data-number="1.5.1" id="supported-widget-types"><span
class="header-section-number">1.5.1</span> Supported Widget Types</h3>
<table>
<colgroup>
<col style="width: 26%" />
<col style="width: 26%" />
<col style="width: 34%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr>
<th>Widget Kind</th>
<th>iOS Support</th>
<th>Android Support</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>gauge</code></td>
<td>✅</td>
<td>✅</td>
<td>Radial, linear, and thermometer styles</td>
</tr>
<tr>
<td><code>chart</code></td>
<td>✅</td>
<td>✅</td>
<td>Line charts with sparkline view</td>
</tr>
<tr>
<td><code>weather</code></td>
<td>✅</td>
<td>✅</td>
<td>Current conditions + forecast</td>
</tr>
<tr>
<td><code>alarmo</code></td>
<td>✅</td>
<td>✅</td>
<td>Security system status and controls</td>
</tr>
<tr>
<td><code>mqttButton</code></td>
<td>✅ (iOS 17+)</td>
<td>✅</td>
<td>Toggle buttons with state feedback</td>
</tr>
<tr>
<td><code>sensor</code></td>
<td>✅</td>
<td>✅</td>
<td>Simple numeric value display</td>
</tr>
<tr>
<td><code>counter</code></td>
<td>✅</td>
<td>✅</td>
<td>Numeric counter display</td>
</tr>
<tr>
<td><code>clock</code></td>
<td>✅</td>
<td>✅</td>
<td>Current time (no MQTT needed)</td>
</tr>
<tr>
<td><code>canvas</code></td>
<td>✅</td>
<td>✅</td>
<td>Snapshot-based visual diagrams</td>
</tr>
</tbody>
</table>
<h3 data-number="1.5.2" id="architecture"><span
class="header-section-number">1.5.2</span> Architecture</h3>
<p><strong>Data Flow:</strong></p>
<pre><code>MQTT Broker
    ↓
┌───────────────────────────────────┐
│  KingKiosk App (Flutter)          │
│  • MqttOsWidgetMixin              │ ← Intercepts widget creation
│  • WidgetDataService              │ ← Writes to shared storage
│  • WidgetConfig serialization     │
└───────────────────────────────────┘
    ↓ (App Group shared storage)
┌───────────────────────────────────┐
│  Native Widget Extension          │
│  • iOS: WidgetKit                 │
│  • Android: Glance/AppWidget      │
│  • LightMQTTClient (WebSocket)    │ ← Connects to MQTT independently
│  • Reads WidgetConfig from shared │
│  • Subscribes to configured topic │
│  • Renders natively               │
└───────────────────────────────────┘</code></pre>
<p><strong>Storage Structure:</strong> - <strong>Widget
configs:</strong> Stored in shared storage at key
<code>kk_widget_{widgetId}</code> as JSON - <strong>Cached
values:</strong> Stored at key <code>kk_cache_{widgetId}</code> with
value + history - <strong>MQTT config:</strong> Stored at key
<code>kk_mqtt_config</code> with broker connection info -
<strong>Registered IDs:</strong> List stored at key
<code>kk_registered_widget_ids</code></p>
<h3 data-number="1.5.3" id="creating-an-os-widget"><span
class="header-section-number">1.5.3</span> Creating an OS Widget</h3>
<p>Add the <code>os_widget: true</code> parameter to any supported
widget creation command. The widget will be created both in-app
(optional) and registered as a native OS widget.</p>
<h4 data-number="1.5.3.1" id="example-gauge-widget"><span
class="header-section-number">1.5.3.1</span> Example: Gauge Widget</h4>
<p><strong>Topic:</strong>
<code>kingkiosk/{device_id}/system/cmd</code></p>
<p><strong>Payload:</strong></p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;create_gauge&quot;</span><span class="fu">,</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;window_id&quot;</span><span class="fu">:</span> <span class="st">&quot;temp_sensor_1&quot;</span><span class="fu">,</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;gauge_type&quot;</span><span class="fu">:</span> <span class="st">&quot;radial&quot;</span><span class="fu">,</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="st">&quot;Living Room&quot;</span><span class="fu">,</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;min&quot;</span><span class="fu">:</span> <span class="dv">50</span><span class="fu">,</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;max&quot;</span><span class="fu">:</span> <span class="dv">90</span><span class="fu">,</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;unit&quot;</span><span class="fu">:</span> <span class="st">&quot;°F&quot;</span><span class="fu">,</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;mqtt_topic&quot;</span><span class="fu">:</span> <span class="st">&quot;homeassistant/sensor/living_room_temp/state&quot;</span><span class="fu">,</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;json_field&quot;</span><span class="fu">:</span> <span class="st">&quot;temperature&quot;</span><span class="fu">,</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;os_widget&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;thresholds&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span><span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">70</span><span class="fu">,</span> <span class="dt">&quot;color&quot;</span><span class="fu">:</span> <span class="st">&quot;#4CAF50&quot;</span><span class="fu">}</span><span class="ot">,</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span><span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">75</span><span class="fu">,</span> <span class="dt">&quot;color&quot;</span><span class="fu">:</span> <span class="st">&quot;#FFC107&quot;</span><span class="fu">}</span><span class="ot">,</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span><span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">80</span><span class="fu">,</span> <span class="dt">&quot;color&quot;</span><span class="fu">:</span> <span class="st">&quot;#F44336&quot;</span><span class="fu">}</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>What Happens:</strong> 1. <code>MqttOsWidgetMixin</code>
intercepts the command 2. Extracts a <code>WidgetConfig</code> from the
payload 3. Calls <code>WidgetDataService.registerOsWidget(config)</code>
4. Widget config is written to shared storage as JSON 5. Native widget
extension reads the config on its next timeline refresh 6. Widget
appears in the device’s widget picker (user adds it to home screen) 7.
Widget independently subscribes to the MQTT topic and updates</p>
<h4 data-number="1.5.3.2" id="example-mqtt-button-widget"><span
class="header-section-number">1.5.3.2</span> Example: MQTT Button
Widget</h4>
<p><strong>Topic:</strong>
<code>kingkiosk/{device_id}/system/cmd</code></p>
<p><strong>Payload:</strong></p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;mqtt_button&quot;</span><span class="fu">,</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;action&quot;</span><span class="fu">:</span> <span class="st">&quot;configure&quot;</span><span class="fu">,</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;window_id&quot;</span><span class="fu">:</span> <span class="st">&quot;porch_light_btn&quot;</span><span class="fu">,</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;mode&quot;</span><span class="fu">:</span> <span class="st">&quot;toggle&quot;</span><span class="fu">,</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;label&quot;</span><span class="fu">:</span> <span class="st">&quot;Porch Light&quot;</span><span class="fu">,</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;publish_topic&quot;</span><span class="fu">:</span> <span class="st">&quot;zigbee2mqtt/porch_light/set&quot;</span><span class="fu">,</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;publish_payload&quot;</span><span class="fu">:</span> <span class="st">&quot;{</span><span class="ch">\&quot;</span><span class="st">state</span><span class="ch">\&quot;</span><span class="st">: </span><span class="ch">\&quot;</span><span class="st">TOGGLE</span><span class="ch">\&quot;</span><span class="st">}&quot;</span><span class="fu">,</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;subscribe_topic&quot;</span><span class="fu">:</span> <span class="st">&quot;zigbee2mqtt/porch_light&quot;</span><span class="fu">,</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;status_path&quot;</span><span class="fu">:</span> <span class="st">&quot;state&quot;</span><span class="fu">,</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;icon&quot;</span><span class="fu">:</span> <span class="st">&quot;light_bulb&quot;</span><span class="fu">,</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;icon_off&quot;</span><span class="fu">:</span> <span class="st">&quot;light_bulb_outline&quot;</span><span class="fu">,</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;color_on&quot;</span><span class="fu">:</span> <span class="st">&quot;0xFFFFC107&quot;</span><span class="fu">,</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;color_off&quot;</span><span class="fu">:</span> <span class="st">&quot;0xFF757575&quot;</span><span class="fu">,</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;os_widget&quot;</span><span class="fu">:</span> <span class="kw">true</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>Interaction Flow:</strong> 1. User adds button widget to home
screen 2. Widget displays current state by subscribing to
<code>zigbee2mqtt/porch_light</code> 3. User taps button on home screen
4. Widget publishes to <code>zigbee2mqtt/porch_light/set</code> with
payload 5. Widget receives updated state from subscription topic 6.
Button color/icon updates to reflect new state</p>
<h4 data-number="1.5.3.3" id="example-alarmo-security-widget"><span
class="header-section-number">1.5.3.3</span> Example: Alarmo Security
Widget</h4>
<p><strong>Topic:</strong>
<code>kingkiosk/{device_id}/system/cmd</code></p>
<p><strong>Payload:</strong></p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;alarmo_widget&quot;</span><span class="fu">,</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;window_id&quot;</span><span class="fu">:</span> <span class="st">&quot;home_security&quot;</span><span class="fu">,</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;mqtt_base_topic&quot;</span><span class="fu">:</span> <span class="st">&quot;alarmo&quot;</span><span class="fu">,</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;available_modes&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;armed_away&quot;</span><span class="ot">,</span> <span class="st">&quot;armed_home&quot;</span><span class="ot">,</span> <span class="st">&quot;armed_night&quot;</span><span class="ot">,</span> <span class="st">&quot;disarmed&quot;</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;require_code&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;code_length&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;os_widget&quot;</span><span class="fu">:</span> <span class="kw">true</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h3 data-number="1.5.4" id="widget-update-mechanisms"><span
class="header-section-number">1.5.4</span> Widget Update Mechanisms</h3>
<p>Native OS widgets update via two mechanisms:</p>
<ol type="1">
<li><strong>Direct MQTT subscription</strong> (primary)
<ul>
<li>Widget extension connects to MQTT broker using
<code>LightMQTTClient</code></li>
<li>Subscribes to the topic specified in
<code>WidgetConfig.mqttTopic</code></li>
<li>Updates immediately when messages arrive</li>
<li>Frequency limited by OS (iOS: ~15-60min, Android: configurable)</li>
</ul></li>
<li><strong>Cached value fallback</strong> (secondary)
<ul>
<li>Main app writes latest values to shared storage via
<code>WidgetDataService.writeCachedValue()</code></li>
<li>Widget reads cached value on timeline refresh</li>
<li>Provides instant display even if MQTT connection fails</li>
<li>Maintains 48-point history for sparkline charts</li>
</ul></li>
</ol>
<h3 data-number="1.5.5" id="widget-lifecycle"><span
class="header-section-number">1.5.5</span> Widget Lifecycle</h3>
<p><strong>Registration:</strong></p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">// In MQTT command handler (after creating Flutter widget):</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>maybeCreateOsWidget(payload<span class="op">,</span> WidgetKind<span class="op">.</span>gauge);</span></code></pre></div>
<p><strong>Updates:</strong></p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">// When widget value changes:</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>maybeUpdateOsWidgetValue(windowId<span class="op">,</span> value<span class="op">,</span> stringValue<span class="op">:</span> <span class="st">&quot;72°F&quot;</span>);</span></code></pre></div>
<p><strong>Removal:</strong></p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">// When widget is closed:</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>maybeRemoveOsWidget(windowId);</span></code></pre></div>
<p>Or via MQTT:</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;close_window&quot;</span><span class="fu">,</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;window_id&quot;</span><span class="fu">:</span> <span class="st">&quot;temp_sensor_1&quot;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h3 data-number="1.5.6" id="mqtt-config-for-widget-extensions"><span
class="header-section-number">1.5.6</span> MQTT Config for Widget
Extensions</h3>
<p>Widget extensions require MQTT connection credentials to operate
independently. These are written to shared storage via
<code>WidgetDataService.writeMqttConfig()</code> when the main app
connects to MQTT.</p>
<p><strong>Config Structure</strong> (stored at
<code>kk_mqtt_config</code>):</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;wsUrl&quot;</span><span class="fu">:</span> <span class="st">&quot;wss://broker.local:8884/mqtt&quot;</span><span class="fu">,</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;host&quot;</span><span class="fu">:</span> <span class="st">&quot;broker.local&quot;</span><span class="fu">,</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;port&quot;</span><span class="fu">:</span> <span class="dv">1883</span><span class="fu">,</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;username&quot;</span><span class="fu">:</span> <span class="st">&quot;kingkiosk&quot;</span><span class="fu">,</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;password&quot;</span><span class="fu">:</span> <span class="st">&quot;secret&quot;</span><span class="fu">,</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;useTLS&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;allowSelfSigned&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;hmacEnabled&quot;</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;hmacSecret&quot;</span><span class="fu">:</span> <span class="st">&quot;&quot;</span><span class="fu">,</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;deviceName&quot;</span><span class="fu">:</span> <span class="st">&quot;kitchen_tablet&quot;</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>Important:</strong> Widget extensions use
<strong>WebSocket</strong> MQTT connections, not TCP: - Secure:
<code>wss://</code> on port 8884 (not 8883) - Insecure:
<code>ws://</code> on port 1884 (not 1883)</p>
<h3 data-number="1.5.7" id="platform-specific-implementation"><span
class="header-section-number">1.5.7</span> Platform-Specific
Implementation</h3>
<h4 data-number="1.5.7.1" id="ios-widgetkit"><span
class="header-section-number">1.5.7.1</span> iOS (WidgetKit)</h4>
<ul>
<li><strong>App Group:</strong> <code>group.com.ki.kingkiosk</code></li>
<li><strong>Widget Kinds:</strong> <code>KingKioskGaugeWidget</code>,
<code>KingKioskChartWidget</code>, etc.</li>
<li><strong>Refresh Policy:</strong> Timeline-based, OS-controlled
(15-60 min typical)</li>
<li><strong>Interactive Widgets:</strong> Supported on iOS 17+ via App
Intents</li>
<li><strong>Storage:</strong> UserDefaults with app group suite</li>
</ul>
<h4 data-number="1.5.7.2" id="android-glanceappwidget"><span
class="header-section-number">1.5.7.2</span> Android
(Glance/AppWidget)</h4>
<ul>
<li><strong>Widget Receivers:</strong> <code>GaugeWidgetReceiver</code>,
<code>ChartWidgetReceiver</code>, etc.</li>
<li><strong>Package:</strong>
<code>com.ki.king_kiosk.widgets.receivers</code></li>
<li><strong>Refresh Policy:</strong> Configurable update intervals</li>
<li><strong>Interactive Widgets:</strong> Full click handler
support</li>
<li><strong>Storage:</strong> SharedPreferences with process name</li>
</ul>
<h3 data-number="1.5.8" id="debugging"><span
class="header-section-number">1.5.8</span> Debugging</h3>
<p><strong>Check registered widgets:</strong></p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="at">final</span> service <span class="op">=</span> Get<span class="op">.</span>find<span class="op">&lt;</span>WidgetDataService<span class="op">&gt;</span>();</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>print(service<span class="op">.</span>registeredWidgetIds); <span class="co">// Set&lt;String&gt;</span></span></code></pre></div>
<p><strong>Verify widget config in shared storage:</strong></p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="at">final</span> configJson <span class="op">=</span> <span class="at">await</span> HomeWidget<span class="op">.</span>getWidgetData<span class="op">&lt;</span><span class="dt">String</span><span class="op">&gt;</span>(<span class="st">&#39;kk_widget_temp_sensor_1&#39;</span>);</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="at">final</span> config <span class="op">=</span> WidgetConfig<span class="op">.</span>fromJsonString(configJson);</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>print(config<span class="op">.</span>toJson());</span></code></pre></div>
<p><strong>Check cached value:</strong></p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="at">final</span> cacheJson <span class="op">=</span> <span class="at">await</span> HomeWidget<span class="op">.</span>getWidgetData<span class="op">&lt;</span><span class="dt">String</span><span class="op">&gt;</span>(<span class="st">&#39;kk_cache_temp_sensor_1&#39;</span>);</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="at">final</span> cache <span class="op">=</span> jsonDecode(cacheJson);</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>print(cache[<span class="st">&#39;currentValue&#39;</span>]); <span class="co">// Latest value</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>print(cache[<span class="st">&#39;dataPoints&#39;</span>]); <span class="co">// History (up to 48 points)</span></span></code></pre></div>
<hr />
<h2 data-number="1.6" id="topic-structure"><span
class="header-section-number">1.6</span> Topic Structure</h2>
<h3 data-number="1.6.1" id="command-topics-subscribe"><span
class="header-section-number">1.6.1</span> Command Topics
(Subscribe)</h3>
<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 65%" />
</colgroup>
<thead>
<tr>
<th>Topic</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>kingkiosk/{device_id}/system/cmd</code></td>
<td>New system-level commands</td>
</tr>
<tr>
<td><code>kingkiosk/{device_id}/element/{element_id}/cmd</code></td>
<td>Canonical per-element commands</td>
</tr>
</tbody>
</table>
<h3 data-number="1.6.2" id="stateevent-topics-publish"><span
class="header-section-number">1.6.2</span> State/Event Topics
(Publish)</h3>
<table>
<colgroup>
<col style="width: 23%" />
<col style="width: 33%" />
<col style="width: 43%" />
</colgroup>
<thead>
<tr>
<th>Topic</th>
<th>Retained</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>kingkiosk/{device_id}/info</code></td>
<td>Yes</td>
<td>Device capabilities and active widgets</td>
</tr>
<tr>
<td><code>kingkiosk/{device_id}/status</code></td>
<td>Yes</td>
<td>Online/offline status (LWT)</td>
</tr>
<tr>
<td><code>kingkiosk/{device_id}/system/state</code></td>
<td>Yes</td>
<td>System state (tiling mode, screen info)</td>
</tr>
<tr>
<td><code>kingkiosk/{device_id}/feature_server/state</code></td>
<td>Yes</td>
<td>Feature Server connection/settings state snapshot (enabled,
connected, reconnecting, URL, errors).</td>
</tr>
<tr>
<td><code>kingkiosk/{device_id}/element/{element_id}/state</code></td>
<td>Yes</td>
<td>Element state</td>
</tr>
<tr>
<td><code>kingkiosk/{device_id}/element/{element_id}/event</code></td>
<td>No</td>
<td>Element events</td>
</tr>
<tr>
<td><code>kingkiosk/{device_id}/element/{element_id}/response</code></td>
<td>No</td>
<td>Command response (if correlation_id provided)</td>
</tr>
<tr>
<td><code>kingkiosk/{device_id}/system/response</code></td>
<td>No</td>
<td>System command response</td>
</tr>
</tbody>
</table>
<hr />
<h2 data-number="1.7" id="element-commands"><span
class="header-section-number">1.7</span> Element Commands</h2>
<p>Send commands directly to a specific element using its
<code>element_id</code>.</p>
<h3 data-number="1.7.1" id="topic-format"><span
class="header-section-number">1.7.1</span> Topic Format</h3>
<pre><code>kingkiosk/{device_id}/element/{element_id}/cmd</code></pre>
<h3 data-number="1.7.2" id="command-payload-format"><span
class="header-section-number">1.7.2</span> Command Payload Format</h3>
<div class="sourceCode" id="cb16"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;command_name&quot;</span><span class="fu">,</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;correlation_id&quot;</span><span class="fu">:</span> <span class="st">&quot;optional-tracking-id&quot;</span><span class="fu">,</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="er">...additional</span> <span class="er">parameters...</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h3 data-number="1.7.3" id="notes"><span
class="header-section-number">1.7.3</span> Notes</h3>
<ul>
<li>Element-scoped commands are delivered only to elements that register
a handler with <code>MqttWidgetRouter.registerWidget(...)</code>.</li>
<li>Per-element command schemas are widget-specific. This document
treats <strong>system commands</strong> as the stable contract; element
commands should be considered optional unless explicitly documented for
a given widget.</li>
<li>Window geometry/stacking is controlled via <strong>system
commands</strong> on <code>kingkiosk/{device_id}/system/cmd</code>
(e.g. <code>move_window</code>, <code>resize_window</code>,
<code>set_opacity</code>, <code>maximize_window</code>, etc.).</li>
</ul>
<h3 data-number="1.7.4"
id="example-send-command-to-a-clock-element"><span
class="header-section-number">1.7.4</span> Example: Send command to a
clock element</h3>
<p><strong>Topic:</strong>
<code>kingkiosk/my-device/element/clock-1/cmd</code></p>
<p><strong>Payload:</strong></p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;set_mode&quot;</span><span class="fu">,</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;mode&quot;</span><span class="fu">:</span> <span class="st">&quot;digital&quot;</span><span class="fu">,</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;correlation_id&quot;</span><span class="fu">:</span> <span class="st">&quot;req-12345&quot;</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>Response (on
<code>kingkiosk/my-device/element/clock-1/response</code>):</strong></p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;status&quot;</span><span class="fu">:</span> <span class="st">&quot;success&quot;</span><span class="fu">,</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;mode&quot;</span><span class="fu">:</span> <span class="st">&quot;digital&quot;</span><span class="fu">,</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;correlation_id&quot;</span><span class="fu">:</span> <span class="st">&quot;req-12345&quot;</span><span class="fu">,</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;widget_id&quot;</span><span class="fu">:</span> <span class="st">&quot;clock-1&quot;</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<hr />
<h2 data-number="1.8" id="element-state"><span
class="header-section-number">1.8</span> Element State</h2>
<p>Each registered element automatically publishes its state when: -
Element is created/registered - After any command is processed - When
<code>publishState()</code> is called programmatically</p>
<h3 data-number="1.8.1" id="topic-format-1"><span
class="header-section-number">1.8.1</span> Topic Format</h3>
<pre><code>kingkiosk/{device_id}/element/{element_id}/state</code></pre>
<h3 data-number="1.8.2" id="state-payload-example-clock-widget"><span
class="header-section-number">1.8.2</span> State Payload Example (Clock
Widget)</h3>
<div class="sourceCode" id="cb20"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;clock&quot;</span><span class="fu">,</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;element_id&quot;</span><span class="fu">:</span> <span class="st">&quot;clock-1&quot;</span><span class="fu">,</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;widget_id&quot;</span><span class="fu">:</span> <span class="st">&quot;clock-1&quot;</span><span class="fu">,</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;mode&quot;</span><span class="fu">:</span> <span class="st">&quot;analog&quot;</span><span class="fu">,</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;visible&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;minimized&quot;</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;show_numbers&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;show_second_hand&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;theme&quot;</span><span class="fu">:</span> <span class="st">&quot;auto&quot;</span><span class="fu">,</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;background_mode&quot;</span><span class="fu">:</span> <span class="st">&quot;transparent&quot;</span><span class="fu">,</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;background_opacity&quot;</span><span class="fu">:</span> <span class="fl">0.6</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<hr />
<h2 data-number="1.9" id="element-events"><span
class="header-section-number">1.9</span> Element Events</h2>
<p>Registered elements publish non-retained events for real-time
notifications.</p>
<h3 data-number="1.9.1" id="topic-format-2"><span
class="header-section-number">1.9.1</span> Topic Format</h3>
<pre><code>kingkiosk/{device_id}/element/{element_id}/event</code></pre>
<h3 data-number="1.9.2" id="event-types"><span
class="header-section-number">1.9.2</span> Event Types</h3>
<table>
<thead>
<tr>
<th>Event</th>
<th>Description</th>
<th>Additional Fields</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>created</code></td>
<td>Widget was created</td>
<td><code>type</code></td>
</tr>
<tr>
<td><code>closed</code></td>
<td>Widget was closed</td>
<td><code>type</code></td>
</tr>
<tr>
<td><code>error</code></td>
<td>Error occurred</td>
<td><code>message</code>, <code>code</code> (optional)</td>
</tr>
<tr>
<td><code>state_changed</code></td>
<td>State transition</td>
<td><code>from</code>, <code>to</code></td>
</tr>
<tr>
<td><code>clicked</code></td>
<td>User interaction</td>
<td><code>x</code>, <code>y</code> (optional)</td>
</tr>
<tr>
<td><code>ended</code></td>
<td>Playback ended</td>
<td>-</td>
</tr>
</tbody>
</table>
<h3 data-number="1.9.3" id="event-payload-example"><span
class="header-section-number">1.9.3</span> Event Payload Example</h3>
<div class="sourceCode" id="cb22"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;event&quot;</span><span class="fu">:</span> <span class="st">&quot;error&quot;</span><span class="fu">,</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;message&quot;</span><span class="fu">:</span> <span class="st">&quot;Stream disconnected&quot;</span><span class="fu">,</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;code&quot;</span><span class="fu">:</span> <span class="st">&quot;STREAM_TIMEOUT&quot;</span><span class="fu">,</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;element_id&quot;</span><span class="fu">:</span> <span class="st">&quot;video-1&quot;</span><span class="fu">,</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;widget_id&quot;</span><span class="fu">:</span> <span class="st">&quot;video-1&quot;</span><span class="fu">,</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;2024-12-19T10:30:00.000Z&quot;</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<hr />
<h2 data-number="1.10" id="system-commands"><span
class="header-section-number">1.10</span> System Commands</h2>
<p>System-level commands control the device as a whole.</p>
<h3 data-number="1.10.1" id="topic-format-3"><span
class="header-section-number">1.10.1</span> Topic Format</h3>
<pre><code>kingkiosk/{device_id}/system/cmd</code></pre>
<h3 data-number="1.10.2" id="supported-system-commands"><span
class="header-section-number">1.10.2</span> Supported System
Commands</h3>
<p>System commands sent to <code>kingkiosk/{device_id}/system/cmd</code>
are routed through the unified command dispatcher.</p>
<p>This section lists the <strong>actual</strong> system command strings
that are wired up in the current dispatcher. Detailed parameters for the
non-window system commands are documented in the code-derived section <a
href="#system-non-window-commands">System (Non-Window) Commands</a>.</p>
<p>Common notes:</p>
<ul>
<li>Many handlers support <code>response_topic</code> to control where
results are published.</li>
<li>Unless noted otherwise, <code>response_topic</code> defaults to
<code>kingkiosk/{device_id}/system/response</code>.</li>
<li><strong>Widget creation commands</strong> can include
<code>os_widget: true</code> to also register the widget as a native OS
widget (home screen widget on Android, home/lock screen widget on iOS).
See <a href="#native-os-widgets">Native OS Widgets</a> section for
details.</li>
</ul>
<p>Core system command families:</p>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th>Category</th>
<th>Commands</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Volume</strong></td>
<td><code>set_volume</code>, <code>mute</code>, <code>unmute</code></td>
</tr>
<tr>
<td><strong>Brightness</strong></td>
<td><code>set_brightness</code>, <code>get_brightness</code>,
<code>restore_brightness</code>,
<code>request_brightness_permission</code>,
<code>check_brightness_permission</code>,
<code>resume_kiosk_after_permission</code></td>
</tr>
<tr>
<td><strong>Notifications</strong></td>
<td><code>alert</code>, <code>notify</code></td>
</tr>
<tr>
<td><strong>Halo</strong></td>
<td><code>halo_effect</code></td>
</tr>
<tr>
<td><strong>Screensaver</strong></td>
<td><code>screensaver</code>, <code>screen_saver</code></td>
</tr>
<tr>
<td><strong>Settings / FAB lock</strong></td>
<td><code>lock_fab</code>, <code>unlock_fab</code>,
<code>lock_settings</code>, <code>unlock_settings</code></td>
</tr>
<tr>
<td><strong>Person detection</strong></td>
<td><code>person_detection</code></td>
</tr>
<tr>
<td><strong>Screenshot</strong></td>
<td><code>screenshot</code></td>
</tr>
<tr>
<td><strong>Cache</strong></td>
<td><code>cache</code>, <code>cache_control</code>,
<code>clear_cache</code></td>
</tr>
<tr>
<td><strong>TTS</strong></td>
<td><code>tts</code>, <code>speak</code>, <code>say</code></td>
</tr>
<tr>
<td><strong>STT</strong></td>
<td><code>stt</code>, <code>speech_to_text</code>,
<code>listen</code></td>
</tr>
<tr>
<td><strong>Background</strong></td>
<td><code>set_background</code>, <code>get_background</code></td>
</tr>
<tr>
<td><strong>Provisioning</strong></td>
<td><code>provision</code>, <code>get_config</code></td>
</tr>
<tr>
<td><strong>AI</strong></td>
<td><code>ai_agent</code>, <code>ai</code>,
<code>provision_ai_chatbot</code>, <code>setup_ai_chatbot</code>,
<code>configure_ai_chatbot</code></td>
</tr>
<tr>
<td><strong>Batch / scripting</strong></td>
<td><code>batch</code>, <code>kill_batch_script</code>,
<code>batch_status</code>, <code>wait</code></td>
</tr>
<tr>
<td><strong>Screen schedule</strong></td>
<td><code>set_screen_schedule</code>, <code>list_screen_schedule</code>,
<code>enable_screen_schedule</code>,
<code>disable_screen_schedule</code>,
<code>screen_schedule_status</code>,
<code>trigger_screen_schedule</code></td>
</tr>
<tr>
<td><strong>Conflict resolution</strong></td>
<td><code>conflict_resolution</code></td>
</tr>
<tr>
<td><strong>MQTT button</strong></td>
<td><code>mqtt_button</code>, <code>mqtt_action_status</code>,
<code>action_status</code></td>
</tr>
</tbody>
</table>
<h3 data-number="1.10.3"
id="example-create-a-clock-via-system-command"><span
class="header-section-number">1.10.3</span> Example: Create a clock via
system command</h3>
<p><strong>Topic:</strong>
<code>kingkiosk/my-device/system/cmd</code></p>
<p><strong>Payload:</strong></p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;open_clock&quot;</span><span class="fu">,</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;window_id&quot;</span><span class="fu">:</span> <span class="st">&quot;clock-living-room&quot;</span><span class="fu">,</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;Living Room Clock&quot;</span><span class="fu">,</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;mode&quot;</span><span class="fu">:</span> <span class="st">&quot;analog&quot;</span><span class="fu">,</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;show_numbers&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;theme&quot;</span><span class="fu">:</span> <span class="st">&quot;dark&quot;</span><span class="fu">,</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;x&quot;</span><span class="fu">:</span> <span class="dv">100</span><span class="fu">,</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;y&quot;</span><span class="fu">:</span> <span class="dv">100</span><span class="fu">,</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;width&quot;</span><span class="fu">:</span> <span class="dv">300</span><span class="fu">,</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;height&quot;</span><span class="fu">:</span> <span class="dv">300</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<hr />
<h2 data-number="1.11" id="device-info"><span
class="header-section-number">1.11</span> Device Info</h2>
<p>The device info topic provides discovery information about the
device’s capabilities and current state.</p>
<h3 data-number="1.11.1" id="topic-format-4"><span
class="header-section-number">1.11.1</span> Topic Format</h3>
<pre><code>kingkiosk/{device_id}/info</code></pre>
<h3 data-number="1.11.2" id="info-payload"><span
class="header-section-number">1.11.2</span> Info Payload</h3>
<div class="sourceCode" id="cb26"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;device_id&quot;</span><span class="fu">:</span> <span class="st">&quot;my-device&quot;</span><span class="fu">,</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="st">&quot;2.1.0&quot;</span><span class="fu">,</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;platform&quot;</span><span class="fu">:</span> <span class="st">&quot;macos&quot;</span><span class="fu">,</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;app_start_timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;2024-12-19T10:00:00.000Z&quot;</span><span class="fu">,</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;capabilities&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;webview&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;video&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;rtsp&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;webrtc&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;audio&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;visualizer&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;tts&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;stt&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;camera&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;microphone&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;facial_recognition&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;person_detection&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;dlna_renderer&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;screen_share&quot;</span><span class="fu">:</span> <span class="kw">true</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;widget_types&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;webview&quot;</span><span class="ot">,</span> <span class="st">&quot;video&quot;</span><span class="ot">,</span> <span class="st">&quot;audio&quot;</span><span class="ot">,</span> <span class="st">&quot;rtsp&quot;</span><span class="ot">,</span> <span class="st">&quot;webrtc&quot;</span><span class="ot">,</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;image&quot;</span><span class="ot">,</span> <span class="st">&quot;mqtt_image&quot;</span><span class="ot">,</span> <span class="st">&quot;map&quot;</span><span class="ot">,</span> <span class="st">&quot;visualizer&quot;</span><span class="ot">,</span> <span class="st">&quot;gauge&quot;</span><span class="ot">,</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;line_chart&quot;</span><span class="ot">,</span> <span class="st">&quot;bar_chart&quot;</span><span class="ot">,</span> <span class="st">&quot;pie_chart&quot;</span><span class="ot">,</span> <span class="st">&quot;carousel&quot;</span><span class="ot">,</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;clock&quot;</span><span class="ot">,</span> <span class="st">&quot;weather&quot;</span><span class="ot">,</span> <span class="st">&quot;calendar&quot;</span><span class="ot">,</span> <span class="st">&quot;alarmo&quot;</span><span class="ot">,</span></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;mqtt_button&quot;</span><span class="ot">,</span> <span class="st">&quot;timer&quot;</span><span class="ot">,</span> <span class="st">&quot;dlna_player&quot;</span><span class="ot">,</span> <span class="st">&quot;video_call&quot;</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;active_widgets&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;clock-1&quot;</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;widget_count&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;tiling_mode&quot;</span><span class="fu">:</span> <span class="st">&quot;floating&quot;</span><span class="fu">,</span></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;hmac_signing&quot;</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span></span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;2024-12-19T10:30:00.000Z&quot;</span></span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Notes: - <code>tiling_mode</code> is currently a placeholder value in
the info payload. - <code>active_widgets</code> includes only widgets
that have registered with the per-widget router. -
<code>timestamp</code> is the time this info payload was published (it
may be refreshed during the app run). - <code>app_start_timestamp</code>
stays constant for the lifetime of the running app process.</p>
<hr />
<h2 data-number="1.12" id="signed-envelope-format"><span
class="header-section-number">1.12</span> Signed Envelope Format</h2>
<p>For secure command delivery, commands can be wrapped in a signed
envelope using HMAC-SHA256.</p>
<h3 data-number="1.12.1" id="envelope-format"><span
class="header-section-number">1.12.1</span> Envelope Format</h3>
<div class="sourceCode" id="cb27"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;ts&quot;</span><span class="fu">:</span> <span class="dv">1703001234</span><span class="fu">,</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;msg&quot;</span><span class="fu">:</span> <span class="st">&quot;{</span><span class="ch">\&quot;</span><span class="st">command</span><span class="ch">\&quot;</span><span class="st">:</span><span class="ch">\&quot;</span><span class="st">play</span><span class="ch">\&quot;</span><span class="st">}&quot;</span><span class="fu">,</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;sig&quot;</span><span class="fu">:</span> <span class="st">&quot;a1b2c3d4e5f6...&quot;</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h3 data-number="1.12.2" id="signature-computation"><span
class="header-section-number">1.12.2</span> Signature Computation</h3>
<pre><code>sig = hex(HMAC-SHA256(secret, &quot;topic\ntimestamp\nmsg&quot;))</code></pre>
<p>Where: - <code>topic</code> = the full MQTT topic the message is
published to - <code>timestamp</code> = the <code>ts</code> value (Unix
seconds) as a string - <code>msg</code> = the JSON-encoded message
string</p>
<p>Important: - Signed envelopes are <strong>topic-aware</strong>: the
signature depends on the full MQTT topic the message is published to. -
If <code>useSignedEnvelopes</code> is enabled <strong>and</strong> a
shared secret is configured, the app <strong>enforces
verification</strong> for inbound signed envelopes. - Invalid signatures
or invalid/expired timestamps are rejected (the command is ignored). -
If signing is disabled or no secret is configured, the app will still
unwrap the envelope for compatibility. - The envelope timestamp used by
the implementation is <strong>Unix seconds</strong>.</p>
<h3 data-number="1.12.3" id="example-python"><span
class="header-section-number">1.12.3</span> Example (Python)</h3>
<div class="sourceCode" id="cb29"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> hmac</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> hashlib</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_signed_envelope(topic, message, secret):</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  ts <span class="op">=</span> <span class="bu">int</span>(time.time())</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  msg <span class="op">=</span> json.dumps(message, separators<span class="op">=</span>(<span class="st">&#39;,&#39;</span>, <span class="st">&#39;:&#39;</span>))</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  sig_data <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>topic<span class="sc">}</span><span class="ch">\n</span><span class="sc">{</span>ts<span class="sc">}</span><span class="ch">\n</span><span class="sc">{</span>msg<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  sig <span class="op">=</span> hmac.new(</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    secret.encode(),</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    sig_data.encode(),</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    hashlib.sha256</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>  ).hexdigest()</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> {</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;ts&quot;</span>: ts,</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;msg&quot;</span>: msg,</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;sig&quot;</span>: sig</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<hr />
<h2 data-number="1.13" id="widget-type-reference"><span
class="header-section-number">1.13</span> Widget Type Reference</h2>
<p>This section is <strong>code-derived</strong>: it documents the JSON
keys that are actually parsed/used by the current implementation.</p>
<p>There are three relevant command planes:</p>
<ol type="1">
<li><strong>System commands</strong>: publish to
<code>kingkiosk/{device_id}/system/cmd</code>. These create
windows/tiles and perform global actions.</li>
<li><strong>Element-scoped commands</strong>: publish to
<code>kingkiosk/{device_id}/element/{element_id}/cmd</code>. Only
controllers that register with the element router receive these.</li>
</ol>
<h3 data-number="1.13.1" id="common-window-geometry-keys"><span
class="header-section-number">1.13.1</span> Common Window Geometry
Keys</h3>
<p>Most “create/open” commands accept the following top-level keys:</p>
<table>
<colgroup>
<col style="width: 27%" />
<col style="width: 33%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td>Optional. If omitted, an ID may be auto-generated by the tile
creator.</td>
</tr>
<tr>
<td><code>title</code> / <code>name</code></td>
<td>string</td>
<td>Widget title/name (varies by command).</td>
</tr>
<tr>
<td><code>x</code>, <code>y</code></td>
<td>number</td>
<td>Optional position in pixels.</td>
</tr>
<tr>
<td><code>width</code>, <code>height</code></td>
<td>number</td>
<td>Optional size in pixels.</td>
</tr>
<tr>
<td><code>opacity</code></td>
<td>number</td>
<td>Optional. Defaults to <code>1.0</code>.</td>
</tr>
</tbody>
</table>
<p>Many commands also accept:</p>
<table>
<colgroup>
<col style="width: 27%" />
<col style="width: 33%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td>Optional. If omitted, the app defaults to
<code>kingkiosk/{device_id}/system/response</code> for system commands,
or <code>kingkiosk/{device_id}/element/{element_id}/response</code> for
element commands.</td>
</tr>
</tbody>
</table>
<hr />
<h3 data-number="1.13.2" id="system-windowlayout-commands"><span
class="header-section-number">1.13.2</span> System (Window/Layout)
Commands</h3>
<p>These are <strong>system-level</strong> window/layout commands
handled by the main dispatcher. Send them on
<code>kingkiosk/{device_id}/system/cmd</code>.</p>
<p>Unless explicitly stated, these commands use the payload key
<code>command</code> to select the handler.</p>
<h4 data-number="1.13.2.1"
id="window-management-close_window-maximize_window-minimize_window-bring_to_front-send_to_back"><span
class="header-section-number">1.13.2.1</span> Window Management
(<code>close_window</code>, <code>maximize_window</code>,
<code>minimize_window</code>, <code>bring_to_front</code>,
<code>send_to_back</code>)</h4>
<p>Accepted <code>command</code> strings:</p>
<ul>
<li>Close: <code>close_window</code></li>
<li>Maximize: <code>maximize_window</code></li>
<li>Minimize: <code>minimize_window</code></li>
<li>Bring to front: <code>bring_to_front</code> (aliases:
<code>bring_front</code>, <code>to_front</code>)</li>
<li>Send to back: <code>send_to_back</code> (aliases:
<code>send_back</code>, <code>to_back</code>)</li>
</ul>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td>One of the management commands above.</td>
</tr>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td>(required)</td>
<td>ID of the tile/window to act on.</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td><code>kingkiosk/{device}/system/response</code></td>
<td>Publishes <code>{success, command, window_id, timestamp}</code> or
<code>{success:false, error, ...}</code>.</td>
</tr>
</tbody>
</table>
<hr />
<h4 data-number="1.13.2.2"
id="close-all-windows-close_all_windows"><span
class="header-section-number">1.13.2.2</span> Close All Windows
(<code>close_all_windows</code>)</h4>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td>Must be <code>close_all_windows</code>.</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td><code>kingkiosk/{device}/system/response</code></td>
<td>Publishes <code>{success:true, closed_count, ...}</code>.</td>
</tr>
</tbody>
</table>
<p>Notes:</p>
<ul>
<li>After closing tiles, it attempts to stop background audio
(best-effort; errors are logged but do not fail the command).</li>
</ul>
<hr />
<h4 data-number="1.13.2.3"
id="window-mode-window_mode-set_window_mode"><span
class="header-section-number">1.13.2.3</span> Window Mode
(<code>window_mode</code>, <code>set_window_mode</code>)</h4>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td><code>window_mode</code> or <code>set_window_mode</code>.</td>
</tr>
<tr>
<td><code>mode</code></td>
<td>string</td>
<td>(required)</td>
<td><code>tiling</code>/<code>tile</code>,
<code>floating</code>/<code>float</code>, or <code>toggle</code>.</td>
</tr>
</tbody>
</table>
<p>Notes:</p>
<ul>
<li>This handler currently logs only (no success/error payload is
published).</li>
</ul>
<hr />
<h4 data-number="1.13.2.4"
id="update-window-geometry-update_window-move_window-resize_window"><span
class="header-section-number">1.13.2.4</span> Update Window Geometry
(<code>update_window</code>, <code>move_window</code>,
<code>resize_window</code>)</h4>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td><code>update_window</code>, <code>move_window</code>, or
<code>resize_window</code> (all route to the same handler).</td>
</tr>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td>(required)</td>
<td>Target tile/window ID.</td>
</tr>
<tr>
<td><code>x</code>, <code>y</code></td>
<td>number</td>
<td>-</td>
<td>If both present, updates position.</td>
</tr>
<tr>
<td><code>width</code>, <code>height</code></td>
<td>number</td>
<td>-</td>
<td>If both present, updates size.</td>
</tr>
</tbody>
</table>
<p>Notes:</p>
<ul>
<li>If neither a complete <code>(x,y)</code> pair nor a complete
<code>(width,height)</code> pair is provided, the command is ignored
(logged as missing parameters).</li>
<li>Values for <code>x</code>, <code>y</code>, <code>width</code>, and
<code>height</code> are interpreted as <strong>physical pixels</strong>
and are internally converted to logical pixels by dividing by the device
pixel ratio.</li>
<li>This handler currently logs only (no success/error payload is
published).</li>
</ul>
<hr />
<h4 data-number="1.13.2.5"
id="widget-convenience-show_widget-hide_widget"><span
class="header-section-number">1.13.2.5</span> Widget Convenience
(<code>show_widget</code>, <code>hide_widget</code>)</h4>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td><code>show_widget</code> or <code>hide_widget</code>.</td>
</tr>
<tr>
<td><code>type</code></td>
<td>string</td>
<td>(required)</td>
<td>For <code>show_widget</code>: <code>clock</code>,
<code>weather</code>, <code>calendar</code>, <code>music</code>,
<code>photos</code>, <code>finance</code>, <code>fitness</code>,
<code>news</code> (others are ignored). For <code>hide_widget</code>:
use <code>all</code> to close all tiles, or any string to match by tile
name.</td>
</tr>
<tr>
<td><code>style</code></td>
<td>string</td>
<td>-</td>
<td>Only applied for <code>clock</code>/<code>weather</code> (stored in
the created tile config).</td>
</tr>
<tr>
<td><code>ai_enhanced</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>Only applied for <code>clock</code>/<code>weather</code> (stored in
config).</td>
</tr>
</tbody>
</table>
<p>Notes:</p>
<ul>
<li>These commands currently log only (no success/error payload is
published).</li>
<li><code>hide_widget</code> closes the most recently created tile whose
name contains <code>type</code> (case-insensitive), unless
<code>type == all</code>.</li>
</ul>
<hr />
<h4 data-number="1.13.2.6"
id="dlna-player-dlna_player-open_dlna_player"><span
class="header-section-number">1.13.2.6</span> DLNA Player
(<code>dlna_player</code>, <code>open_dlna_player</code>)</h4>
<p>This widget reflects and controls the built-in DLNA/UPnP renderer. It
now supports audio, video, and images (and will classify content based
on DIDL-Lite metadata and/or URI).</p>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td><code>dlna_player</code> or alias
<code>open_dlna_player</code>.</td>
</tr>
<tr>
<td><code>name</code></td>
<td>string</td>
<td><code>DLNA Player</code></td>
<td>Tile title.</td>
</tr>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td>(auto)</td>
<td>If provided, used as tile ID.</td>
</tr>
<tr>
<td><code>opacity</code>, <code>x</code>, <code>y</code>,
<code>width</code>, <code>height</code></td>
<td>number</td>
<td>-</td>
<td>Optional geometry.</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td><code>kingkiosk/{device}/system/response</code></td>
<td>Publishes
<code>{success, command:'dlna_player', window_id, name, timestamp}</code>
or error payload.</td>
</tr>
</tbody>
</table>
<p>Note:</p>
<ul>
<li>When <code>window_id</code> is omitted, the handler publishes a
generated ID in the response (<code>dlna_{timestamp}</code>), which may
not match the actual auto-generated tile ID used by the controller.</li>
</ul>
<h4 data-number="1.13.2.7"
id="remote-browser-create_remote_browser-add_remote_browser"><span
class="header-section-number">1.13.2.7</span> Remote Browser
(<code>create_remote_browser</code>,
<code>add_remote_browser</code>)</h4>
<p>This widget provides a thin-client browser experience by streaming a
server-rendered Chromium browser over WebRTC through the Feature Server.
Designed primarily for tvOS (Apple TV) and iOS devices where local
browser rendering is limited.</p>
<p><strong>Architecture:</strong> - Server runs a Browser Producer Agent
(BPA) with Chromium + Puppeteer - Media is routed through the Feature
Server SFU pipeline (H.264 video + Opus audio) - Client connects to the
Feature Server/Core (SignalingService) via WebSocket - Control input
(pointer, keyboard, navigation) is sent via DataChannel (SCTP) -
Telemetry (URL changes, load state, stats) is received via DataChannel -
Sessions can be created client-side (when <code>session_id</code> is
omitted) or joined (when <code>session_id</code> + join token are
provided)</p>
<p><strong>Prerequisites:</strong> - Feature Server must be enabled and
connected in Settings &gt; Networked Audio - The Feature Server/Core
WebSocket must be reachable (typically
<code>ws://&lt;host&gt;:4000/ws</code>) - To <strong>join an existing
session</strong>, <code>server_url</code> must include
<code>?token=&lt;consumerJoinToken&gt;</code> (required for
<code>transport.*</code>, <code>consume</code>,
<code>dataproducer.*</code>, etc.) - If <code>session_id</code> is
<strong>omitted</strong>, the client will call
<code>session.create</code>, receive a join token, reconnect with
<code>?token=...</code>, and then publish the resolved
<code>session_id</code> + tokenized <code>server_url</code> in widget
state - Newly created sessions can stay in <code>CREATING</code> briefly
while BPA/Chromium starts; clients will retry <code>session.join</code>
until the session becomes <code>READY</code>/<code>RUNNING</code> (or
time out)</p>
<p>Top-level keys for <code>create_remote_browser</code> /
<code>add_remote_browser</code>:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td><code>create_remote_browser</code> or
<code>add_remote_browser</code>.</td>
</tr>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td>(required)</td>
<td>Unique ID for this browser tile.</td>
</tr>
<tr>
<td><code>name</code></td>
<td>string</td>
<td><code>Remote Browser</code></td>
<td>Tile title.</td>
</tr>
<tr>
<td><code>server_url</code></td>
<td>string</td>
<td>(Settings)</td>
<td>Feature Server/Core WebSocket URL
(e.g. <code>ws://192.168.0.114:4000/ws</code>). If
<code>session_id</code> is provided, must include
<code>?token=...</code>.</td>
</tr>
<tr>
<td><code>initial_url</code></td>
<td>string</td>
<td><code>about:blank</code></td>
<td>URL to load when session starts.</td>
</tr>
<tr>
<td><code>session_id</code></td>
<td>string</td>
<td>(optional)</td>
<td>If provided, joins this session (requires <code>server_url</code>
with <code>?token=...</code>). If omitted, creates a new session.</td>
</tr>
<tr>
<td><code>video_profile</code></td>
<td>string</td>
<td><code>auto</code></td>
<td>Video quality profile: <code>auto</code>, <code>720p30</code>,
<code>1080p30</code>, <code>1080p60</code>.</td>
</tr>
<tr>
<td><code>auto_connect</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>Whether to automatically connect when the tile is created.</td>
</tr>
<tr>
<td><code>show_overlay</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>Show URL bar and stats overlay.</td>
</tr>
<tr>
<td><code>show_cursor</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>Show cursor position indicator.</td>
</tr>
<tr>
<td><code>x</code>, <code>y</code></td>
<td>number</td>
<td>-</td>
<td>Optional position (fractional 0-1 or pixels).</td>
</tr>
<tr>
<td><code>width</code>, <code>height</code></td>
<td>number</td>
<td>-</td>
<td>Optional size (fractional 0-1 or pixels).</td>
</tr>
<tr>
<td><code>dark_mode</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>Enable dark mode for the browser session.</td>
</tr>
<tr>
<td><code>opacity</code></td>
<td>number</td>
<td><code>1.0</code></td>
<td>Tile opacity.</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td><code>kingkiosk/{device}/system/response</code></td>
<td>Response destination.</td>
</tr>
</tbody>
</table>
<p><strong>Remote Browser Control Commands:</strong></p>
<table>
<colgroup>
<col style="width: 24%" />
<col style="width: 35%" />
<col style="width: 40%" />
</colgroup>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
<th>Required Keys</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>connect_remote_browser</code></td>
<td>Connect (creates session if needed)</td>
<td><code>window_id</code></td>
</tr>
<tr>
<td><code>disconnect_remote_browser</code></td>
<td>Disconnect from the session</td>
<td><code>window_id</code></td>
</tr>
<tr>
<td><code>configure_remote_browser</code></td>
<td>Update configuration</td>
<td><code>window_id</code>, optional: <code>server_url</code>,
<code>initial_url</code>, <code>session_id</code>,
<code>video_profile</code>, <code>dark_mode</code></td>
</tr>
<tr>
<td><code>navigate_remote_browser</code></td>
<td>Navigate to URL</td>
<td><code>window_id</code>, <code>url</code> (http/https only)</td>
</tr>
<tr>
<td><code>remote_browser_back</code></td>
<td>Go back in history</td>
<td><code>window_id</code></td>
</tr>
<tr>
<td><code>remote_browser_forward</code></td>
<td>Go forward in history</td>
<td><code>window_id</code></td>
</tr>
<tr>
<td><code>remote_browser_reload</code></td>
<td>Reload current page</td>
<td><code>window_id</code></td>
</tr>
<tr>
<td><code>remote_browser_click</code></td>
<td>Simulate mouse click (at current pointer position;
<code>x</code>/<code>y</code> are accepted for compatibility)</td>
<td><code>window_id</code>, optional: <code>x</code>, <code>y</code>,
<code>button</code>
(<code>left</code>/<code>right</code>/<code>middle</code>)</td>
</tr>
<tr>
<td><code>remote_browser_scroll</code></td>
<td>Scroll the page</td>
<td><code>window_id</code>, <code>delta_x</code>,
<code>delta_y</code></td>
</tr>
<tr>
<td><code>remote_browser_key</code></td>
<td>Send key press</td>
<td><code>window_id</code>, <code>key</code> (DOM code), optional:
<code>modifiers</code> (accepted for compatibility)</td>
</tr>
<tr>
<td><code>remote_browser_text</code></td>
<td>Input text directly</td>
<td><code>window_id</code>, <code>text</code> (max 10,000 chars)</td>
</tr>
<tr>
<td><code>remote_browser_clear_data</code></td>
<td>Clear cookies/localStorage and restart session</td>
<td><code>window_id</code></td>
</tr>
<tr>
<td><code>delete_remote_browser</code></td>
<td>Remove the tile</td>
<td><code>window_id</code></td>
</tr>
<tr>
<td><code>remove_remote_browser</code></td>
<td>Alias for <code>delete_remote_browser</code></td>
<td><code>window_id</code></td>
</tr>
<tr>
<td><code>list_remote_browsers</code></td>
<td>List all remote browser tiles</td>
<td>(none)</td>
</tr>
<tr>
<td><code>remote_browser_status</code> /
<code>get_remote_browser_status</code></td>
<td>Debug/status snapshot (tracks, consumers, session)</td>
<td>optional: <code>window_id</code></td>
</tr>
</tbody>
</table>
<p><strong>Browser Persistence:</strong> - Browser state (cookies,
localStorage, IndexedDB) persists automatically across sessions - Each
tile has an isolated persistence profile (different tiles don’t share
cookies) - Use <code>remote_browser_clear_data</code> to clear all
persisted data (useful for “logout” functionality)</p>
<p><strong>Security Notes:</strong> - URL navigation is restricted to
<code>http://</code> and <code>https://</code> schemes only
(<code>javascript:</code>, <code>file:</code>, <code>data:</code>
blocked) - Text input is limited to 10,000 characters to prevent abuse -
Pointer coordinates are clamped to prevent overflow (-100 to 4096)</p>
<p><strong>Example - Create Remote Browser:</strong></p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;create_remote_browser&quot;</span><span class="fu">,</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;window_id&quot;</span><span class="fu">:</span> <span class="st">&quot;browser_1&quot;</span><span class="fu">,</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;Web Browser&quot;</span><span class="fu">,</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;server_url&quot;</span><span class="fu">:</span> <span class="st">&quot;ws://192.168.0.114:4000/ws&quot;</span><span class="fu">,</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;initial_url&quot;</span><span class="fu">:</span> <span class="st">&quot;https://www.google.com&quot;</span><span class="fu">,</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;video_profile&quot;</span><span class="fu">:</span> <span class="st">&quot;720p30&quot;</span><span class="fu">,</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;auto_connect&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;show_overlay&quot;</span><span class="fu">:</span> <span class="kw">true</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>Example - Navigate to URL:</strong></p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;navigate_remote_browser&quot;</span><span class="fu">,</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;window_id&quot;</span><span class="fu">:</span> <span class="st">&quot;browser_1&quot;</span><span class="fu">,</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;url&quot;</span><span class="fu">:</span> <span class="st">&quot;https://www.example.com&quot;</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>Example - Send Key Press:</strong></p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;remote_browser_key&quot;</span><span class="fu">,</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;window_id&quot;</span><span class="fu">:</span> <span class="st">&quot;browser_1&quot;</span><span class="fu">,</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;Enter&quot;</span><span class="fu">,</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;modifiers&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;ctrl&quot;</span><span class="ot">]</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>Example - Configure with Session ID:</strong></p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;configure_remote_browser&quot;</span><span class="fu">,</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;window_id&quot;</span><span class="fu">:</span> <span class="st">&quot;browser_1&quot;</span><span class="fu">,</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;session_id&quot;</span><span class="fu">:</span> <span class="st">&quot;new_session_xyz&quot;</span><span class="fu">,</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;video_profile&quot;</span><span class="fu">:</span> <span class="st">&quot;1080p30&quot;</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>Example - Clear Browser Data (Logout/Reset):</strong></p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;remote_browser_clear_data&quot;</span><span class="fu">,</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;window_id&quot;</span><span class="fu">:</span> <span class="st">&quot;browser_1&quot;</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>This clears all cookies, localStorage, and other persisted browser
state, then restarts the session. Useful for implementing “logout”
functionality when using web apps that store auth tokens in
cookies/localStorage.</p>
<p><strong>Element-Level Commands (via
<code>kingkiosk/{device_id}/element/{window_id}/cmd</code>):</strong></p>
<p>The remote browser controller also supports element-scoped
commands:</p>
<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 36%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
<th>Payload Keys</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>configure</code></td>
<td>Configure the browser</td>
<td>optional: <code>server_url</code>, <code>initial_url</code>,
<code>session_id</code>, <code>video_profile</code>,
<code>dark_mode</code></td>
</tr>
<tr>
<td><code>connect</code></td>
<td>Connect (creates session if needed)</td>
<td>(none)</td>
</tr>
<tr>
<td><code>disconnect</code></td>
<td>Disconnect from session</td>
<td>(none)</td>
</tr>
<tr>
<td><code>navigate</code> / <code>goto</code></td>
<td>Navigate to URL</td>
<td><code>url</code> (http/https only)</td>
</tr>
<tr>
<td><code>back</code></td>
<td>Go back</td>
<td>(none)</td>
</tr>
<tr>
<td><code>forward</code></td>
<td>Go forward</td>
<td>(none)</td>
</tr>
<tr>
<td><code>reload</code></td>
<td>Reload page</td>
<td>(none)</td>
</tr>
<tr>
<td><code>click</code></td>
<td>Simulate click at current pointer position</td>
<td><code>button</code> (optional, default <code>left</code>)</td>
</tr>
<tr>
<td><code>scroll</code></td>
<td>Scroll page</td>
<td><code>dx</code>, <code>dy</code></td>
</tr>
<tr>
<td><code>key</code></td>
<td>Send key</td>
<td><code>code</code> (DOM KeyboardEvent.code)</td>
</tr>
<tr>
<td><code>text</code></td>
<td>Input text</td>
<td><code>text</code> (max 10,000 chars)</td>
</tr>
<tr>
<td><code>widget_command</code></td>
<td>Forward a command to a widget inside the remote browser (Custom
Widget Bridge)</td>
<td><code>widget_command</code> (string), optional: <code>payload</code>
(object)</td>
</tr>
</tbody>
</table>
<p><code>widget_command</code> also supports nested payload shape:
<code>{"command":"widget_command","payload":{"command":"foo","payload":{...}}}</code>.</p>
<p><strong>State Published (on
<code>kingkiosk/{device_id}/element/{window_id}/state</code>):</strong></p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;remoteBrowser&quot;</span><span class="fu">,</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;widget_id&quot;</span><span class="fu">:</span> <span class="st">&quot;browser_1&quot;</span><span class="fu">,</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;server_url&quot;</span><span class="fu">:</span> <span class="st">&quot;ws://192.168.0.114:4000/ws?token=REDACTED&quot;</span><span class="fu">,</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;session_id&quot;</span><span class="fu">:</span> <span class="st">&quot;abc123&quot;</span><span class="fu">,</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;video_profile&quot;</span><span class="fu">:</span> <span class="st">&quot;720p30&quot;</span><span class="fu">,</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;dark_mode&quot;</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;connected&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;consuming&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;has_control&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;current_url&quot;</span><span class="fu">:</span> <span class="st">&quot;https://www.google.com&quot;</span><span class="fu">,</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;load_state&quot;</span><span class="fu">:</span> <span class="st">&quot;complete&quot;</span><span class="fu">,</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;stats&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;rtt_ms&quot;</span><span class="fu">:</span> <span class="dv">25</span><span class="fu">,</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;fps&quot;</span><span class="fu">:</span> <span class="dv">30</span><span class="fu">,</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;bitrate_kbps&quot;</span><span class="fu">:</span> <span class="dv">2500</span><span class="fu">,</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;loss_pct&quot;</span><span class="fu">:</span> <span class="fl">0.1</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;error&quot;</span><span class="fu">:</span> <span class="kw">null</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>Input Mapping (tvOS/Apple TV Remote):</strong></p>
<table>
<thead>
<tr>
<th>Input</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td>D-pad</td>
<td>Move pointer (with acceleration)</td>
</tr>
<tr>
<td>Select/Enter</td>
<td>Click at current pointer position</td>
</tr>
<tr>
<td>Menu/Escape</td>
<td>Navigate back</td>
</tr>
<tr>
<td>Play/Pause</td>
<td>Send Space key</td>
</tr>
<tr>
<td>Touch swipe</td>
<td>Scroll</td>
</tr>
<tr>
<td>Long press</td>
<td>Right-click (context menu)</td>
</tr>
</tbody>
</table>
<hr />
<h3 data-number="1.13.3" id="system-non-window-commands"><span
class="header-section-number">1.13.3</span> System (Non-Window)
Commands</h3>
<p>This section documents <strong>system-level commands that are not
tied to a specific window type</strong>. These are sent on
<code>kingkiosk/{device_id}/system/cmd</code>.</p>
<p>Unless explicitly stated, these commands use the payload key
<code>command</code> to select the handler.</p>
<h4 data-number="1.13.3.1" id="volume-set_volume-mute-unmute"><span
class="header-section-number">1.13.3.1</span> Volume
(<code>set_volume</code>, <code>mute</code>, <code>unmute</code>)</h4>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td><code>set_volume</code>, <code>mute</code>,
<code>unmute</code>.</td>
</tr>
<tr>
<td><code>value</code></td>
<td>number/string</td>
<td>-</td>
<td>Only used by <code>set_volume</code>. Parsed as double in range
<code>[0.0, 1.0]</code>.</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td><code>kingkiosk/{device}/system/response</code></td>
<td>Response is always published.</td>
</tr>
</tbody>
</table>
<p>Response payloads:</p>
<ul>
<li><code>set_volume</code>:
<code>{success, command:'set_volume', volume, timestamp}</code></li>
<li><code>mute</code>/<code>unmute</code>:
<code>{success, command:'mute'|'unmute', timestamp}</code></li>
</ul>
<hr />
<h4 data-number="1.13.3.2"
id="brightness-set_brightness-get_brightness-restore_brightness-request_brightness_permission-check_brightness_permission-resume_kiosk_after_permission"><span
class="header-section-number">1.13.3.2</span> Brightness
(<code>set_brightness</code>, <code>get_brightness</code>,
<code>restore_brightness</code>,
<code>request_brightness_permission</code>,
<code>check_brightness_permission</code>,
<code>resume_kiosk_after_permission</code>)</h4>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td>One of the brightness commands above.</td>
</tr>
<tr>
<td><code>value</code></td>
<td>number/string</td>
<td>-</td>
<td>Used by <code>set_brightness</code>. Parsed as double in range
<code>[0.0, 1.0]</code>.</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td><code>kingkiosk/{device}/system/response</code></td>
<td>Used by most brightness actions.</td>
</tr>
</tbody>
</table>
<p>Notes:</p>
<ul>
<li>Brightness is implemented as <strong>application brightness</strong>
(not global/system brightness).</li>
<li><code>get_brightness</code> publishes to <code>response_topic</code>
<strong>only when <code>response_topic</code> is provided</strong> and
returns <code>{brightness, type:'application'}</code>.</li>
<li><code>request_brightness_permission</code> /
<code>check_brightness_permission</code> always return
<code>permission_granted: true</code>.</li>
<li><code>resume_kiosk_after_permission</code> performs Android-only
behavior; on non-Android it returns
<code>{not_applicable:true}</code>.</li>
</ul>
<hr />
<h4 data-number="1.13.3.3" id="notifications-notify-alert"><span
class="header-section-number">1.13.3.3</span> Notifications
(<code>notify</code>, <code>alert</code>)</h4>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td><code>notify</code> or <code>alert</code>.</td>
</tr>
<tr>
<td><code>title</code></td>
<td>string</td>
<td><code>MQTT Notification</code> / <code>Alert</code></td>
<td>-</td>
</tr>
<tr>
<td><code>message</code> / <code>body</code></td>
<td>string</td>
<td>(required)</td>
<td>Message body (either key accepted).</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td><code>kingkiosk/{device}/system/response</code></td>
<td>Handler publishes a result payload.</td>
</tr>
</tbody>
</table>
<p><code>notify</code> additional keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>duration</code> / <code>duration_seconds</code> /
<code>toast_duration</code></td>
<td>number</td>
<td>-</td>
<td>Auto-dismiss seconds (Flutter toast + tvOS banner).</td>
</tr>
<tr>
<td><code>priority</code></td>
<td>string</td>
<td><code>normal</code></td>
<td>One of <code>low</code>, <code>normal</code>, <code>high</code>
(platform-dependent).</td>
</tr>
<tr>
<td><code>format</code> / <code>message_format</code></td>
<td>string</td>
<td><code>plain</code></td>
<td><code>plain</code>, <code>markdown</code>, <code>segments</code>
(tvOS supports <code>markdown</code> + <code>segments</code>; HTML is
not required).</td>
</tr>
<tr>
<td><code>markdown</code> / <code>message_markdown</code> /
<code>body_markdown</code></td>
<td>string</td>
<td>-</td>
<td>Convenience: markdown content (if set, treated as
<code>format: markdown</code>).</td>
</tr>
<tr>
<td><code>segments</code> / <code>rich_segments</code></td>
<td>array</td>
<td><code>[]</code></td>
<td>When <code>format: "segments"</code>: list of
<code>{ text, bold?, italic?, underline?, color?, font_size? }</code>.</td>
</tr>
<tr>
<td><code>thumbnail</code> / <code>image_url</code> /
<code>imageUrl</code> / <code>image</code></td>
<td>string</td>
<td>-</td>
<td>Optional image URL shown in the banner (tvOS supports all
keys).</td>
</tr>
<tr>
<td><code>is_html</code> / <code>html</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>HTML rendering is platform-dependent (tvOS currently uses
<code>markdown</code>/<code>segments</code> instead).</td>
</tr>
</tbody>
</table>
<p><code>alert</code> additional keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>type</code></td>
<td>string</td>
<td><code>info</code></td>
<td>Used to derive default priority if <code>priority</code> is not set
(<code>error</code>/<code>warning</code>/<code>info</code>/<code>success</code>).</td>
</tr>
<tr>
<td><code>priority</code></td>
<td>string</td>
<td>(derived)</td>
<td>If provided, overrides type-derived priority
(<code>low</code>/<code>normal</code>/<code>high</code>).</td>
</tr>
<tr>
<td><code>position</code></td>
<td>string</td>
<td><code>center</code></td>
<td>String forwarded to the alert UI (implementation supports positioned
alerts).</td>
</tr>
<tr>
<td><code>show_border</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>Border shown unless explicitly set to <code>false</code>.</td>
</tr>
<tr>
<td><code>border_color</code></td>
<td>string</td>
<td>-</td>
<td><code>#RRGGBB</code> or <code>#AARRGGBB</code> (optional).</td>
</tr>
<tr>
<td><code>auto_dismiss_seconds</code></td>
<td>int/string</td>
<td>-</td>
<td>Optional auto-dismiss; clamped to <code>[1, 300]</code>.</td>
</tr>
<tr>
<td><code>format</code> / <code>message_format</code></td>
<td>string</td>
<td><code>plain</code></td>
<td><code>plain</code>, <code>markdown</code>, <code>segments</code>
(same rich text support as <code>notify</code>).</td>
</tr>
<tr>
<td><code>markdown</code> / <code>message_markdown</code> /
<code>body_markdown</code></td>
<td>string</td>
<td>-</td>
<td>Convenience: markdown content (if set, treated as
<code>format: markdown</code>).</td>
</tr>
<tr>
<td><code>segments</code> / <code>rich_segments</code></td>
<td>array</td>
<td><code>[]</code></td>
<td>When <code>format: "segments"</code>: list of
<code>{ text, bold?, italic?, underline?, color?, font_size? }</code>.</td>
</tr>
<tr>
<td><code>is_html</code> / <code>html</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>Treat message as HTML.</td>
</tr>
<tr>
<td><code>thumbnail</code> / <code>image_url</code> /
<code>imageUrl</code> / <code>image</code></td>
<td>string</td>
<td>-</td>
<td>Network image URL.</td>
</tr>
</tbody>
</table>
<hr />
<h4 data-number="1.13.3.4" id="halo-effect-halo_effect"><span
class="header-section-number">1.13.3.4</span> Halo Effect
(<code>halo_effect</code>)</h4>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td>Must be <code>halo_effect</code>.</td>
</tr>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td>-</td>
<td>If provided, applies halo to a specific window; otherwise applies
global halo.</td>
</tr>
<tr>
<td><code>enabled</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>If <code>false</code>, disables the halo (global or
window-scoped).</td>
</tr>
<tr>
<td><code>color</code></td>
<td>string/int</td>
<td><code>#FF0000</code></td>
<td>Hex string (parsed) or ARGB int. Defaults to red.</td>
</tr>
<tr>
<td><code>width</code></td>
<td>number/string</td>
<td>-</td>
<td>Clamped to <code>[1.0, 200.0]</code> if provided.</td>
</tr>
<tr>
<td><code>intensity</code></td>
<td>number/string</td>
<td>-</td>
<td>Clamped to <code>[0.0, 1.0]</code> if provided.</td>
</tr>
<tr>
<td><code>pulse_mode</code></td>
<td>string</td>
<td><code>none</code></td>
<td>One of <code>none</code>, <code>gentle</code>,
<code>moderate</code>, <code>alert</code>.</td>
</tr>
<tr>
<td><code>pulse_duration</code></td>
<td>int/string</td>
<td><code>2000</code></td>
<td>Duration (ms), clamped to <code>[100, 10000]</code>.</td>
</tr>
<tr>
<td><code>fade_in_duration</code></td>
<td>int/string</td>
<td><code>800</code></td>
<td>Duration (ms), clamped to <code>[50, 5000]</code>.</td>
</tr>
<tr>
<td><code>fade_out_duration</code></td>
<td>int/string</td>
<td><code>1000</code></td>
<td>Duration (ms), clamped to <code>[50, 5000]</code>.</td>
</tr>
<tr>
<td><code>confirm</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>If true, publishes a confirmation payload (see below).</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td><code>kingkiosk/{device}/system/response</code></td>
<td>Always publishes
<code>{success, command:'halo_effect', window_id?, timestamp}</code>.</td>
</tr>
</tbody>
</table>
<p>Confirmation topics (only when <code>confirm == true</code>):</p>
<ul>
<li>Global: <code>kingkiosk/{device}/halo_effect/status</code></li>
<li>Window-scoped:
<code>kingkiosk/{device}/window/{window_id}/halo_effect/status</code></li>
</ul>
<hr />
<h4 data-number="1.13.3.5" id="screensaver-screensaver"><span
class="header-section-number">1.13.3.5</span> Screensaver
(<code>screensaver</code>)</h4>
<p>A full-screen overlay with independently bouncing items (clock,
image, text, icon). Sits on top of all content when enabled. Tap
anywhere to dismiss.</p>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td>Must be <code>screensaver</code> or <code>screen_saver</code>.</td>
</tr>
<tr>
<td><code>action</code></td>
<td>string</td>
<td><code>enable</code></td>
<td>One of <code>enable</code> (aliases: <code>on</code>,
<code>start</code>), <code>disable</code> (aliases: <code>off</code>,
<code>stop</code>), <code>toggle</code>, <code>wake</code>,
<code>wake_up</code>, <code>deactivate</code>, <code>set_config</code>
(alias: <code>configure</code>), <code>set_items</code>,
<code>add_item</code>, <code>remove_item</code>,
<code>update_item</code>, <code>clear_items</code>,
<code>get_state</code>.</td>
</tr>
<tr>
<td><code>items</code></td>
<td>array</td>
<td>-</td>
<td>Array of screensaver item objects (see below). Used with
<code>enable</code> or <code>set_items</code>.</td>
</tr>
<tr>
<td><code>item</code></td>
<td>object</td>
<td>-</td>
<td>Single screensaver item object. Used with
<code>add_item</code>.</td>
</tr>
<tr>
<td><code>item_id</code></td>
<td>string</td>
<td>-</td>
<td>Item ID to target. Used with <code>remove_item</code> or
<code>update_item</code>.</td>
</tr>
<tr>
<td><code>config</code></td>
<td>object</td>
<td>-</td>
<td>Config updates for <code>update_item</code>.</td>
</tr>
<tr>
<td><code>background_color</code></td>
<td>string/int</td>
<td><code>#000000</code></td>
<td>Hex string or ARGB int for background.</td>
</tr>
<tr>
<td><code>background_opacity</code></td>
<td>number</td>
<td><code>0.9</code></td>
<td>Background opacity (0.0-1.0).</td>
</tr>
<tr>
<td><code>idle_timeout</code></td>
<td>int</td>
<td><code>0</code></td>
<td>Seconds of inactivity before auto-enable (0 = manual only).</td>
</tr>
</tbody>
</table>
<p><strong>Screensaver Item Object:</strong></p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>string</td>
<td>auto-generated</td>
<td>Unique identifier for the item.</td>
</tr>
<tr>
<td><code>type</code></td>
<td>string</td>
<td><code>text</code></td>
<td>One of <code>clock</code>, <code>image</code>, <code>text</code>,
<code>icon</code>, <code>logo</code>.</td>
</tr>
<tr>
<td><code>config</code></td>
<td>object</td>
<td><code>{}</code></td>
<td>Type-specific configuration (see below).</td>
</tr>
<tr>
<td><code>width</code></td>
<td>number</td>
<td><code>150</code></td>
<td>Base width in logical pixels.</td>
</tr>
<tr>
<td><code>height</code></td>
<td>number</td>
<td><code>80</code></td>
<td>Base height in logical pixels.</td>
</tr>
<tr>
<td><code>speed</code></td>
<td>number</td>
<td><code>1.0</code></td>
<td>Movement speed multiplier (0.1-3.0). Higher = faster bouncing.</td>
</tr>
<tr>
<td><code>scale</code></td>
<td>number</td>
<td><code>1.0</code></td>
<td>Size scale factor (0.5-3.0).</td>
</tr>
</tbody>
</table>
<p><strong>Type-specific config:</strong></p>
<ul>
<li><strong>clock</strong>:
<code>{ "show_seconds": true, "show_date": false, "font_size": 48, "text_color": "#FFFFFF" }</code></li>
<li><strong>image/logo</strong>:
<code>{ "url": "https://example.com/logo.png", "fit": "contain" }</code></li>
<li><strong>text</strong>:
<code>{ "text": "Hello", "font_size": 36, "font_weight": "bold", "text_color": "#FFFFFF" }</code></li>
<li><strong>icon</strong>:
<code>{ "icon": "star", "size": 64, "color": "#FFFFFF" }</code> (icons:
star, heart, home, settings, music, play, pause, stop, cloud, sun,
moon)</li>
</ul>
<p><strong>Example: Enable screensaver with bouncing clock and
logo</strong></p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;screensaver&quot;</span><span class="fu">,</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;action&quot;</span><span class="fu">:</span> <span class="st">&quot;enable&quot;</span><span class="fu">,</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;items&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;clock_1&quot;</span><span class="fu">,</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;clock&quot;</span><span class="fu">,</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;config&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;show_seconds&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span> <span class="dt">&quot;text_color&quot;</span><span class="fu">:</span> <span class="st">&quot;#00FF00&quot;</span> <span class="fu">},</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;width&quot;</span><span class="fu">:</span> <span class="dv">250</span><span class="fu">,</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;height&quot;</span><span class="fu">:</span> <span class="dv">100</span><span class="fu">,</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;speed&quot;</span><span class="fu">:</span> <span class="fl">1.0</span><span class="fu">,</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;scale&quot;</span><span class="fu">:</span> <span class="fl">1.5</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;logo_1&quot;</span><span class="fu">,</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;image&quot;</span><span class="fu">,</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;config&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;url&quot;</span><span class="fu">:</span> <span class="st">&quot;https://example.com/logo.png&quot;</span> <span class="fu">},</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;width&quot;</span><span class="fu">:</span> <span class="dv">200</span><span class="fu">,</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;height&quot;</span><span class="fu">:</span> <span class="dv">200</span><span class="fu">,</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;speed&quot;</span><span class="fu">:</span> <span class="fl">0.7</span><span class="fu">,</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;scale&quot;</span><span class="fu">:</span> <span class="fl">1.0</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;background_color&quot;</span><span class="fu">:</span> <span class="st">&quot;#000000&quot;</span><span class="fu">,</span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;background_opacity&quot;</span><span class="fu">:</span> <span class="fl">0.95</span></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>Example: Disable screensaver</strong></p>
<div class="sourceCode" id="cb37"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;screensaver&quot;</span><span class="fu">,</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;action&quot;</span><span class="fu">:</span> <span class="st">&quot;disable&quot;</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>Example: Add a text item to running screensaver</strong></p>
<div class="sourceCode" id="cb38"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;screensaver&quot;</span><span class="fu">,</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;action&quot;</span><span class="fu">:</span> <span class="st">&quot;add_item&quot;</span><span class="fu">,</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;item&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;welcome_text&quot;</span><span class="fu">,</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;text&quot;</span><span class="fu">,</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;config&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;text&quot;</span><span class="fu">:</span> <span class="st">&quot;Welcome!&quot;</span><span class="fu">,</span> <span class="dt">&quot;font_size&quot;</span><span class="fu">:</span> <span class="dv">48</span><span class="fu">,</span> <span class="dt">&quot;text_color&quot;</span><span class="fu">:</span> <span class="st">&quot;#FF6600&quot;</span> <span class="fu">},</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;width&quot;</span><span class="fu">:</span> <span class="dv">300</span><span class="fu">,</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;height&quot;</span><span class="fu">:</span> <span class="dv">80</span><span class="fu">,</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;speed&quot;</span><span class="fu">:</span> <span class="fl">1.2</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>Example: Get current screensaver state</strong></p>
<div class="sourceCode" id="cb39"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;screensaver&quot;</span><span class="fu">,</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;action&quot;</span><span class="fu">:</span> <span class="st">&quot;get_state&quot;</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Response includes full state:
<code>{ "enabled": true, "items": [...], "background_color": "#000000", ... }</code></p>
<p><strong>Idle Screensaver (Settings-Based):</strong></p>
<p>King Kiosk also includes an idle-based screensaver that activates
automatically after a configurable timeout period. This is configured in
<strong>Settings → App Settings → Screensaver</strong> with three
modes:</p>
<table>
<thead>
<tr>
<th>Mode</th>
<th>Behavior</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>off</code></td>
<td>Idle screensaver disabled</td>
</tr>
<tr>
<td><code>dim</code></td>
<td>Screen goes black after timeout</td>
</tr>
<tr>
<td><code>screensaver</code></td>
<td>Bouncing clock appears after timeout</td>
</tr>
</tbody>
</table>
<p>The idle screensaver timeout is configurable from 1-60 minutes.</p>
<p><strong>Example: Wake from idle screensaver</strong></p>
<p>Use this command to remotely dismiss the idle screensaver (whether in
dim or clock mode):</p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;screensaver&quot;</span><span class="fu">,</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;action&quot;</span><span class="fu">:</span> <span class="st">&quot;wake&quot;</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Alternative actions: <code>wake_up</code>,
<code>deactivate</code></p>
<p>This command: 1. Disables any active MQTT-triggered bouncing
screensaver 2. Deactivates the idle-based screensaver (restores
brightness for dim mode, hides bouncing clock for screensaver mode) 3.
Resets the idle timer so the screensaver won’t immediately
reactivate</p>
<hr />
<h4 data-number="1.13.3.6"
id="settings-fab-lock-lock_fab-unlock_fab-lock_settings-unlock_settings"><span
class="header-section-number">1.13.3.6</span> Settings / FAB Lock
(<code>lock_fab</code>, <code>unlock_fab</code>,
<code>lock_settings</code>, <code>unlock_settings</code>)</h4>
<p>PIN-protected remote lock/unlock for the settings FAB.</p>
<p><code>lock_fab</code> and <code>lock_settings</code> are equivalent
aliases.<br />
<code>unlock_fab</code> and <code>unlock_settings</code> are equivalent
aliases.</p>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td>One of <code>lock_fab</code>, <code>unlock_fab</code>,
<code>lock_settings</code>, <code>unlock_settings</code>.</td>
</tr>
<tr>
<td><code>pin</code> / <code>settings_pin</code> /
<code>settingsPin</code> / <code>code</code></td>
<td>string/int</td>
<td>(required)</td>
<td>Settings PIN to authorize the action.</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td><code>kingkiosk/{device}/system/response</code></td>
<td>Response published via unified response helper.</td>
</tr>
<tr>
<td><code>correlation_id</code></td>
<td>string</td>
<td>-</td>
<td>Optional request correlation ID; echoed in responses.</td>
</tr>
</tbody>
</table>
<p>Behavior:</p>
<ul>
<li>Both lock and unlock commands require a valid settings PIN.</li>
<li>Lock commands set settings to locked and drive the normal FAB
melt/ember transition.</li>
<li>Unlock commands set settings to unlocked and drive the normal
reveal/awake transition.</li>
<li>Transitions continue from the current visual state (no forced
reset), including current ember/menu workflow.</li>
<li>If no custom settings PIN is configured on device, the runtime
fallback PIN is <code>1234</code>.</li>
</ul>
<p>Response payloads:</p>
<ul>
<li>Success:
<code>{success:true, status:'success', command, message, locked, timestamp, device, ...}</code></li>
<li>Error:
<code>{success:false, status:'error', command, error, timestamp, device, ...}</code></li>
<li>Common errors: unsupported command, missing PIN, invalid PIN,
settings controller unavailable.</li>
</ul>
<p>Example: lock FAB</p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;lock_fab&quot;</span><span class="fu">,</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;pin&quot;</span><span class="fu">:</span> <span class="st">&quot;1234&quot;</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Example: unlock FAB (alias + alternate PIN key)</p>
<div class="sourceCode" id="cb42"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;unlock_settings&quot;</span><span class="fu">,</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;settings_pin&quot;</span><span class="fu">:</span> <span class="st">&quot;1234&quot;</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<hr />
<h4 data-number="1.13.3.7" id="person-detection-person_detection"><span
class="header-section-number">1.13.3.7</span> Person Detection
(<code>person_detection</code>)</h4>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td>Must be <code>person_detection</code>.</td>
</tr>
<tr>
<td><code>action</code></td>
<td>string</td>
<td><code>toggle</code></td>
<td>One of <code>enable</code>, <code>disable</code>,
<code>toggle</code>, <code>status</code>.</td>
</tr>
<tr>
<td><code>confirm</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>If true, publishes a confirmation payload.</td>
</tr>
</tbody>
</table>
<p>Published topics:</p>
<ul>
<li>Always publishes current status to
<code>kingkiosk/{device}/person_presence</code>.</li>
<li>If <code>confirm == true</code>, also publishes to
<code>kingkiosk/{device}/person_detection/status</code>.</li>
</ul>
<hr />
<h4 data-number="1.13.3.8" id="security-camera-security_camera"><span
class="header-section-number">1.13.3.8</span> Security Camera
(<code>security_camera</code>)</h4>
<p>Note: <strong>Local settings are authoritative.</strong> If the
Security Camera is disabled in the app’s Settings, MQTT requests to
enable it or change its interval will be rejected.</p>
<p>Controls the periodic “security camera” capture flow in the WebRTC
media service.</p>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td>Must be <code>security_camera</code>.</td>
</tr>
<tr>
<td><code>action</code></td>
<td>string</td>
<td>-</td>
<td>One of <code>enable</code>, <code>disable</code>,
<code>set_interval</code>, <code>status</code>.</td>
</tr>
<tr>
<td><code>interval</code></td>
<td>int/string</td>
<td><code>3</code></td>
<td>Used by <code>enable</code> and <code>set_interval</code>
(seconds).</td>
</tr>
</tbody>
</table>
<p>Published topics:</p>
<ul>
<li>When enabled, publishes security camera snapshots to:
<ul>
<li><code>kingkiosk/{device}/camera/snapshot</code> (raw PNG bytes,
retained)</li>
<li><code>kingkiosk/{device}/camera/state</code> (JSON metadata,
retained)</li>
</ul></li>
<li>For <code>action == status</code>, additionally publishes to
<code>kingkiosk/{device}/security_camera/status</code> with
<code>{enabled, interval_seconds}</code>.</li>
</ul>
<p>Responses:</p>
<ul>
<li>Also publishes a standardized response to
<code>kingkiosk/{device}/system/response</code> via the unified response
helper.</li>
</ul>
<hr />
<h4 data-number="1.13.3.9"
id="screenshot-camera-screenshot_camera"><span
class="header-section-number">1.13.3.9</span> Screenshot Camera
(<code>screenshot_camera</code>)</h4>
<p>Controls the periodic “screenshot camera” capture flow in the
screenshot service.</p>
<p>Note: <strong>Local settings are authoritative.</strong> If
Screenshot Camera is disabled in the app’s Settings, MQTT requests to
enable it or change its interval will be rejected.</p>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td>Must be <code>screenshot_camera</code>.</td>
</tr>
<tr>
<td><code>action</code></td>
<td>string</td>
<td>-</td>
<td>One of <code>enable</code>, <code>disable</code>,
<code>set_interval</code>, <code>status</code>.</td>
</tr>
<tr>
<td><code>interval</code></td>
<td>int/string</td>
<td><code>5</code></td>
<td>Used by <code>enable</code> and <code>set_interval</code>
(seconds).</td>
</tr>
</tbody>
</table>
<p>Published topics:</p>
<ul>
<li>When enabled, publishes screenshot camera snapshots to:
<ul>
<li><code>kingkiosk/{device}/screenshot/snapshot</code> (raw PNG bytes,
not retained)</li>
<li><code>kingkiosk/{device}/screenshot/state</code> (JSON metadata, not
retained)</li>
</ul></li>
<li>For <code>action == status</code>, additionally publishes to
<code>kingkiosk/{device}/screenshot_camera/status</code> with
<code>{enabled, interval_seconds}</code>.</li>
</ul>
<p>Responses:</p>
<ul>
<li>Also publishes a standardized response to
<code>kingkiosk/{device}/system/response</code> via the unified response
helper.</li>
</ul>
<hr />
<h4 data-number="1.13.3.10" id="screenshot-screenshot"><span
class="header-section-number">1.13.3.10</span> Screenshot
(<code>screenshot</code>)</h4>
<p>Note: <strong>Local settings are authoritative.</strong> If
screenshots are disabled locally (Screenshot Camera is OFF in Settings),
MQTT screenshot requests will be rejected.</p>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td>Must be <code>screenshot</code>.</td>
</tr>
<tr>
<td><code>notify</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>If true, shows an on-device UI snackbar.</td>
</tr>
<tr>
<td><code>confirm</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>If true, publishes to
<code>kingkiosk/{device}/screenshot/status</code> on success or error
(independent of Home Assistant discovery).</td>
</tr>
</tbody>
</table>
<p>Published topics:</p>
<ul>
<li>When Home Assistant discovery is enabled, publishes screenshot
payload to <code>kingkiosk/{device}/screenshot</code> as a <strong>raw
base64 string</strong> (base64-encoded PNG bytes, retained).</li>
<li>If <code>confirm == true</code>, publishes a status JSON payload to
<code>kingkiosk/{device}/screenshot/status</code>.</li>
</ul>
<p>Decoding tip:</p>
<ul>
<li>Avoid <code>mosquitto_sub -v</code> (it prefixes the topic, breaking
base64 decode).</li>
<li>Capture exactly one payload and decode:
<ul>
<li><code>mosquitto_sub -t 'kingkiosk/&lt;device&gt;/screenshot' -C 1 -R &gt; shot.b64</code></li>
<li>macOS: <code>base64 -D shot.b64 &gt; shot.png</code></li>
<li>Linux: <code>base64 -d shot.b64 &gt; shot.png</code></li>
</ul></li>
</ul>
<hr />
<h4 data-number="1.13.3.11"
id="cache-cache-cache_control-clear_cache"><span
class="header-section-number">1.13.3.11</span> Cache
(<code>cache</code>, <code>cache_control</code>,
<code>clear_cache</code>)</h4>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td>One of <code>cache</code>, <code>cache_control</code>,
<code>clear_cache</code> (all route here).</td>
</tr>
<tr>
<td><code>action</code></td>
<td>string</td>
<td><code>stats</code></td>
<td>See action list below.</td>
</tr>
<tr>
<td><code>url</code></td>
<td>string</td>
<td>-</td>
<td>Required for <code>refresh</code> /
<code>refresh_resource</code>.</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td><code>kingkiosk/{device}/system/response</code></td>
<td>Response published via the unified response helper.</td>
</tr>
</tbody>
</table>
<p>Supported <code>action</code> values:</p>
<ul>
<li><code>clear</code>, <code>clear_all</code>,
<code>nuclear</code></li>
<li><code>clear_images</code></li>
<li><code>clear_data</code></li>
<li><code>refresh</code>, <code>refresh_resource</code> (requires
<code>url</code>)</li>
<li><code>stats</code>, <code>get_stats</code></li>
</ul>
<hr />
<h4 data-number="1.13.3.12" id="text-to-speech-tts-speak-say"><span
class="header-section-number">1.13.3.12</span> Text-to-Speech
(<code>tts</code>, <code>speak</code>, <code>say</code>)</h4>
<p>These commands forward an action map into the TTS service.</p>
<p><strong>Feature Server transparent takeover:</strong> When the
Feature Server is connected, <code>speak</code>, <code>getVoices</code>,
and <code>status</code> commands automatically route through the Feature
Server’s high-quality Piper TTS engine. When disconnected, the same
commands fall back to on-device TTS (FlutterTts on Flutter,
AVSpeechSynthesizer on tvOS). No changes to the MQTT command format are
required — the routing is transparent.</p>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td><code>tts</code>, <code>speak</code>, or <code>say</code>.</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td>-</td>
<td>If provided, publishes the TTS service result.</td>
</tr>
<tr>
<td><code>queue_first</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>Defaulted to <code>true</code> by the system handler (unless
explicitly <code>false</code>). Also controls pre-init queuing behavior
in the service.</td>
</tr>
</tbody>
</table>
<p>TTS action selection:</p>
<ul>
<li>The TTS service uses <code>action</code> (preferred), or falls back
to <code>command</code>.</li>
</ul>
<p>Common TTS keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>action</code></td>
<td>string</td>
<td><code>speak</code></td>
<td>Supported actions listed below.</td>
</tr>
<tr>
<td><code>text</code> / <code>message</code></td>
<td>string</td>
<td>-</td>
<td>Used by <code>speak</code>/<code>say</code>/<code>tts</code>
actions.</td>
</tr>
<tr>
<td><code>language</code></td>
<td>string</td>
<td>-</td>
<td>Example: <code>en-US</code>.</td>
</tr>
<tr>
<td><code>voice</code></td>
<td>string</td>
<td>-</td>
<td>Voice name. When Feature Server is connected, use a Piper voice ID
(e.g. <code>en_US-lessac-medium</code>).</td>
</tr>
<tr>
<td><code>volume</code></td>
<td>number</td>
<td>-</td>
<td>0.0–1.0. Mapped to 0–100 for Feature Server.</td>
</tr>
<tr>
<td><code>speechRate</code> / <code>rate</code></td>
<td>number</td>
<td>-</td>
<td>0.0–1.0. Mapped to 0–100 for Feature Server.</td>
</tr>
<tr>
<td><code>pitch</code></td>
<td>number</td>
<td>-</td>
<td>0.5–2.0. Mapped to 0–100 for Feature Server (1.0 = 33).</td>
</tr>
<tr>
<td><code>queue</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>If true (or if already speaking), queues the speak.</td>
</tr>
<tr>
<td><code>force</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>If true, bypasses deduplication check.</td>
</tr>
<tr>
<td><code>dedupe_ms</code> / <code>dedupeMs</code> /
<code>dedupe_window_ms</code></td>
<td>int</td>
<td><code>1200</code></td>
<td>Deduplication window in milliseconds. If the same
text+language+voice fingerprint is sent within this window, the
duplicate is silently skipped.</td>
</tr>
</tbody>
</table>
<p>Feature Server-only speak keys (ignored when using on-device
TTS):</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>delivery_mode</code></td>
<td>string</td>
<td><code>url</code></td>
<td><code>url</code> (recommended) or <code>inline</code> (base64 in WS
notification).</td>
</tr>
<tr>
<td><code>speaker_id</code></td>
<td>string</td>
<td>-</td>
<td>Multi-speaker voice speaker selection.</td>
</tr>
<tr>
<td><code>appended_silence_ms</code></td>
<td>int</td>
<td>-</td>
<td>Silence appended after synthesis (ms).</td>
</tr>
</tbody>
</table>
<p>Supported TTS <code>action</code> values:</p>
<ul>
<li>Speak: <code>tts</code>, <code>speak</code>, <code>say</code></li>
<li>Playback control: <code>stop</code>, <code>pause</code>,
<code>resume</code></li>
<li>Settings: <code>setVolume</code>/<code>volume</code>,
<code>setRate</code>/<code>rate</code>/<code>speed</code>,
<code>setPitch</code>/<code>pitch</code>,
<code>setLanguage</code>/<code>language</code>,
<code>setVoice</code>/<code>voice</code> (each accepts the specific
param or generic <code>value</code> key)</li>
<li>Service toggles: <code>enable</code>, <code>disable</code></li>
<li>Info: <code>status</code>/<code>getStatus</code>,
<code>getLanguages</code>,
<code>getVoices</code>/<code>voice_list</code>/<code>voices</code></li>
<li>Queue: <code>clearQueue</code></li>
<li>Feature Server only:
<code>voice_pull</code>/<code>pull_voice</code>/<code>install_voice</code></li>
</ul>
<p><strong>Feature Server voice actions:</strong></p>
<p><code>getVoices</code> / <code>voice_list</code> — When Feature
Server is connected, queries available Piper voices. Optional filter
keys:</p>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 35%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>language</code> / <code>language_code</code></td>
<td>string</td>
<td>Filter by language (e.g. <code>en_US</code>).</td>
</tr>
<tr>
<td><code>quality</code></td>
<td>string</td>
<td>Filter by quality (<code>x_low</code>, <code>low</code>,
<code>medium</code>, <code>high</code>).</td>
</tr>
<tr>
<td><code>query</code></td>
<td>string</td>
<td>Free-text search filter.</td>
</tr>
<tr>
<td><code>installed_only</code></td>
<td>bool</td>
<td>Only return installed voices.</td>
</tr>
<tr>
<td><code>limit</code></td>
<td>int</td>
<td>Max voices to return (default 25).</td>
</tr>
</tbody>
</table>
<p>Response includes <code>voices</code> array with objects containing
<code>voiceId</code>, <code>name</code>, <code>languageCode</code>,
<code>quality</code>, <code>installed</code>, <code>numSpeakers</code>,
etc.</p>
<p><code>voice_pull</code> — Ensures a voice is downloaded/installed on
the Feature Server. Requires <code>voice</code> parameter
(e.g. <code>en_US-lessac-medium</code>). Only available when Feature
Server is connected.</p>
<p><code>status</code> / <code>getStatus</code> — When Feature Server is
connected, response includes <code>source: "feature_server"</code>,
<code>engine: "piper"</code>, and
<code>feature_server_connected: true</code>.</p>
<hr />
<h4 data-number="1.13.3.13"
id="speech-to-text-stt-speech_to_text-listen"><span
class="header-section-number">1.13.3.13</span> Speech-to-Text
(<code>stt</code>, <code>speech_to_text</code>,
<code>listen</code>)</h4>
<p>These commands forward an action map into the Speech-to-Text
service.</p>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td><code>stt</code>, <code>speech_to_text</code>, or
<code>listen</code>.</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td>-</td>
<td>If provided, publishes the STT service result.</td>
</tr>
<tr>
<td><code>action</code></td>
<td>string</td>
<td><code>start</code></td>
<td>Action forwarded to the STT service.</td>
</tr>
</tbody>
</table>
<p>Supported STT <code>action</code> values and keys:</p>
<table>
<colgroup>
<col style="width: 40%" />
<col style="width: 30%" />
<col style="width: 30%" />
</colgroup>
<thead>
<tr>
<th>Action</th>
<th>Keys</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>start</code> / <code>listen</code></td>
<td>-</td>
<td>Starts listening.</td>
</tr>
<tr>
<td><code>stop</code></td>
<td>-</td>
<td>Stops listening and returns <code>{text, confidence}</code>.</td>
</tr>
<tr>
<td><code>status</code></td>
<td>-</td>
<td>Returns service status.</td>
</tr>
<tr>
<td><code>enable</code> / <code>disable</code></td>
<td>-</td>
<td>Enables/disables service.</td>
</tr>
<tr>
<td><code>set_language</code></td>
<td><code>language</code></td>
<td>Sets language (e.g., <code>en</code>).</td>
</tr>
<tr>
<td><code>use_whisper</code></td>
<td><code>use_whisper</code> (bool)</td>
<td>IO only; web always uses Web Speech.</td>
</tr>
<tr>
<td><code>set_mqtt_publishing</code> / <code>publish_to_mqtt</code></td>
<td><code>enabled</code> (bool)</td>
<td>Controls transcription MQTT publishing.</td>
</tr>
<tr>
<td><code>set_send_to_ai_agent</code> / <code>send_to_ai_agent</code> /
<code>ai_integration</code></td>
<td><code>enabled</code> (bool)</td>
<td>Controls AI agent integration.</td>
</tr>
<tr>
<td><code>provision_ai_chatbot_only</code></td>
<td>-</td>
<td>Sets <code>send_to_ai_agent=true</code> and
<code>publish_to_mqtt=false</code>.</td>
</tr>
</tbody>
</table>
<hr />
<h4 data-number="1.13.3.14"
id="audio-input-device-unified_audio-audio_input-audio_devices"><span
class="header-section-number">1.13.3.14</span> Audio Input Device
(<code>unified_audio</code>, <code>audio_input</code>,
<code>audio_devices</code>)</h4>
<p>These commands query and control the <strong>audio input
device</strong> used by Speech-to-Text (and other UnifiedAudioService
consumers).</p>
<p>This is the same device you select in the UI under <strong>Settings →
Speech &amp; AI → Audio Input Device</strong>.</p>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td><code>unified_audio</code>, <code>audio_input</code>, or
<code>audio_devices</code>.</td>
</tr>
<tr>
<td><code>action</code> / <code>command_action</code></td>
<td>string</td>
<td><code>status</code></td>
<td>One of <code>status</code> (alias: <code>getstatus</code>),
<code>list_devices</code> (aliases: <code>list</code>,
<code>devices</code>), <code>set_device</code> (alias:
<code>setdevice</code>).</td>
</tr>
<tr>
<td><code>device_id</code> / <code>deviceId</code></td>
<td>string</td>
<td>-</td>
<td>Required for <code>set_device</code>.</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td>-</td>
<td>If provided, publishes the action result payload.</td>
</tr>
</tbody>
</table>
<p>Examples:</p>
<div class="sourceCode" id="cb43"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;unified_audio&quot;</span><span class="fu">,</span> <span class="dt">&quot;action&quot;</span><span class="fu">:</span> <span class="st">&quot;status&quot;</span><span class="fu">,</span> <span class="dt">&quot;response_topic&quot;</span><span class="fu">:</span> <span class="st">&quot;kingkiosk/&lt;device&gt;/system/response&quot;</span> <span class="fu">}</span></span></code></pre></div>
<div class="sourceCode" id="cb44"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;unified_audio&quot;</span><span class="fu">,</span> <span class="dt">&quot;action&quot;</span><span class="fu">:</span> <span class="st">&quot;list_devices&quot;</span><span class="fu">,</span> <span class="dt">&quot;response_topic&quot;</span><span class="fu">:</span> <span class="st">&quot;kingkiosk/&lt;device&gt;/system/response&quot;</span> <span class="fu">}</span></span></code></pre></div>
<div class="sourceCode" id="cb45"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;unified_audio&quot;</span><span class="fu">,</span> <span class="dt">&quot;action&quot;</span><span class="fu">:</span> <span class="st">&quot;set_device&quot;</span><span class="fu">,</span> <span class="dt">&quot;device_id&quot;</span><span class="fu">:</span> <span class="st">&quot;1&quot;</span><span class="fu">,</span> <span class="dt">&quot;response_topic&quot;</span><span class="fu">:</span> <span class="st">&quot;kingkiosk/&lt;device&gt;/system/response&quot;</span> <span class="fu">}</span></span></code></pre></div>
<hr />
<h4 data-number="1.13.3.15"
id="background-set_background-get_background"><span
class="header-section-number">1.13.3.15</span> Background
(<code>set_background</code>, <code>get_background</code>)</h4>
<p><code>set_background</code> keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td>Must be <code>set_background</code>.</td>
</tr>
<tr>
<td><code>type</code></td>
<td>string</td>
<td>-</td>
<td>One of <code>default</code>, <code>image</code>,
<code>webview</code>.</td>
</tr>
<tr>
<td><code>image_path</code> / <code>image_url</code></td>
<td>string</td>
<td>-</td>
<td>Used when <code>type == image</code>.</td>
</tr>
<tr>
<td><code>web_url</code> / <code>url</code></td>
<td>string</td>
<td>-</td>
<td>Used when <code>type == webview</code>.</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td>-</td>
<td>If provided, publishes
<code>{success, message, type, image_path, web_url}</code>.</td>
</tr>
</tbody>
</table>
<p><code>get_background</code> keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td>Must be <code>get_background</code>.</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td><code>kingkiosk/{device}/status/background</code></td>
<td>Response payload:
<code>{ success: bool, background: { type, image_path, web_url } }</code>.</td>
</tr>
</tbody>
</table>
<hr />
<h4 data-number="1.13.3.16" id="provision-provision"><span
class="header-section-number">1.13.3.16</span> Provision
(<code>provision</code>)</h4>
<p>Provision applies settings and can optionally import saved layouts so
you can clone one device to another in a single command.</p>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td>Must be <code>provision</code>.</td>
</tr>
<tr>
<td><code>settings</code></td>
<td>object</td>
<td>-</td>
<td>Optional. If present, settings are read from this object.</td>
</tr>
<tr>
<td><code>screen_states</code> / <code>screenStates</code></td>
<td>array</td>
<td>-</td>
<td>Optional list of screen-state objects to import.</td>
</tr>
<tr>
<td><code>screen_state</code></td>
<td>object</td>
<td>-</td>
<td>Optional single screen-state object to import.</td>
</tr>
<tr>
<td><code>current_layout</code> / <code>currentLayout</code></td>
<td>object</td>
<td>-</td>
<td>Optional current layout snapshot to apply immediately.</td>
</tr>
<tr>
<td><code>overwrite</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>Used when importing screen states via provision.</td>
</tr>
<tr>
<td><code>correlation_id</code></td>
<td>string</td>
<td>-</td>
<td>Optional. Echoed in the provision response.</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td><code>kingkiosk/{device}/system/response</code></td>
<td>Provision always publishes a response.</td>
</tr>
<tr>
<td>(any other keys)</td>
<td>any</td>
<td>-</td>
<td>If <code>settings</code> is not provided, non-reserved keys are
treated as settings. Reserved keys include
command/response/correlation/import flags and layout payload keys
above.</td>
</tr>
</tbody>
</table>
<p>Supported settings keys (case-insensitive, with common aliases):</p>
<table>
<colgroup>
<col style="width: 57%" />
<col style="width: 21%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr>
<th>Setting key(s)</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>isDarkMode</code>, <code>darkMode</code>,
<code>dark_mode</code></td>
<td>bool</td>
<td>Theme.</td>
</tr>
<tr>
<td><code>kioskMode</code>, <code>kiosk_mode</code></td>
<td>bool</td>
<td>Kiosk mode toggle.</td>
</tr>
<tr>
<td><code>showSystemInfo</code>, <code>show_system_info</code></td>
<td>bool</td>
<td>Toggle system info overlay.</td>
</tr>
<tr>
<td><code>kioskStartUrl</code>, <code>kiosk_start_url</code>,
<code>startUrl</code></td>
<td>string</td>
<td>Start URL.</td>
</tr>
<tr>
<td><code>mqttEnabled</code>, <code>mqtt_enabled</code></td>
<td>bool</td>
<td>MQTT enable.</td>
</tr>
<tr>
<td><code>mqttBrokerUrl</code>, <code>mqtt_broker_url</code>,
<code>brokerUrl</code></td>
<td>string</td>
<td>Broker host/url.</td>
</tr>
<tr>
<td><code>mqttBrokerPort</code>, <code>mqtt_broker_port</code>,
<code>brokerPort</code></td>
<td>int</td>
<td>1–65535.</td>
</tr>
<tr>
<td><code>mqttUsername</code>, <code>mqtt_username</code></td>
<td>string</td>
<td>Stored in secure storage.</td>
</tr>
<tr>
<td><code>mqttPassword</code>, <code>mqtt_password</code></td>
<td>string</td>
<td>Stored in secure storage.</td>
</tr>
<tr>
<td><code>deviceName</code>, <code>device_name</code></td>
<td>string</td>
<td>Sanitized and applied to MQTT device namespace.</td>
</tr>
<tr>
<td><code>mqttHaDiscovery</code>, <code>mqtt_ha_discovery</code>,
<code>haDiscovery</code></td>
<td>bool</td>
<td>Also updates runtime discovery flag.</td>
</tr>
<tr>
<td><code>mqttUseSSL</code>, <code>mqtt_use_ssl</code>,
<code>mqttSSL</code>, <code>mqtt_ssl</code></td>
<td>bool</td>
<td>Enabling may auto-adjust the port.</td>
</tr>
<tr>
<td><code>mqttAllowSelfSigned</code>,
<code>mqtt_allow_self_signed</code>, <code>mqttSelfSigned</code>,
<code>mqtt_self_signed</code></td>
<td>bool</td>
<td>-</td>
</tr>
<tr>
<td><code>mqttUseHmacAuth</code>, <code>mqtt_use_hmac_auth</code>,
<code>mqttHmacAuth</code>, <code>mqtt_hmac_auth</code></td>
<td>bool</td>
<td>Enables/disables MQTT HMAC auth mode.</td>
</tr>
<tr>
<td><code>mqttHmacSecret</code>, <code>mqtt_hmac_secret</code>,
<code>hmacSecret</code></td>
<td>string</td>
<td>Shared secret used by HMAC auth.</td>
</tr>
<tr>
<td><code>webviewAllowInvalidCerts</code>,
<code>webview_allow_invalid_certs</code>,
<code>allowInvalidWebviewCerts</code></td>
<td>bool</td>
<td>WebView hardening flag.</td>
</tr>
<tr>
<td><code>networkAllowInvalidCerts</code>,
<code>network_allow_invalid_certs</code>,
<code>allowInvalidCerts</code></td>
<td>bool</td>
<td>Network hardening flag for non-WebView requests.</td>
</tr>
<tr>
<td><code>enableEvalJs</code>, <code>enable_evaljs</code>,
<code>evalJsEnabled</code>, <code>evaljs_enabled</code></td>
<td>bool</td>
<td>WebView hardening flag.</td>
</tr>
<tr>
<td><code>mqttCaCertPath</code>, <code>mqtt_ca_cert_path</code>,
<code>mqttCaCert</code>, <code>mqtt_ca_cert</code></td>
<td>string</td>
<td>-</td>
</tr>
<tr>
<td><code>mqttClientCertPath</code>, <code>mqtt_client_cert_path</code>,
<code>mqttClientCert</code>, <code>mqtt_client_cert</code></td>
<td>string</td>
<td>-</td>
</tr>
<tr>
<td><code>mqttClientKeyPath</code>, <code>mqtt_client_key_path</code>,
<code>mqttClientKey</code>, <code>mqtt_client_key</code></td>
<td>string</td>
<td>-</td>
</tr>
<tr>
<td><code>personDetectionEnabled</code>,
<code>person_detection_enabled</code>, <code>personDetection</code>,
<code>person_detection</code></td>
<td>bool</td>
<td>Also updates person detection service state when available.</td>
</tr>
<tr>
<td><code>haAccessToken</code>, <code>ha_access_token</code>,
<code>homeAssistantToken</code>, <code>home_assistant_token</code></td>
<td>string</td>
<td>Stored in secure storage and synced to AI agent service when
available.</td>
</tr>
<tr>
<td><code>settingsPin</code>, <code>settings_pin</code>,
<code>pin</code></td>
<td>string</td>
<td>Minimum length 4; stored in secure storage.</td>
</tr>
<tr>
<td><code>sendToAIAgent</code>, <code>send_to_ai_agent</code>,
<code>aiIntegration</code>, <code>ai_integration</code></td>
<td>bool</td>
<td>Enables/disables Speech-to-AI integration.</td>
</tr>
<tr>
<td><code>aiAgentEnabled</code>, <code>ai_agent_enabled</code></td>
<td>bool</td>
<td>Enables/disables AI agent service; enabling may also enable
Speech-to-AI.</td>
</tr>
<tr>
<td><code>aiEnabled</code>, <code>ai_enabled</code></td>
<td>bool</td>
<td>AI feature toggle.</td>
</tr>
<tr>
<td><code>aiProviderHost</code>, <code>ai_provider_host</code>,
<code>aiProviderUrl</code></td>
<td>string</td>
<td>AI provider endpoint.</td>
</tr>
<tr>
<td><code>haBaseUrl</code>, <code>ha_base_url</code>,
<code>homeAssistantUrl</code>, <code>home_assistant_url</code></td>
<td>string</td>
<td>Home Assistant base URL.</td>
</tr>
<tr>
<td><code>haAgentId</code>, <code>ha_agent_id</code>,
<code>conversationAgent</code>, <code>conversation_agent</code></td>
<td>string</td>
<td>Home Assistant conversation agent id.</td>
</tr>
<tr>
<td><code>sipEnabled</code>, <code>sip_enabled</code></td>
<td>bool</td>
<td>SIP enable toggle.</td>
</tr>
<tr>
<td><code>sipServerHost</code>, <code>sip_server_host</code></td>
<td>string</td>
<td>SIP server host.</td>
</tr>
<tr>
<td><code>sipProtocol</code>, <code>sip_protocol</code></td>
<td>string</td>
<td><code>ws</code> or <code>wss</code>.</td>
</tr>
<tr>
<td><code>selectedAudioInput</code>,
<code>selected_audio_input</code></td>
<td>string</td>
<td>Selected audio input id/name.</td>
</tr>
<tr>
<td><code>selectedVideoInput</code>,
<code>selected_video_input</code></td>
<td>string</td>
<td>Selected video input id/name.</td>
</tr>
<tr>
<td><code>selectedAudioOutput</code>,
<code>selected_audio_output</code></td>
<td>string</td>
<td>Selected audio output id/name.</td>
</tr>
<tr>
<td><code>wyomingHost</code>, <code>wyoming_host</code></td>
<td>string</td>
<td>Wyoming host.</td>
</tr>
<tr>
<td><code>wyomingPort</code>, <code>wyoming_port</code></td>
<td>int</td>
<td>Wyoming port.</td>
</tr>
<tr>
<td><code>wyomingEnabled</code>, <code>wyoming_enabled</code></td>
<td>bool</td>
<td>Wyoming enable toggle.</td>
</tr>
<tr>
<td><code>featureServerEnabled</code>,
<code>feature_server_enabled</code></td>
<td>bool</td>
<td>Enable/disable Feature Server.</td>
</tr>
<tr>
<td><code>featureServerAutoConnect</code>,
<code>feature_server_auto_connect</code></td>
<td>bool</td>
<td>Auto-connect Feature Server when app starts.</td>
</tr>
<tr>
<td><code>featureServerUrl</code>, <code>feature_server_url</code></td>
<td>string</td>
<td>Feature Server host/IP (cross-platform safe format; avoid
<code>ws://</code> prefix).</td>
</tr>
<tr>
<td><code>featureServerUseHttps</code>,
<code>feature_server_use_https</code></td>
<td>bool</td>
<td>Use secure WebSocket (<code>wss</code>) for Feature Server
signaling.</td>
</tr>
<tr>
<td><code>featureServerProduceAudio</code>,
<code>feature_server_produce_audio</code></td>
<td>bool</td>
<td>Include microphone audio when producing to Feature Server.</td>
</tr>
<tr>
<td><code>intercomEnabled</code>, <code>intercom_enabled</code></td>
<td>bool</td>
<td>Enable intercom/broadcast participation.</td>
</tr>
<tr>
<td><code>intercomGroups</code>, <code>intercom_groups</code></td>
<td>array<string></td>
<td>Intercom groups (tvOS supports this directly; other clients may
ignore).</td>
</tr>
<tr>
<td><code>websocketUrl</code>, <code>websocket_url</code></td>
<td>string</td>
<td>Websocket endpoint.</td>
</tr>
<tr>
<td><code>mediaServerUrl</code>, <code>media_server_url</code></td>
<td>string</td>
<td>Media server endpoint.</td>
</tr>
<tr>
<td><code>latestScreenshot</code>, <code>latest_screenshot</code></td>
<td>string</td>
<td>Metadata/path field.</td>
</tr>
<tr>
<td><code>autoLockEnabled</code>, <code>auto_lock_enabled</code></td>
<td>bool</td>
<td>Enable/disable auto-lock for settings screen.</td>
</tr>
<tr>
<td><code>autoLockTimeout</code>, <code>auto_lock_timeout</code>,
<code>autoLockTimeoutMinutes</code>,
<code>auto_lock_timeout_minutes</code></td>
<td>double</td>
<td>Auto-lock timeout in minutes (e.g. 1, 2, 5, 10, 15, 30, 60).</td>
</tr>
<tr>
<td><code>screensaverMode</code>, <code>screensaver_mode</code></td>
<td>string</td>
<td>Screensaver mode: <code>off</code>, <code>dim</code>, or
<code>clock</code> (Flutter) / <code>screensaver</code> (tvOS).</td>
</tr>
<tr>
<td><code>screensaverTimeout</code>, <code>screensaver_timeout</code>,
<code>screensaverTimeoutMinutes</code>,
<code>screensaver_timeout_minutes</code></td>
<td>double</td>
<td>Screensaver timeout in minutes.</td>
</tr>
<tr>
<td><code>backgroundType</code>, <code>background_type</code></td>
<td>string</td>
<td>Background type: <code>default</code>, <code>image</code>, or
<code>webview</code>.</td>
</tr>
<tr>
<td><code>backgroundImageUrl</code>, <code>background_image_url</code>,
<code>backgroundImagePath</code>,
<code>background_image_path</code></td>
<td>string</td>
<td>Background image URL/path.</td>
</tr>
<tr>
<td><code>backgroundWebUrl</code>, <code>background_web_url</code></td>
<td>string</td>
<td>Background WebView URL (Flutter only).</td>
</tr>
<tr>
<td><code>locationEnabled</code>, <code>location_enabled</code></td>
<td>bool</td>
<td>Enable location services (Flutter only).</td>
</tr>
<tr>
<td><code>brightnessLevel</code>, <code>brightness_level</code></td>
<td>double</td>
<td>Screen brightness 0–100 (Flutter only).</td>
</tr>
<tr>
<td><code>mqttReconnectOnStartup</code>,
<code>mqtt_reconnect_on_startup</code></td>
<td>bool</td>
<td>Auto-reconnect MQTT on app startup.</td>
</tr>
<tr>
<td><code>kingDspDiscoveryEnabled</code>,
<code>kingdsp_discovery_enabled</code>,
<code>kingDspIntercomEnabled</code></td>
<td>bool</td>
<td>Enable KingDSP network discovery.</td>
</tr>
<tr>
<td><code>dlnaRendererEnabled</code>,
<code>dlna_renderer_enabled</code></td>
<td>bool</td>
<td>Enable DLNA/UPnP media renderer.</td>
</tr>
<tr>
<td><code>enableContinuityCamera</code></td>
<td>bool</td>
<td>Enable Continuity Camera (tvOS only).</td>
</tr>
<tr>
<td><code>sttEnabled</code>, <code>stt_enabled</code>,
<code>speechToTextEnabled</code>,
<code>speech_to_text_enabled</code></td>
<td>bool</td>
<td>Enable speech-to-text service (Flutter).</td>
</tr>
<tr>
<td><code>autoSpeakResponses</code>,
<code>auto_speak_responses</code></td>
<td>bool</td>
<td>Auto-speak AI responses (Flutter).</td>
</tr>
<tr>
<td><code>continueListening</code>, <code>continue_listening</code></td>
<td>bool</td>
<td>Continue listening after AI response (Flutter).</td>
</tr>
<tr>
<td><code>keepConversationHistory</code>,
<code>keep_conversation_history</code></td>
<td>bool</td>
<td>Keep AI conversation history (Flutter).</td>
</tr>
<tr>
<td><code>ttsRate</code></td>
<td>float</td>
<td>TTS speech rate (tvOS, 0.0–1.0).</td>
</tr>
<tr>
<td><code>ttsPitch</code></td>
<td>float</td>
<td>TTS speech pitch (tvOS, 0.5–2.0).</td>
</tr>
<tr>
<td><code>ttsVolume</code></td>
<td>float</td>
<td>TTS speech volume (tvOS, 0.0–1.0).</td>
</tr>
<tr>
<td><code>ttsLanguage</code></td>
<td>string</td>
<td>TTS language code e.g. <code>en-US</code> (tvOS).</td>
</tr>
<tr>
<td><code>enablePersonDetection</code></td>
<td>bool</td>
<td>Enable person detection (tvOS).</td>
</tr>
<tr>
<td><code>enableFaceRecognition</code></td>
<td>bool</td>
<td>Enable face recognition (tvOS).</td>
</tr>
<tr>
<td><code>detectionInterval</code></td>
<td>double</td>
<td>ML detection interval in seconds (tvOS).</td>
</tr>
<tr>
<td><code>enableKingDSP</code></td>
<td>bool</td>
<td>Enable KingDSP audio streaming (tvOS).</td>
</tr>
<tr>
<td><code>kingDSPHost</code></td>
<td>string</td>
<td>KingDSP server host (tvOS).</td>
</tr>
<tr>
<td><code>kingDSPPort</code></td>
<td>int</td>
<td>KingDSP server port (tvOS, default 4954).</td>
</tr>
<tr>
<td><code>aiProvider</code></td>
<td>string</td>
<td>AI provider: <code>openai</code>, <code>anthropic</code>,
<code>google</code>, <code>custom</code>, <code>homeassistant</code>
(tvOS).</td>
</tr>
<tr>
<td><code>aiModel</code></td>
<td>string</td>
<td>AI model name (tvOS).</td>
</tr>
<tr>
<td><code>aiApiKey</code></td>
<td>string</td>
<td>AI API key; stored in secure storage (tvOS).</td>
</tr>
<tr>
<td><code>aiSystemPrompt</code></td>
<td>string</td>
<td>AI system prompt (tvOS).</td>
</tr>
<tr>
<td><code>aiMaxTokens</code></td>
<td>int</td>
<td>AI max tokens (tvOS).</td>
</tr>
<tr>
<td><code>aiTemperature</code></td>
<td>double</td>
<td>AI temperature 0.0–2.0 (tvOS).</td>
</tr>
<tr>
<td><code>aiAutoSpeak</code></td>
<td>bool</td>
<td>Auto-speak AI responses (tvOS).</td>
</tr>
<tr>
<td><code>aiListenAfterResponse</code></td>
<td>bool</td>
<td>Continue listening after AI response (tvOS).</td>
</tr>
<tr>
<td><code>aiKeepHistory</code></td>
<td>bool</td>
<td>Keep conversation history (tvOS).</td>
</tr>
<tr>
<td><code>sttLanguage</code></td>
<td>string</td>
<td>STT language code (tvOS).</td>
</tr>
<tr>
<td><code>sttModel</code></td>
<td>string</td>
<td>STT model name (tvOS).</td>
</tr>
<tr>
<td><code>sttTranslate</code></td>
<td>bool</td>
<td>Translate STT to English (tvOS).</td>
</tr>
<tr>
<td><code>sttUseVAD</code></td>
<td>bool</td>
<td>Use Voice Activity Detection for STT (tvOS).</td>
</tr>
<tr>
<td><code>ai_chatbot</code> / <code>ai_chat_bot</code> /
<code>chatbot</code></td>
<td>object</td>
<td>See AI Chat Bot object below.</td>
</tr>
</tbody>
</table>
<p>Provision response payload includes:</p>
<ul>
<li><code>status</code>: <code>success</code>, <code>partial</code>, or
<code>error</code></li>
<li><code>applied_settings</code>: list of settings applied</li>
<li><code>failed_settings</code>: map of setting key -&gt; reason</li>
<li><code>screen_states_imported</code>: imported state names</li>
<li><code>screen_states_failed</code>: map of state name -&gt;
reason</li>
<li><code>current_layout_applied</code>: bool</li>
<li><code>correlation_id</code> (when provided in request)</li>
</ul>
<p>AI Chat Bot object (<code>ai_chatbot</code>) keys:</p>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 35%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>provider</code></td>
<td>string</td>
<td>-</td>
</tr>
<tr>
<td><code>api_key</code></td>
<td>string</td>
<td>-</td>
</tr>
<tr>
<td><code>base_url</code></td>
<td>string</td>
<td>-</td>
</tr>
<tr>
<td><code>model</code></td>
<td>string</td>
<td>-</td>
</tr>
<tr>
<td><code>system_prompt</code></td>
<td>string</td>
<td>Stored under the <code>systemPrompt</code> key in the service
config.</td>
</tr>
</tbody>
</table>
<p>Feature Server provisioning example:</p>
<div class="sourceCode" id="cb46"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;provision&quot;</span><span class="fu">,</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;settings&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;featureServerEnabled&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;featureServerAutoConnect&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;featureServerUrl&quot;</span><span class="fu">:</span> <span class="st">&quot;192.168.1.50&quot;</span><span class="fu">,</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;featureServerUseHttps&quot;</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;featureServerProduceAudio&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;intercomEnabled&quot;</span><span class="fu">:</span> <span class="kw">true</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;correlation_id&quot;</span><span class="fu">:</span> <span class="st">&quot;provision-feature-server-001&quot;</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>After provisioning, subscribe to:</p>
<p><code>kingkiosk/{device_id}/feature_server/state</code></p>
<p>The payload is retained and includes fields like
<code>enabled</code>, <code>connected</code>, <code>state</code>,
<code>last_error</code>, and reconnect metadata.</p>
<hr />
<h4 data-number="1.13.3.17" id="get-config-get_config"><span
class="header-section-number">1.13.3.17</span> Get Config
(<code>get_config</code>)</h4>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td>Must be <code>get_config</code>.</td>
</tr>
<tr>
<td><code>include_secrets</code> / <code>includeSecrets</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>Include secret values (passwords/tokens/PIN/secrets) in returned
config.</td>
</tr>
<tr>
<td><code>include_layouts</code> / <code>includeLayouts</code> /
<code>include_screen_states</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>Include saved screen states and current layout snapshot.</td>
</tr>
<tr>
<td><code>correlation_id</code></td>
<td>string</td>
<td>-</td>
<td>Optional. Echoed in response.</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td><code>kingkiosk/{device}/system/response</code></td>
<td>-</td>
</tr>
</tbody>
</table>
<p>Response payload:</p>
<p><code>{command:'get_config', status:'success', device_name, config:{...}, settings:{...}, timestamp, correlation_id?, screen_states?, screen_state_count?, current_layout?}</code></p>
<p>Notes:</p>
<ul>
<li><code>settings</code> is an alias of <code>config</code> for
compatibility.</li>
<li>When <code>include_secrets</code> is <code>false</code>, secret
fields are masked as <code>***</code>.</li>
<li>When <code>include_layouts</code> is <code>true</code>, response
includes <code>screen_states</code>, <code>screen_state_count</code>,
and <code>current_layout</code>.</li>
<li>The <code>config</code> object includes all provisionable settings
listed in the provision table above (including screensaver, background,
auto-lock, networked audio, ML detection, TTS, STT, AI behavior, and
MQTT reconnect settings). This allows admin tools to prepopulate
settings screens with current device state.</li>
</ul>
<hr />
<h4 data-number="1.13.3.18" id="ai-agent-ai_agent-ai"><span
class="header-section-number">1.13.3.18</span> AI Agent
(<code>ai_agent</code> / <code>ai</code>)</h4>
<p>Top-level keys:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td><code>ai_agent</code> or <code>ai</code>.</td>
</tr>
<tr>
<td><code>action</code></td>
<td>string</td>
<td>-</td>
<td>Required for most operations.</td>
</tr>
</tbody>
</table>
<p>Supported <code>action</code> values and keys:</p>
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 15%" />
<col style="width: 64%" />
</colgroup>
<thead>
<tr>
<th>Action</th>
<th>Keys</th>
<th>Published topics / notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>enable</code></td>
<td><code>enabled</code> (bool, default true)</td>
<td>Enables/disables AI agent service.</td>
</tr>
<tr>
<td><code>select_agent</code></td>
<td><code>agent_index</code> (int)</td>
<td>Selects an agent by index.</td>
</tr>
<tr>
<td><code>configure_home_assistant</code></td>
<td><code>base_url</code>, <code>access_token</code>,
<code>agent_id</code> (optional)</td>
<td>Auto-discovers agents after config.</td>
</tr>
<tr>
<td><code>send_message</code></td>
<td><code>message</code> (string), <code>conversation_id</code>
(optional)</td>
<td>Sends text to AI agent.</td>
</tr>
<tr>
<td><code>create_conversation</code></td>
<td><code>user_id</code> (optional), <code>user_name</code>
(optional)</td>
<td>Publishes
<code>kingkiosk/{device}/ai_agent/conversation_created</code>.</td>
</tr>
<tr>
<td><code>switch_user</code></td>
<td><code>user_id</code>, <code>user_name</code></td>
<td>Switches active conversation.</td>
</tr>
<tr>
<td><code>clear_conversation</code></td>
<td><code>conversation_id</code> (optional)</td>
<td>Clears one or all conversations.</td>
</tr>
<tr>
<td><code>get_status</code></td>
<td>-</td>
<td>Publishes <code>kingkiosk/{device}/ai_agent/status</code>.</td>
</tr>
<tr>
<td><code>speech_integration</code></td>
<td><code>enabled</code> (bool, default true)</td>
<td>Enables Speech-to-AI integration.</td>
</tr>
<tr>
<td><code>speech_mqtt_publishing</code> /
<code>publish_speech_to_mqtt</code></td>
<td><code>enabled</code> (bool, default true)</td>
<td>Enables transcription MQTT publishing.</td>
</tr>
<tr>
<td><code>discover_agents</code></td>
<td>-</td>
<td>Publishes
<code>kingkiosk/{device}/ai_agent/agents_discovered</code>.</td>
</tr>
<tr>
<td><code>select_ha_agent</code></td>
<td><code>agent_id</code></td>
<td>Selects HA conversation agent.</td>
</tr>
<tr>
<td><code>configure_chat_bot</code></td>
<td><code>provider</code>, <code>api_key</code>, <code>base_url</code>,
<code>model</code></td>
<td>Configures the local Chat Bot.</td>
</tr>
</tbody>
</table>
<p>Additional published topics (implementation detail, but useful for
admin UIs):</p>
<ul>
<li><code>kingkiosk/{device}/ai_agent/message_response</code>
(non-retained): emitted for <code>send_message</code> with
<code>message</code>, <code>response</code>, <code>status</code>,
<code>timestamp</code>.</li>
<li><code>kingkiosk/{device}/ai_agent/conversation_cleared</code>
(non-retained): emitted for <code>clear_conversation</code>.</li>
</ul>
<hr />
<h4 data-number="1.13.3.19"
id="ai-provisioning-provision_ai_chatbot-setup_ai_chatbot-configure_ai_chatbot"><span
class="header-section-number">1.13.3.19</span> AI Provisioning
(<code>provision_ai_chatbot</code>, <code>setup_ai_chatbot</code>,
<code>configure_ai_chatbot</code>)</h4>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td>One of the provisioning command aliases above.</td>
</tr>
<tr>
<td><code>provider</code></td>
<td>string</td>
<td><code>anthropic</code></td>
<td>Supported: <code>anthropic</code>, <code>openai</code>,
<code>gemini</code>, <code>ollama</code>.</td>
</tr>
<tr>
<td><code>api_key</code></td>
<td>string</td>
<td>-</td>
<td>Provider API key (if needed).</td>
</tr>
<tr>
<td><code>base_url</code></td>
<td>string</td>
<td>-</td>
<td>Used by providers like <code>ollama</code>.</td>
</tr>
<tr>
<td><code>model</code></td>
<td>string</td>
<td>(provider default)</td>
<td>Defaults depend on provider.</td>
</tr>
<tr>
<td><code>system_prompt</code></td>
<td>string</td>
<td>(provider default)</td>
<td>Defaults depend on provider.</td>
</tr>
<tr>
<td><code>enable_speech</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>Enables Speech-to-Text.</td>
</tr>
<tr>
<td><code>enable_tts</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>Enables Text-to-Speech.</td>
</tr>
<tr>
<td><code>chatbot_only_mode</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>Disables MQTT publishing of transcriptions when true.</td>
</tr>
</tbody>
</table>
<p>Publishes status to
<code>kingkiosk/{device}/ai_provisioning/status</code>.</p>
<hr />
<h4 data-number="1.13.3.20"
id="command-history-audit-mqtt_cmd_history-aliases"><span
class="header-section-number">1.13.3.20</span> Command History / Audit
(<code>mqtt_cmd_history</code> + aliases)</h4>
<p>This subsystem exposes the in-memory command audit/history service
over MQTT.</p>
<p>Primary command:</p>
<ul>
<li><code>mqtt_cmd_history</code></li>
</ul>
<p>Aliases (mapped to <code>mqtt_cmd_history</code> internally):</p>
<ul>
<li><code>get_command_history</code> (sets <code>action: 'list'</code>
and defaults <code>limit</code> to 100)</li>
<li><code>get_audit_history</code> (sets <code>action: 'list'</code> and
defaults <code>limit</code> to 100)</li>
<li><code>clear_command_history</code> (sets
<code>action: 'clear'</code>)</li>
<li><code>clear_audit_history</code> (sets
<code>action: 'clear'</code>)</li>
<li><code>get_audit_stats</code> (sets
<code>action: 'stats'</code>)</li>
</ul>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td>One of the command strings above.</td>
</tr>
<tr>
<td><code>action</code></td>
<td>string</td>
<td><code>list</code></td>
<td>Only used when <code>command == mqtt_cmd_history</code>. See
supported actions below.</td>
</tr>
<tr>
<td><code>limit</code></td>
<td>int/string</td>
<td><code>100</code></td>
<td>Used for list and many queries.</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td><code>kingkiosk/{device}/system/response</code></td>
<td>Responses are published to this topic (non-retained).</td>
</tr>
</tbody>
</table>
<p>Supported <code>action</code> values (when using
<code>command: 'mqtt_cmd_history'</code>):</p>
<ul>
<li><code>list</code> / <code>get</code></li>
<li><code>stats</code></li>
<li><code>clear</code></li>
<li><code>query_by_time</code> / <code>query_time_range</code> (requires
<code>start_time</code> and <code>end_time</code> as ISO8601)</li>
<li><code>query_by_correlation</code> / <code>query_correlation</code>
(requires <code>correlation_id</code>)</li>
<li><code>query_by_command</code> / <code>query_command_type</code>
(requires <code>command_type</code>)</li>
<li><code>query_by_source</code> / <code>query_source_type</code>
(requires <code>source_type</code>)</li>
<li><code>query_by_window</code> / <code>query_window</code> (requires
<code>window_id</code>)</li>
<li><code>query_by_batch</code> / <code>query_batch</code> (requires
<code>batch_id</code>)</li>
<li><code>query_by_status</code> / <code>query_response_status</code>
(requires <code>status</code>)</li>
<li><code>replay</code> (see below)</li>
</ul>
<p>Action-specific keys:</p>
<table>
<colgroup>
<col style="width: 57%" />
<col style="width: 42%" />
</colgroup>
<thead>
<tr>
<th>Action</th>
<th>Keys</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>query_by_time</code> / <code>query_time_range</code></td>
<td><code>start_time</code> (ISO8601), <code>end_time</code> (ISO8601),
optional <code>limit</code></td>
</tr>
<tr>
<td><code>query_by_correlation</code> /
<code>query_correlation</code></td>
<td><code>correlation_id</code></td>
</tr>
<tr>
<td><code>query_by_command</code> / <code>query_command_type</code></td>
<td><code>command_type</code>, optional <code>limit</code></td>
</tr>
<tr>
<td><code>query_by_source</code> / <code>query_source_type</code></td>
<td><code>source_type</code> (example values: <code>mqtt</code>,
<code>touch</code>, <code>batch</code>, <code>api</code>,
<code>local</code>), optional <code>limit</code></td>
</tr>
<tr>
<td><code>query_by_window</code> / <code>query_window</code></td>
<td><code>window_id</code>, optional <code>limit</code></td>
</tr>
<tr>
<td><code>query_by_batch</code> / <code>query_batch</code></td>
<td><code>batch_id</code></td>
</tr>
<tr>
<td><code>query_by_status</code> /
<code>query_response_status</code></td>
<td><code>status</code> (expected: <code>success</code>,
<code>error</code>, <code>pending</code>), optional
<code>limit</code></td>
</tr>
<tr>
<td><code>replay</code></td>
<td><code>command_ids</code> (list of ints/strings) OR
<code>correlation_id</code>, optional <code>dry_run</code> (bool)</td>
</tr>
</tbody>
</table>
<p>Response payloads:</p>
<ul>
<li>Responses are published to <code>response_topic</code> as JSON with
<code>command: 'audit_response'</code> and include <code>action</code>,
<code>timestamp</code> (ISO8601), <code>device</code>, and
action-specific fields.</li>
<li>Errors are also published to <code>response_topic</code> with
<code>action: 'error'</code> and an <code>error</code> string.</li>
</ul>
<hr />
<h4 data-number="1.13.3.21"
id="debug-introspection-test_sensors-debug_sensors-test_location-debug_location-list_windows-debug_windows"><span
class="header-section-number">1.13.3.21</span> Debug / Introspection
(<code>test_sensors</code>, <code>debug_sensors</code>,
<code>test_location</code>, <code>debug_location</code>,
<code>list_windows</code>, <code>debug_windows</code>)</h4>
<p>These are dispatcher-level debug helpers.</p>
<h5 data-number="1.13.3.21.1"
id="sensors-test_sensors-debug_sensors"><span
class="header-section-number">1.13.3.21.1</span> Sensors
(<code>test_sensors</code>, <code>debug_sensors</code>)</h5>
<p>Top-level keys:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td><code>test_sensors</code> or <code>debug_sensors</code>.</td>
</tr>
</tbody>
</table>
<p>Behavior:</p>
<ul>
<li>Attempts to publish current sensor values via the normal sensor
publisher.</li>
<li>Responds on <code>kingkiosk/{device}/system/response</code> using
the unified response helper; success includes
<code>sensors_available: true|false</code>.</li>
</ul>
<h5 data-number="1.13.3.21.2"
id="location-test_location-debug_location"><span
class="header-section-number">1.13.3.21.2</span> Location
(<code>test_location</code>, <code>debug_location</code>)</h5>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td><code>test_location</code> or <code>debug_location</code>.</td>
</tr>
</tbody>
</table>
<p>Behavior:</p>
<ul>
<li>If sensors are unavailable (WASM mode), publishes an error
response.</li>
<li>Otherwise requests location permission and publishes direct sensor
topics:
<ul>
<li><code>kingkiosk/{device}/latitude</code> (retained)</li>
<li><code>kingkiosk/{device}/longitude</code> (retained)</li>
<li><code>kingkiosk/{device}/location_status</code> (retained)</li>
</ul></li>
</ul>
<h5 data-number="1.13.3.21.3"
id="window-list-list_windows-debug_windows"><span
class="header-section-number">1.13.3.21.3</span> Window list
(<code>list_windows</code>, <code>debug_windows</code>)</h5>
<p>Top-level keys:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td><code>list_windows</code> or <code>debug_windows</code>.</td>
</tr>
</tbody>
</table>
<p>Response:</p>
<ul>
<li>Publishes a success payload to
<code>kingkiosk/{device}/system/response</code> via the unified response
helper with:
<ul>
<li><code>window_count</code></li>
<li><code>windows</code> (visual tile list when available)</li>
<li><code>tiling_mode</code> (when available)</li>
<li><code>controller_count</code> and <code>controllers</code> (debug
listing)</li>
</ul></li>
</ul>
<p>Live updates:</p>
<ul>
<li>For always-on admin dashboards, prefer the retained window state
feed:
<ul>
<li>Snapshot: <code>kingkiosk/{device}/windows</code> (retained)</li>
<li>Events: <code>kingkiosk/{device}/windows/event</code>
(non-retained)</li>
<li>Diagnostics: <code>kingkiosk/{device}/diagnostics/windows</code>
(retained)</li>
</ul></li>
</ul>
<p>Each <code>windows[]</code> item includes:</p>
<ul>
<li><code>window_id</code>, <code>title</code>, <code>type</code>,
<code>url</code>, <code>image_urls</code></li>
<li><code>x</code>, <code>y</code>, <code>width</code>,
<code>height</code>, <code>opacity</code>, <code>z_index</code></li>
<li><code>loop</code>, <code>minimized</code>,
<code>maximized</code></li>
<li><code>mqtt_topic</code>, <code>mqtt_json_field</code>,
<code>mqtt_is_base64</code>, <code>mqtt_update_interval_ms</code></li>
<li><code>metadata</code></li>
</ul>
<hr />
<h4 data-number="1.13.3.22"
id="batch-script-batch-kill_batch_script-batch_status-wait"><span
class="header-section-number">1.13.3.22</span> Batch / Script
(<code>batch</code>, <code>kill_batch_script</code>,
<code>batch_status</code>, <code>wait</code>)</h4>
<p>The batch subsystem executes a sequence of commands.</p>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td><code>batch</code>, <code>kill_batch_script</code>,
<code>batch_status</code>, or <code>wait</code>.</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td><code>kingkiosk/{device}/system/response</code></td>
<td>Optional override; must remain within
<code>kingkiosk/{device}/...</code> and must not contain <code>#</code>,
<code>+</code>, or NUL.</td>
</tr>
</tbody>
</table>
<p><code>batch</code> keys:</p>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 35%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>commands</code></td>
<td>array</td>
<td>Required. Each item may be a JSON object (with its own
<code>command</code>) or a string.</td>
</tr>
</tbody>
</table>
<p><code>wait</code> step (in a batch) keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>seconds</code></td>
<td>number/string</td>
<td><code>1</code></td>
<td>Clamped to 0–300 seconds internally (milliseconds clamped to
0–300000).</td>
</tr>
</tbody>
</table>
<p>Standalone <code>wait</code> command keys:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>seconds</code></td>
<td>number/string</td>
<td><code>1</code></td>
<td>Must be <code>&gt; 0</code> and <code>&lt;= 300</code>.</td>
</tr>
</tbody>
</table>
<p>Notes:</p>
<ul>
<li><code>batch</code> does not currently publish an automatic
completion event; use per-command responses inside the batch (where
supported) or query <code>batch_status</code>.</li>
<li><code>batch_status</code> publishes
<code>{batch_running, batch_id, status, progress, total, kill_requested, ...}</code>.</li>
</ul>
<hr />
<h4 data-number="1.13.3.23"
id="screen-state-save_screen_state-load_screen_state-list_screen_states-delete_screen_state-export_screen_state-import_screen_state"><span
class="header-section-number">1.13.3.23</span> Screen State
(<code>save_screen_state</code>, <code>load_screen_state</code>,
<code>list_screen_states</code>, <code>delete_screen_state</code>,
<code>export_screen_state</code>, <code>import_screen_state</code>)</h4>
<p>These commands manage <strong>named saved layouts</strong> (window
tiles + layout settings).</p>
<p>All commands in this section support:</p>
<ul>
<li><code>response_topic</code> (optional): publish response to a custom
topic (defaults to <code>kingkiosk/{device}/system/response</code>)</li>
<li><code>correlation_id</code> (optional): echoed in the response when
provided</li>
</ul>
<p>Response shape:</p>
<p><code>{status, message, timestamp, state_name?, command?, correlation_id?, ...data}</code></p>
<h5 data-number="1.13.3.23.1" id="save_screen_state"><span
class="header-section-number">1.13.3.23.1</span>
<code>save_screen_state</code></h5>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>name</code></td>
<td>string</td>
<td>(required)</td>
<td>Screen state name.</td>
</tr>
<tr>
<td><code>overwrite</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>If false and the name exists, returns an error response.</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td>-</td>
<td>Optional response topic.</td>
</tr>
<tr>
<td><code>correlation_id</code></td>
<td>string</td>
<td>-</td>
<td>Optional request/response correlation id.</td>
</tr>
</tbody>
</table>
<p>Success response includes: <code>name</code>,
<code>windowCount</code>, <code>savedAt</code>.</p>
<h5 data-number="1.13.3.23.2" id="load_screen_state"><span
class="header-section-number">1.13.3.23.2</span>
<code>load_screen_state</code></h5>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 35%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>name</code></td>
<td>string</td>
<td>(required)</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td>Optional response topic.</td>
</tr>
<tr>
<td><code>correlation_id</code></td>
<td>string</td>
<td>Optional request/response correlation id.</td>
</tr>
</tbody>
</table>
<p>Success response includes: <code>name</code>,
<code>windowCount</code>, <code>savedAt</code>.</p>
<h5 data-number="1.13.3.23.3" id="list_screen_states"><span
class="header-section-number">1.13.3.23.3</span>
<code>list_screen_states</code></h5>
<p>Optional keys: <code>response_topic</code>,
<code>correlation_id</code>.</p>
<p>Success response includes:</p>
<ul>
<li><code>states</code>: list of
<code>{name, windowCount, savedAt}</code></li>
<li><code>count</code></li>
</ul>
<h5 data-number="1.13.3.23.4" id="delete_screen_state"><span
class="header-section-number">1.13.3.23.4</span>
<code>delete_screen_state</code></h5>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 35%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>name</code></td>
<td>string</td>
<td>(required)</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td>Optional response topic.</td>
</tr>
<tr>
<td><code>correlation_id</code></td>
<td>string</td>
<td>Optional request/response correlation id.</td>
</tr>
</tbody>
</table>
<h5 data-number="1.13.3.23.5" id="export_screen_state"><span
class="header-section-number">1.13.3.23.5</span>
<code>export_screen_state</code></h5>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 35%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>name</code></td>
<td>string</td>
<td>(required)</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td>Optional response topic.</td>
</tr>
<tr>
<td><code>correlation_id</code></td>
<td>string</td>
<td>Optional request/response correlation id.</td>
</tr>
</tbody>
</table>
<p>Success response includes: <code>name</code>,
<code>windowCount</code>, <code>savedAt</code>, <code>exportedAt</code>,
and <code>screen_state</code> (full exported object).</p>
<h5 data-number="1.13.3.23.6" id="import_screen_state"><span
class="header-section-number">1.13.3.23.6</span>
<code>import_screen_state</code></h5>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>name</code></td>
<td>string</td>
<td>(required)</td>
<td>Name to save the imported screen state as (overrides any name inside
the imported object).</td>
</tr>
<tr>
<td><code>screen_state</code></td>
<td>object</td>
<td>(required)</td>
<td>The exported screen state object (as produced by
<code>export_screen_state</code>).</td>
</tr>
<tr>
<td><code>overwrite</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>If false and the name exists, returns an error response.</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td>-</td>
<td>Optional response topic.</td>
</tr>
<tr>
<td><code>correlation_id</code></td>
<td>string</td>
<td>-</td>
<td>Optional request/response correlation id.</td>
</tr>
</tbody>
</table>
<hr />
<h4 data-number="1.13.3.24"
id="fleet-layout-replication-replicate_layout-subscribe_fleet-unsubscribe_fleet"><span
class="header-section-number">1.13.3.24</span> Fleet Layout Replication
(<code>replicate_layout</code>, <code>subscribe_fleet</code>,
<code>unsubscribe_fleet</code>)</h4>
<p>These commands publish/receive layout updates on a shared fleet
topic.</p>
<h5 data-number="1.13.3.24.1" id="replicate_layout"><span
class="header-section-number">1.13.3.24.1</span>
<code>replicate_layout</code></h5>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>fleet_id</code></td>
<td>string</td>
<td>-</td>
<td>Provide either <code>fleet_id</code> or
<code>target_topic</code>.</td>
</tr>
<tr>
<td><code>target_topic</code></td>
<td>string</td>
<td>-</td>
<td>If set, publishes there instead of the default fleet topic.</td>
</tr>
<tr>
<td><code>retain</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>If true, publishes the layout retained.</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td>-</td>
<td>Optional response topic for replication status.</td>
</tr>
<tr>
<td><code>correlation_id</code></td>
<td>string</td>
<td>-</td>
<td>Optional request/response correlation id.</td>
</tr>
</tbody>
</table>
<p>Publishes to:</p>
<ul>
<li>Default: <code>kingkiosk/fleet/{fleet_id}/layout</code></li>
<li>Or <code>target_topic</code> when provided.</li>
</ul>
<p>Published payload on the fleet topic:</p>
<p><code>{command:'apply_layout', source_device, replicated_at, fleet_id, layout, window_count}</code></p>
<h5 data-number="1.13.3.24.2" id="subscribe_fleet"><span
class="header-section-number">1.13.3.24.2</span>
<code>subscribe_fleet</code></h5>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>fleet_id</code></td>
<td>string</td>
<td>(required)</td>
<td>Fleet id to subscribe to.</td>
</tr>
<tr>
<td><code>auto_apply</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>If true, applies received layouts automatically.</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td>-</td>
<td>Optional response topic for subscription status.</td>
</tr>
<tr>
<td><code>correlation_id</code></td>
<td>string</td>
<td>-</td>
<td>Optional request/response correlation id.</td>
</tr>
</tbody>
</table>
<p>Subscribes to <code>kingkiosk/fleet/{fleet_id}/layout</code>.</p>
<h5 data-number="1.13.3.24.3" id="unsubscribe_fleet"><span
class="header-section-number">1.13.3.24.3</span>
<code>unsubscribe_fleet</code></h5>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 35%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>fleet_id</code></td>
<td>string</td>
<td>(required)</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td>Optional response topic for unsubscribe status.</td>
</tr>
<tr>
<td><code>correlation_id</code></td>
<td>string</td>
<td>Optional request/response correlation id.</td>
</tr>
</tbody>
</table>
<hr />
<h4 data-number="1.13.3.25"
id="screen-schedule-set_screen_schedule-list_screen_schedule-enable_screen_schedule-disable_screen_schedule-screen_schedule_status-trigger_screen_schedule"><span
class="header-section-number">1.13.3.25</span> Screen Schedule
(<code>set_screen_schedule</code>, <code>list_screen_schedule</code>,
<code>enable_screen_schedule</code>,
<code>disable_screen_schedule</code>,
<code>screen_schedule_status</code>,
<code>trigger_screen_schedule</code>)</h4>
<p>These commands manage a minimal time-based scheduler that applies
saved screen states.</p>
<p>All schedule responses publish to
<code>kingkiosk/{device}/system/response</code> with:</p>
<p><code>{type:'screen_schedule', status:'ok'|'error', message, timestamp, data?}</code></p>
<p><code>set_screen_schedule</code> keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td>array</td>
<td>(required)</td>
<td>List of schedule entries.</td>
</tr>
<tr>
<td><code>enabled</code></td>
<td>bool</td>
<td>(no override)</td>
<td>Optional. If present, overrides scheduler enabled state.</td>
</tr>
</tbody>
</table>
<p>Schedule entry schema:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>string</td>
<td>(auto)</td>
<td>If missing/empty, an id is auto-generated.</td>
</tr>
<tr>
<td><code>screen_state</code> / <code>screenState</code></td>
<td>string</td>
<td>(required)</td>
<td>Name of a saved screen state.</td>
</tr>
<tr>
<td><code>at</code></td>
<td>string</td>
<td>(required)</td>
<td>Local time in <code>HH:MM</code>.</td>
</tr>
<tr>
<td><code>days</code></td>
<td>array<int></td>
<td>(all days)</td>
<td>Optional. 1=Mon … 7=Sun.</td>
</tr>
<tr>
<td><code>enabled</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>-</td>
</tr>
</tbody>
</table>
<p><code>trigger_screen_schedule</code> keys:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>string</td>
<td>Optional. Triggers a specific entry.</td>
</tr>
<tr>
<td><code>screen_state</code></td>
<td>string</td>
<td>Optional. Triggers a specific state.</td>
</tr>
</tbody>
</table>
<hr />
<h4 data-number="1.13.3.26"
id="conflict-resolution-conflict_resolution"><span
class="header-section-number">1.13.3.26</span> Conflict Resolution
(<code>conflict_resolution</code>)</h4>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td>Must be <code>conflict_resolution</code>.</td>
</tr>
<tr>
<td><code>action</code></td>
<td>string</td>
<td>-</td>
<td><code>get_status</code>, <code>set_strategy</code>,
<code>clear</code>, <code>record_touch</code>.</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td><code>kingkiosk/{device}/system/response</code></td>
<td>-</td>
</tr>
</tbody>
</table>
<p><code>set_strategy</code> keys:</p>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 35%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>strategy</code></td>
<td>string</td>
<td>One of <code>touch_priority</code>, <code>mqtt_priority</code>,
<code>last_wins</code>, <code>queue</code>, <code>merge</code>.</td>
</tr>
<tr>
<td><code>touch_cooldown_ms</code></td>
<td>int/string</td>
<td>Optional.</td>
</tr>
<tr>
<td><code>mqtt_cooldown_ms</code></td>
<td>int/string</td>
<td>Optional.</td>
</tr>
<tr>
<td><code>log_conflicts</code></td>
<td>bool</td>
<td>Optional.</td>
</tr>
<tr>
<td><code>publish_notifications</code></td>
<td>bool</td>
<td>Optional.</td>
</tr>
</tbody>
</table>
<p><code>record_touch</code> keys:</p>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 35%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td>Optional. Records a touch interaction for a given window.</td>
</tr>
</tbody>
</table>
<hr />
<h3 data-number="1.13.4" id="map"><span
class="header-section-number">1.13.4</span> Map</h3>
<p><strong>Widget Type:</strong> <code>map</code></p>
<h4 data-number="1.13.4.1" id="createopen-system-command-open_map"><span
class="header-section-number">1.13.4.1</span> Create/Open (system
command: <code>open_map</code>)</h4>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td>Must be <code>open_map</code>.</td>
</tr>
<tr>
<td><code>title</code></td>
<td>string</td>
<td><code>Map</code></td>
<td>Window title.</td>
</tr>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td><code>map_{timestamp}</code></td>
<td>If omitted, a map ID is generated.</td>
</tr>
<tr>
<td><code>opacity</code></td>
<td>number</td>
<td><code>1.0</code></td>
<td>-</td>
</tr>
<tr>
<td><code>x</code>, <code>y</code>, <code>width</code>,
<code>height</code></td>
<td>number</td>
<td>-</td>
<td>Optional geometry.</td>
</tr>
<tr>
<td><code>provider</code></td>
<td>object</td>
<td>-</td>
<td>Tile provider configuration.</td>
</tr>
<tr>
<td><code>initial_camera</code></td>
<td>object</td>
<td>-</td>
<td>Initial map view.</td>
</tr>
<tr>
<td><code>interaction</code></td>
<td>object</td>
<td>-</td>
<td>Interaction switches.</td>
</tr>
<tr>
<td><code>correlation_id</code></td>
<td>string</td>
<td>-</td>
<td>Optional tracking id for response.</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td><code>kingkiosk/{device}/system/response</code></td>
<td>Override response topic.</td>
</tr>
</tbody>
</table>
<p>Provider config (<code>provider</code>) keys:</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>url_template</code></td>
<td>string</td>
<td><code>https://tile.openstreetmap.org/{z}/{x}/{y}.png</code></td>
<td>Tile URL template.</td>
</tr>
<tr>
<td><code>subdomains</code></td>
<td>array<string></td>
<td><code>[]</code></td>
<td>Used with <code>{s}</code> placeholder; ignored for OSM
template.</td>
</tr>
<tr>
<td><code>headers</code></td>
<td>object</td>
<td><code>{}</code></td>
<td>Extra HTTP headers for tile requests.</td>
</tr>
<tr>
<td><code>attribution</code></td>
<td>string</td>
<td><code>(c) OpenStreetMap contributors</code></td>
<td>Attribution text (shown on map).</td>
</tr>
</tbody>
</table>
<p>Notes: - If <code>url_template</code> uses
<code>https://{s}.tile.openstreetmap.org/...</code>, the
<code>{s}</code> subdomain portion is stripped and
<code>subdomains</code> are ignored to comply with OSM guidance. - Use
<code>close_window</code> on
<code>kingkiosk/{device_id}/system/cmd</code> to close the map
(<code>window_id</code> == <code>element_id</code>).</p>
<p>Initial camera (<code>initial_camera</code>) keys:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>lat</code></td>
<td>number</td>
<td><code>0.0</code></td>
<td>Latitude.</td>
</tr>
<tr>
<td><code>lon</code></td>
<td>number</td>
<td><code>0.0</code></td>
<td>Longitude.</td>
</tr>
<tr>
<td><code>zoom</code></td>
<td>number</td>
<td><code>1.0</code></td>
<td>Zoom level.</td>
</tr>
<tr>
<td><code>rotation</code></td>
<td>number</td>
<td><code>0.0</code></td>
<td>Rotation in degrees (0 = north-up).</td>
</tr>
</tbody>
</table>
<p>Interaction switches (<code>interaction</code>) keys:</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>touch_enabled</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>Enables local touch/gesture control.</td>
</tr>
<tr>
<td><code>remote_enabled</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>Enables MQTT element commands.</td>
</tr>
<tr>
<td><code>allow_user_drop_pins</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>Allows user taps to drop pins.</td>
</tr>
</tbody>
</table>
<h4 data-number="1.13.4.2" id="element-commands-1"><span
class="header-section-number">1.13.4.2</span> Element Commands</h4>
<p>Element commands are sent to
<code>kingkiosk/{device_id}/element/{element_id}/cmd</code> only if the
map widget registers with the element router.</p>
<p>If <code>interaction.remote_enabled</code> is <code>false</code>,
map-specific commands return an error response (except
<code>get_state</code>, which is handled by the common widget
mixin).</p>
<table>
<colgroup>
<col style="width: 26%" />
<col style="width: 35%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr>
<th>Command</th>
<th>Parameters</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>set_camera</code></td>
<td><code>camera</code>, optional <code>animate</code>,
<code>duration_ms</code></td>
<td>Move/rotate the map to a camera.
<code>animate</code>/<code>duration_ms</code> are accepted but currently
not used for animation.</td>
</tr>
<tr>
<td><code>fit_bounds</code></td>
<td><code>bounds</code>, optional <code>padding_px</code>,
<code>animate</code></td>
<td>Fit camera to bounds. <code>animate</code> currently not used.</td>
</tr>
<tr>
<td><code>configure</code></td>
<td><code>provider</code>, <code>initial_camera</code>,
<code>interaction</code></td>
<td>Update provider/interaction/camera settings.</td>
</tr>
<tr>
<td><code>add_pins</code></td>
<td><code>pins</code></td>
<td>Add pins (additive).</td>
</tr>
<tr>
<td><code>set_pins</code></td>
<td><code>pins</code></td>
<td>Replace all pins.</td>
</tr>
<tr>
<td><code>update_pins</code></td>
<td><code>pins</code></td>
<td>Partial update of existing pins by <code>pin_id</code>.</td>
</tr>
<tr>
<td><code>remove_pins</code></td>
<td><code>pin_ids</code> or <code>pins</code></td>
<td>Remove pins by id.</td>
</tr>
<tr>
<td><code>clear_pins</code></td>
<td>-</td>
<td>Remove all pins.</td>
</tr>
<tr>
<td><code>add_text</code></td>
<td><code>text</code> or <code>texts</code></td>
<td>Add text overlays (additive).</td>
</tr>
<tr>
<td><code>update_text</code></td>
<td><code>text</code> or <code>texts</code></td>
<td>Partial update of existing text overlays.</td>
</tr>
<tr>
<td><code>remove_text</code></td>
<td><code>text_ids</code> or <code>text</code>/<code>texts</code></td>
<td>Remove text overlays by id.</td>
</tr>
<tr>
<td><code>clear_text</code></td>
<td>-</td>
<td>Remove all text overlays.</td>
</tr>
<tr>
<td><code>get_state</code></td>
<td>-</td>
<td>Common widget command: returns current state.</td>
</tr>
</tbody>
</table>
<p>Camera schema (<code>camera</code>):</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>lat</code></td>
<td>number</td>
<td>Latitude.</td>
</tr>
<tr>
<td><code>lon</code></td>
<td>number</td>
<td>Longitude.</td>
</tr>
<tr>
<td><code>zoom</code></td>
<td>number</td>
<td>Zoom level.</td>
</tr>
<tr>
<td><code>rotation</code></td>
<td>number</td>
<td>Rotation in degrees.</td>
</tr>
</tbody>
</table>
<p>Bounds schema (<code>bounds</code>):</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>sw</code></td>
<td>object</td>
<td>South-west corner: <code>{ "lat": ..., "lon": ... }</code>.</td>
</tr>
<tr>
<td><code>ne</code></td>
<td>object</td>
<td>North-east corner: <code>{ "lat": ..., "lon": ... }</code>.</td>
</tr>
</tbody>
</table>
<p>Pin schema (<code>pins</code>):</p>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 35%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pin_id</code></td>
<td>string</td>
<td>Required identifier.</td>
</tr>
<tr>
<td><code>lat</code>, <code>lon</code></td>
<td>number</td>
<td>Required coordinates.</td>
</tr>
<tr>
<td><code>icon</code></td>
<td>object</td>
<td><code>{ "type": "url|asset|base64|default", "value": "...", "content_type": "image/png" }</code>.</td>
</tr>
<tr>
<td><code>size_px</code></td>
<td>object</td>
<td><code>{ "w": 32, "h": 32 }</code> (default 32x32).</td>
</tr>
<tr>
<td><code>anchor</code></td>
<td>object</td>
<td><code>{ "x": 0.5, "y": 1.0 }</code> (normalized).</td>
</tr>
<tr>
<td><code>z_index</code></td>
<td>int</td>
<td>Render order.</td>
</tr>
<tr>
<td><code>opacity</code></td>
<td>number</td>
<td><code>0.0</code> to <code>1.0</code>.</td>
</tr>
<tr>
<td><code>interactive</code></td>
<td>bool</td>
<td>Defaults to <code>true</code>.</td>
</tr>
<tr>
<td><code>metadata</code></td>
<td>object</td>
<td>Arbitrary JSON metadata.</td>
</tr>
</tbody>
</table>
<p>Text overlay schema (<code>text</code>/<code>texts</code>):</p>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 35%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>text_id</code></td>
<td>string</td>
<td>Required identifier.</td>
</tr>
<tr>
<td><code>text</code></td>
<td>string</td>
<td>Display text.</td>
</tr>
<tr>
<td><code>anchor_type</code></td>
<td>string</td>
<td><code>geo</code> or <code>screen</code>.</td>
</tr>
<tr>
<td><code>geo</code></td>
<td>object</td>
<td><code>{ "lat": ..., "lon": ... }</code> (for
<code>anchor_type: geo</code>).</td>
</tr>
<tr>
<td><code>screen</code></td>
<td>object</td>
<td><code>{ "x": 0.05, "y": 0.10 }</code> (normalized, for
<code>anchor_type: screen</code>).</td>
</tr>
<tr>
<td><code>z_index</code></td>
<td>int</td>
<td>Render order.</td>
</tr>
<tr>
<td><code>style</code></td>
<td>object</td>
<td>See style keys below.</td>
</tr>
<tr>
<td><code>interactive</code></td>
<td>bool</td>
<td>Defaults to <code>false</code>.</td>
</tr>
<tr>
<td><code>metadata</code></td>
<td>object</td>
<td>Arbitrary JSON metadata.</td>
</tr>
</tbody>
</table>
<p>Text style schema (<code>style</code>):</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>font_size_px</code></td>
<td>number</td>
<td><code>16.0</code></td>
<td>Font size in pixels.</td>
</tr>
<tr>
<td><code>font_weight</code></td>
<td>string</td>
<td><code>normal</code></td>
<td>Accepts <code>normal</code>, <code>bold</code>, <code>w300</code>,
<code>w500</code>, <code>w600</code>.</td>
</tr>
<tr>
<td><code>color</code></td>
<td>string</td>
<td><code>#FFFFFFFF</code></td>
<td>Text color.</td>
</tr>
<tr>
<td><code>background_color</code></td>
<td>string</td>
<td><code>#00000000</code></td>
<td>Background color.</td>
</tr>
<tr>
<td><code>padding_px</code></td>
<td>number</td>
<td><code>4.0</code></td>
<td>Padding around text.</td>
</tr>
<tr>
<td><code>corner_radius_px</code></td>
<td>number</td>
<td><code>4.0</code></td>
<td>Rounded corners.</td>
</tr>
</tbody>
</table>
<h4 data-number="1.13.4.3"
id="state-fields-published-on-element-state-topic"><span
class="header-section-number">1.13.4.3</span> State fields (published on
element state topic)</h4>
<div class="sourceCode" id="cb47"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;map&quot;</span><span class="fu">,</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;element_id&quot;</span><span class="fu">:</span> <span class="st">&quot;map-1&quot;</span><span class="fu">,</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;widget_id&quot;</span><span class="fu">:</span> <span class="st">&quot;map-1&quot;</span><span class="fu">,</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;camera&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;lat&quot;</span><span class="fu">:</span> <span class="fl">30.2672</span><span class="fu">,</span> <span class="dt">&quot;lon&quot;</span><span class="fu">:</span> <span class="fl">-97.7431</span><span class="fu">,</span> <span class="dt">&quot;zoom&quot;</span><span class="fu">:</span> <span class="fl">14.0</span><span class="fu">,</span> <span class="dt">&quot;rotation&quot;</span><span class="fu">:</span> <span class="fl">0.0</span> <span class="fu">},</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;counts&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;pins&quot;</span><span class="fu">:</span> <span class="dv">12</span><span class="fu">,</span> <span class="dt">&quot;text_overlays&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">},</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;interaction&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;touch_enabled&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span> <span class="dt">&quot;remote_enabled&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span> <span class="dt">&quot;allow_user_drop_pins&quot;</span><span class="fu">:</span> <span class="kw">false</span> <span class="fu">}</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h4 data-number="1.13.4.4" id="map-events"><span
class="header-section-number">1.13.4.4</span> Map Events</h4>
<p>Map-specific events are published on
<code>kingkiosk/{device_id}/element/{element_id}/event</code>:</p>
<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 66%" />
</colgroup>
<thead>
<tr>
<th>Event</th>
<th>Payload Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>camera_changed</code></td>
<td>Includes <code>camera</code>, <code>source</code>
(<code>touch</code> or <code>remote</code>), and <code>phase</code>
(<code>start</code>, <code>change</code>, <code>end</code>).</td>
</tr>
<tr>
<td><code>pin_selected</code></td>
<td>Includes <code>pin_id</code>, <code>lat</code>, <code>lon</code>,
and <code>metadata</code>.</td>
</tr>
<tr>
<td><code>pin_dropped</code></td>
<td>Emitted when <code>allow_user_drop_pins</code> is enabled and the
user taps the map.</td>
</tr>
<tr>
<td><code>text_selected</code></td>
<td>Includes <code>text_id</code>, <code>text</code>, and
<code>metadata</code> (only if <code>interactive</code> is true).</td>
</tr>
</tbody>
</table>
<hr />
<h3 data-number="1.13.5" id="canvas"><span
class="header-section-number">1.13.5</span> Canvas</h3>
<p><strong>Widget Type:</strong> <code>canvas</code></p>
<h4 data-number="1.13.5.1"
id="createopen-system-command-open_canvas"><span
class="header-section-number">1.13.5.1</span> Create/Open (system
command: <code>open_canvas</code>)</h4>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td>Must be <code>open_canvas</code>.</td>
</tr>
<tr>
<td><code>title</code></td>
<td>string</td>
<td><code>Canvas</code></td>
<td>Window title.</td>
</tr>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td><code>canvas_{timestamp}</code></td>
<td>If omitted, an ID is generated.</td>
</tr>
<tr>
<td><code>opacity</code></td>
<td>number</td>
<td><code>1.0</code></td>
<td>-</td>
</tr>
<tr>
<td><code>x</code>, <code>y</code>, <code>width</code>,
<code>height</code></td>
<td>number</td>
<td>-</td>
<td>Optional geometry.</td>
</tr>
<tr>
<td><code>doc</code></td>
<td>object</td>
<td>-</td>
<td>Canvas document (see below).</td>
</tr>
<tr>
<td><code>interaction</code></td>
<td>object</td>
<td>-</td>
<td>Interaction settings (see below). Overrides
<code>doc.interaction</code> if both provided.</td>
</tr>
<tr>
<td><code>persist</code></td>
<td>object</td>
<td>-</td>
<td>Persistence settings (see below).</td>
</tr>
<tr>
<td><code>background</code></td>
<td>object</td>
<td>-</td>
<td>Canvas background settings (see below). Overrides
<code>doc.background</code> if both provided.</td>
</tr>
<tr>
<td><code>grid</code></td>
<td>object</td>
<td>-</td>
<td>Grid settings (see below). Overrides <code>doc.grid</code> if both
provided.</td>
</tr>
<tr>
<td><code>viewport</code></td>
<td>object</td>
<td>-</td>
<td>Viewport settings (see below). Overrides <code>doc.viewport</code>
if both provided.</td>
</tr>
<tr>
<td><code>correlation_id</code></td>
<td>string</td>
<td>-</td>
<td>Optional tracking id for response.</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td><code>kingkiosk/{device}/system/response</code></td>
<td>Override response topic.</td>
</tr>
</tbody>
</table>
<p>Notes: - <code>window_id</code> is also used as
<code>element_id</code>/<code>widget_id</code> for element commands. -
Close with <code>close_window</code> on
<code>kingkiosk/{device_id}/system/cmd</code> using
<code>window_id</code>. - The canvas document schema is versioned by
<code>doc.spec</code> (currently <code>kingkiosk.canvas.v1</code>).</p>
<h4 data-number="1.13.5.2" id="canvas-document-doc"><span
class="header-section-number">1.13.5.2</span> Canvas Document
(<code>doc</code>)</h4>
<p>This widget uses a single <strong>document</strong> that contains the
full scene (objects + connections) and the view/config state.</p>
<p><code>doc</code> keys:</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>spec</code></td>
<td>string</td>
<td><code>kingkiosk.canvas.v1</code></td>
<td>Schema identifier.</td>
</tr>
<tr>
<td><code>canvas_id</code></td>
<td>string</td>
<td>-</td>
<td>Optional application-level id.</td>
</tr>
<tr>
<td><code>meta</code></td>
<td>object</td>
<td>-</td>
<td>Arbitrary metadata.</td>
</tr>
<tr>
<td><code>background</code></td>
<td>object</td>
<td>-</td>
<td>Background config (see below).</td>
</tr>
<tr>
<td><code>grid</code></td>
<td>object</td>
<td>-</td>
<td>Grid config (see below).</td>
</tr>
<tr>
<td><code>viewport</code></td>
<td>object</td>
<td>-</td>
<td>Viewport config (see below).</td>
</tr>
<tr>
<td><code>interaction</code></td>
<td>object</td>
<td>-</td>
<td>Interaction config (see below).</td>
</tr>
<tr>
<td><code>objects</code></td>
<td>array</td>
<td><code>[]</code></td>
<td>Canvas objects (see below).</td>
</tr>
<tr>
<td><code>connections</code></td>
<td>array</td>
<td><code>[]</code></td>
<td>Connections between objects (see below).</td>
</tr>
<tr>
<td><code>resources</code></td>
<td>object</td>
<td>-</td>
<td>Arbitrary JSON resource registry (currently
stored/pass-through).</td>
</tr>
</tbody>
</table>
<p>Background schema (<code>background</code>):</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>color</code></td>
<td>string</td>
<td><code>#00000000</code></td>
<td><code>#RRGGBB</code> or <code>#AARRGGBB</code>.</td>
</tr>
<tr>
<td><code>blur_px</code></td>
<td>number</td>
<td><code>0.0</code></td>
<td>Backdrop blur for the whole canvas.</td>
</tr>
<tr>
<td><code>image</code></td>
<td>object</td>
<td>-</td>
<td><code>{ "url": "..." }</code> or
<code>{ "asset_id": "..." }</code>.</td>
</tr>
</tbody>
</table>
<p>Grid schema (<code>grid</code>):</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>enabled</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>-</td>
</tr>
<tr>
<td><code>size_px</code></td>
<td>number</td>
<td><code>20.0</code></td>
<td>Grid step size in pixels.</td>
</tr>
<tr>
<td><code>color</code></td>
<td>string</td>
<td><code>#22FFFFFF</code></td>
<td>Grid line color.</td>
</tr>
</tbody>
</table>
<p>Viewport schema (<code>viewport</code>):</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>zoom</code></td>
<td>number</td>
<td><code>1.0</code></td>
<td>-</td>
</tr>
<tr>
<td><code>pan_x</code></td>
<td>number</td>
<td><code>0.0</code></td>
<td>-</td>
</tr>
<tr>
<td><code>pan_y</code></td>
<td>number</td>
<td><code>0.0</code></td>
<td>-</td>
</tr>
<tr>
<td><code>min_zoom</code></td>
<td>number</td>
<td>-</td>
<td>Optional clamp.</td>
</tr>
<tr>
<td><code>max_zoom</code></td>
<td>number</td>
<td>-</td>
<td>Optional clamp.</td>
</tr>
</tbody>
</table>
<p>Interaction schema (<code>interaction</code>):</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>touch_enabled</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>Enables local touch/drag interactions.</td>
</tr>
<tr>
<td><code>remote_enabled</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>Enables element-scoped MQTT commands (except
<code>get_state</code>).</td>
</tr>
<tr>
<td><code>edit_mode</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>Enables local dragging (with <code>touch_enabled</code>).</td>
</tr>
<tr>
<td><code>snap_to_grid</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>Enables snapping while dragging.</td>
</tr>
<tr>
<td><code>snap_px</code></td>
<td>number</td>
<td>-</td>
<td>If omitted, uses <code>grid.size_px</code>.</td>
</tr>
<tr>
<td><code>show_ports_in_view</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>Shows port markers on objects.</td>
</tr>
<tr>
<td><code>allow_add_objects</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>Reserved for future in-app add flows (currently not enforced for
MQTT).</td>
</tr>
<tr>
<td><code>allow_add_connections</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>Reserved for future in-app add flows (currently not enforced for
MQTT).</td>
</tr>
</tbody>
</table>
<p>Persist schema (<code>persist</code>):</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>enabled</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>Enables persistence in local storage.</td>
</tr>
<tr>
<td><code>key</code></td>
<td>string</td>
<td><code>{device}:{window_id}</code></td>
<td>Storage key (falls back to <code>{window_id}</code> if device id
unavailable).</td>
</tr>
<tr>
<td><code>restore_on_start</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>Restores the last saved document on start.</td>
</tr>
<tr>
<td><code>publish_on_restore</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>Publishes retained state after restore.</td>
</tr>
</tbody>
</table>
<h4 data-number="1.13.5.3" id="objects-objects"><span
class="header-section-number">1.13.5.3</span> Objects
(<code>objects</code>)</h4>
<p>Objects are positioned in <strong>canvas coordinates</strong>
(affected by <code>viewport.zoom/pan</code> in the renderer).</p>
<p>Common object keys:</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>object_id</code></td>
<td>string</td>
<td>(required)</td>
<td>Unique id.</td>
</tr>
<tr>
<td><code>type</code></td>
<td>string</td>
<td><code>node</code></td>
<td>One of: <code>node</code>, <code>text</code>, <code>shape</code>,
<code>image</code>, <code>embed</code>, <code>group</code>.</td>
</tr>
<tr>
<td><code>x</code>, <code>y</code></td>
<td>number</td>
<td><code>0.0</code></td>
<td>Top-left position.</td>
</tr>
<tr>
<td><code>width</code>, <code>height</code></td>
<td>number</td>
<td><code>0.0</code></td>
<td>Object size.</td>
</tr>
<tr>
<td><code>z_index</code></td>
<td>int</td>
<td><code>0</code></td>
<td>Render order (used when no explicit order is set).</td>
</tr>
<tr>
<td><code>visible</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>-</td>
</tr>
<tr>
<td><code>locked</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>Prevents local dragging.</td>
</tr>
<tr>
<td><code>rotation_deg</code></td>
<td>number</td>
<td><code>0.0</code></td>
<td>Rotation around object center.</td>
</tr>
<tr>
<td><code>style</code></td>
<td>object</td>
<td><code>{}</code></td>
<td>Styling keys (see below).</td>
</tr>
<tr>
<td><code>ports</code></td>
<td>array</td>
<td><code>[]</code></td>
<td>Optional port list (see below).</td>
</tr>
<tr>
<td><code>mqtt</code></td>
<td>object</td>
<td><code>{}</code></td>
<td>Optional tap → publish behavior (see below).</td>
</tr>
<tr>
<td><code>metadata</code></td>
<td>object</td>
<td><code>{}</code></td>
<td>Arbitrary metadata.</td>
</tr>
</tbody>
</table>
<p><code>style</code> keys currently used by the renderer: -
<code>color</code>: object background color (default: transparent for
<code>text</code>/<code>shape</code>, dark for others) -
<code>border_color</code>: outline color - <code>border_width</code>:
outline width - <code>fill_color</code>: (for <code>shape</code>) fill
color - <code>stroke_color</code>: (for <code>shape</code>) stroke
color</p>
<p>Tap → publish (<code>mqtt</code>) behavior:</p>
<p>If <code>mqtt.publish</code> is set, a local tap publishes to the
specified topic.</p>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 35%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>publish.topic</code></td>
<td>string</td>
<td>Target topic.</td>
</tr>
<tr>
<td><code>publish.payload</code></td>
<td>any</td>
<td>JSON object → publish as JSON; otherwise published as a string.</td>
</tr>
<tr>
<td><code>publish.retain</code></td>
<td>bool</td>
<td>Retained publish when <code>true</code>.</td>
</tr>
</tbody>
</table>
<p>Ports (<code>ports</code>) schema:</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>port_id</code></td>
<td>string</td>
<td>(required)</td>
<td>Port identifier.</td>
</tr>
<tr>
<td><code>pos</code></td>
<td>object</td>
<td>-</td>
<td>Either <code>{ "nx": 0..1, "ny": 0..1 }</code> or
<code>{ "edge": "north|south|east|west", "t": 0..1 }</code>.</td>
</tr>
<tr>
<td><code>kind</code></td>
<td>string</td>
<td>-</td>
<td>Optional label/typing (stored only).</td>
</tr>
<tr>
<td><code>label</code></td>
<td>string</td>
<td>-</td>
<td>Optional label (stored only).</td>
</tr>
<tr>
<td><code>style</code></td>
<td>object</td>
<td>-</td>
<td>Currently uses <code>style.color</code> for marker fill.</td>
</tr>
</tbody>
</table>
<p>Notes: - If <code>ports</code> is omitted/empty, the renderer uses
implicit ports: <code>north</code>, <code>south</code>,
<code>west</code>, <code>east</code>, <code>center</code>. - For
connections, if <code>port_id</code> is omitted (or does not match any
declared port), the renderer falls back to the object center (and also
supports the implicit port ids above).</p>
<p>Type-specific keys (stored on the object and used by the
renderer):</p>
<ul>
<li><code>type: node</code>
<ul>
<li><code>label</code> (string), <code>subtitle</code> (string)</li>
<li><code>icon</code> (object):
<code>{ "set": "material|sf", "name": "...", "color": "#AARRGGBB", "size_px": 24 }</code></li>
</ul></li>
<li><code>type: text</code>
<ul>
<li><code>text</code> (string)</li>
<li><code>font_size_px</code> (number, default <code>16</code>)</li>
<li><code>font_weight</code> (string:
<code>normal|bold|w300|w500|w600</code>)</li>
<li><code>color</code> (string: <code>#RRGGBB</code> or
<code>#AARRGGBB</code>)</li>
<li><code>align</code> (string: <code>left|center|right</code>)</li>
</ul></li>
<li><code>type: shape</code>
<ul>
<li><code>shape</code> (string:
<code>rect|round_rect|circle|line</code>)</li>
<li><code>corner_radius_px</code> (number, default <code>8</code>)</li>
<li><code>stroke_width_px</code> (number, default <code>2</code>)</li>
<li>Uses <code>style.fill_color</code> and
<code>style.stroke_color</code></li>
</ul></li>
<li><code>type: image</code>
<ul>
<li><code>source</code> (object): <code>{ "url": "..." }</code> or
<code>{ "asset_id": "..." }</code></li>
<li><code>fit</code> (string: <code>contain|cover|fill</code>, default
<code>contain</code>)</li>
<li><code>opacity</code> (number, default <code>1.0</code>)</li>
</ul></li>
<li><code>type: embed</code>
<ul>
<li><code>embed</code> (object):
<code>{ "widget_type": "gauge|chart|mqtt_button|mqtt_action_status", "id": "...", "config": { ... } }</code></li>
<li><code>config</code> is passed through to the embedded widget; see
the corresponding widget sections in this document.</li>
</ul></li>
<li><code>type: group</code>
<ul>
<li>No additional keys (renders as a transparent rectangle with a
border).</li>
</ul></li>
</ul>
<h4 data-number="1.13.5.4" id="connections-connections"><span
class="header-section-number">1.13.5.4</span> Connections
(<code>connections</code>)</h4>
<p>Common connection keys:</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>connection_id</code></td>
<td>string</td>
<td>(required)</td>
<td>Unique id.</td>
</tr>
<tr>
<td><code>from</code></td>
<td>object</td>
<td>(required)</td>
<td><code>{ "object_id": "...", "port_id": "..." }</code>
(<code>port_id</code> optional).</td>
</tr>
<tr>
<td><code>to</code></td>
<td>object</td>
<td>(required)</td>
<td><code>{ "object_id": "...", "port_id": "..." }</code>
(<code>port_id</code> optional).</td>
</tr>
<tr>
<td><code>style</code></td>
<td>object</td>
<td>-</td>
<td>Connection style (see below).</td>
</tr>
<tr>
<td><code>route</code></td>
<td>object</td>
<td>-</td>
<td>Connection routing (see below).</td>
</tr>
<tr>
<td><code>mqtt</code></td>
<td>object</td>
<td><code>{}</code></td>
<td>Reserved (stored only).</td>
</tr>
<tr>
<td><code>metadata</code></td>
<td>object</td>
<td><code>{}</code></td>
<td>Arbitrary metadata.</td>
</tr>
</tbody>
</table>
<p>Connection style schema (<code>style</code>):</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>color</code></td>
<td>string</td>
<td><code>#FFFFFFFF</code></td>
<td>Line color.</td>
</tr>
<tr>
<td><code>width_px</code></td>
<td>number</td>
<td><code>2.0</code></td>
<td>Line width.</td>
</tr>
<tr>
<td><code>dash</code></td>
<td>array</td>
<td><code>[]</code></td>
<td>Dash pattern list (alternating draw/gap lengths).</td>
</tr>
<tr>
<td><code>arrow</code></td>
<td>string</td>
<td><code>none</code></td>
<td><code>none</code>, <code>end</code>, <code>both</code>.</td>
</tr>
<tr>
<td><code>opacity</code></td>
<td>number</td>
<td><code>1.0</code></td>
<td>-</td>
</tr>
<tr>
<td><code>animated</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>Renders an animated flow (moving dashes/highlight).</td>
</tr>
<tr>
<td><code>animation_speed</code></td>
<td>int</td>
<td><code>3</code></td>
<td>Speed 1-5 (1=very slow at 0.3x, 2=0.6x, 3=1.0x, 4=1.5x, 5=very fast
at 2.0x). Clamped to [1,5].</td>
</tr>
</tbody>
</table>
<p>Connection route schema (<code>route</code>):</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>kind</code></td>
<td>string</td>
<td><code>auto</code></td>
<td>If <code>manual</code>, uses <code>points</code>.</td>
</tr>
<tr>
<td><code>mode</code></td>
<td>string</td>
<td><code>orthogonal</code></td>
<td><code>straight</code>, <code>curved</code>,
<code>orthogonal</code>.</td>
</tr>
<tr>
<td><code>points</code></td>
<td>array</td>
<td><code>[]</code></td>
<td>For <code>kind: manual</code>: list of
<code>{ "x": ..., "y": ... }</code>.</td>
</tr>
</tbody>
</table>
<h4 data-number="1.13.5.5" id="element-commands-2"><span
class="header-section-number">1.13.5.5</span> Element Commands</h4>
<p>Element commands are sent to
<code>kingkiosk/{device_id}/element/{element_id}/cmd</code> after the
widget is created/registered.</p>
<p>If <code>interaction.remote_enabled</code> is <code>false</code>,
canvas-specific commands return an error response (except
<code>get_state</code>, which is handled by the common widget
mixin).</p>
<table>
<colgroup>
<col style="width: 26%" />
<col style="width: 35%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr>
<th>Command</th>
<th>Parameters</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>configure</code></td>
<td>optional <code>interaction</code>, <code>background</code>,
<code>grid</code>, <code>viewport</code></td>
<td>Updates view/config settings (does not change
objects/connections).</td>
</tr>
<tr>
<td><code>set_document</code></td>
<td><code>doc</code></td>
<td>Replace entire document (objects + connections + configs).</td>
</tr>
<tr>
<td><code>apply_patch</code></td>
<td>optional <code>base_rev</code>, <code>ops[]</code></td>
<td>Apply a small patch to the document (see patch format below).</td>
</tr>
<tr>
<td><code>add_objects</code></td>
<td><code>objects</code></td>
<td>Add objects (additive).</td>
</tr>
<tr>
<td><code>set_objects</code></td>
<td><code>objects</code></td>
<td>Replace all objects.</td>
</tr>
<tr>
<td><code>update_objects</code></td>
<td><code>objects</code></td>
<td>Deep-merge object updates by <code>object_id</code>.</td>
</tr>
<tr>
<td><code>remove_objects</code></td>
<td><code>object_ids</code></td>
<td>Remove objects by id.</td>
</tr>
<tr>
<td><code>clear_objects</code></td>
<td>-</td>
<td>Remove all objects.</td>
</tr>
<tr>
<td><code>add_connections</code></td>
<td><code>connections</code></td>
<td>Add connections (additive).</td>
</tr>
<tr>
<td><code>set_connections</code></td>
<td><code>connections</code></td>
<td>Replace all connections.</td>
</tr>
<tr>
<td><code>update_connections</code></td>
<td><code>connections</code></td>
<td>Deep-merge connection updates by <code>connection_id</code>.</td>
</tr>
<tr>
<td><code>remove_connections</code></td>
<td><code>connection_ids</code></td>
<td>Remove connections by id.</td>
</tr>
<tr>
<td><code>clear_connections</code></td>
<td>-</td>
<td>Remove all connections.</td>
</tr>
<tr>
<td><code>get_state</code></td>
<td>-</td>
<td>Common widget command: returns current state.</td>
</tr>
</tbody>
</table>
<p>Patch format (<code>apply_patch</code>):</p>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 35%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>base_rev</code></td>
<td>int</td>
<td>Optional optimistic concurrency; if provided and mismatched, returns
<code>{status:"error", code:"rev_mismatch", current_rev}</code> and
publishes <code>event: patch_rejected</code>.</td>
</tr>
<tr>
<td><code>ops</code></td>
<td>array</td>
<td>List of operations (see below).</td>
</tr>
<tr>
<td><code>correlation_id</code></td>
<td>string</td>
<td>Optional; echoed in events.</td>
</tr>
</tbody>
</table>
<p>Patch operations (<code>ops[]</code>) are processed in order:</p>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 35%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>op</code></td>
<td>string</td>
<td><code>set</code>, <code>merge</code>, <code>delete</code>,
<code>reorder</code>.</td>
</tr>
<tr>
<td><code>path</code></td>
<td>string</td>
<td>JSON-pointer-like path,
e.g. <code>/objects/byId/{object_id}/x</code>.</td>
</tr>
<tr>
<td><code>value</code></td>
<td>any</td>
<td>For <code>set</code>/<code>merge</code>.</td>
</tr>
<tr>
<td><code>ids</code></td>
<td>array</td>
<td>For <code>reorder</code> only.</td>
</tr>
</tbody>
</table>
<p>Supported paths: - <code>/objects/byId/{object_id}</code> or
<code>/objects/byId/{object_id}/{field...}</code> -
<code>/connections/byId/{connection_id}</code> or
<code>/connections/byId/{connection_id}/{field...}</code> -
<code>/objects</code> with <code>op: reorder</code> and
<code>ids: ["obj1","obj2",...]</code> sets render order -
<code>/connections</code> with <code>op: reorder</code> and
<code>ids: ["c1","c2",...]</code> sets render order</p>
<h4 data-number="1.13.5.6"
id="state-fields-published-on-element-state-topic-1"><span
class="header-section-number">1.13.5.6</span> State fields (published on
element state topic)</h4>
<div class="sourceCode" id="cb48"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;canvas&quot;</span><span class="fu">,</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;element_id&quot;</span><span class="fu">:</span> <span class="st">&quot;canvas-1&quot;</span><span class="fu">,</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;widget_id&quot;</span><span class="fu">:</span> <span class="st">&quot;canvas-1&quot;</span><span class="fu">,</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;rev&quot;</span><span class="fu">:</span> <span class="dv">12</span><span class="fu">,</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;counts&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;objects&quot;</span><span class="fu">:</span> <span class="dv">7</span><span class="fu">,</span> <span class="dt">&quot;connections&quot;</span><span class="fu">:</span> <span class="dv">3</span> <span class="fu">},</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;interaction&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;touch_enabled&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span> <span class="dt">&quot;remote_enabled&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span> <span class="dt">&quot;edit_mode&quot;</span><span class="fu">:</span> <span class="kw">false</span> <span class="fu">},</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;doc&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;spec&quot;</span><span class="fu">:</span> <span class="st">&quot;kingkiosk.canvas.v1&quot;</span><span class="fu">,</span> <span class="dt">&quot;objects&quot;</span><span class="fu">:</span> <span class="ot">[]</span><span class="fu">,</span> <span class="dt">&quot;connections&quot;</span><span class="fu">:</span> <span class="ot">[]</span> <span class="fu">},</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;last_error&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;message&quot;</span><span class="fu">:</span> <span class="st">&quot;...&quot;</span> <span class="fu">}</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h4 data-number="1.13.5.7" id="canvas-events"><span
class="header-section-number">1.13.5.7</span> Canvas Events</h4>
<p>Canvas events are published on
<code>kingkiosk/{device_id}/element/{element_id}/event</code>:</p>
<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 46%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr>
<th>Event</th>
<th>Description</th>
<th>Fields</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>doc_changed</code></td>
<td>Document changed</td>
<td><code>rev</code>, <code>source</code></td>
</tr>
<tr>
<td><code>patch_applied</code></td>
<td>Patch accepted</td>
<td><code>rev</code>, optional <code>correlation_id</code></td>
</tr>
<tr>
<td><code>patch_rejected</code></td>
<td>Patch rejected</td>
<td><code>code</code>, <code>current_rev</code>, optional
<code>correlation_id</code></td>
</tr>
<tr>
<td><code>object_moved</code></td>
<td>Local drag interaction</td>
<td><code>object_id</code>, <code>phase</code>
(<code>start|change|end</code>), <code>x</code>, <code>y</code>,
<code>source</code> (<code>touch</code>)</td>
</tr>
</tbody>
</table>
<hr />
<h3 data-number="1.13.6" id="animated-text"><span
class="header-section-number">1.13.6</span> Animated Text</h3>
<p><strong>Widget Type:</strong> <code>animatedText</code></p>
<h4 data-number="1.13.6.1"
id="createopen-system-command-open_animated_text"><span
class="header-section-number">1.13.6.1</span> Create/Open (system
command: <code>open_animated_text</code>)</h4>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td>Must be <code>open_animated_text</code>.</td>
</tr>
<tr>
<td><code>title</code></td>
<td>string</td>
<td><code>Animated Text</code></td>
<td>Window title.</td>
</tr>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td><code>animated_text_{timestamp}</code></td>
<td>If omitted, an ID is generated.</td>
</tr>
<tr>
<td><code>opacity</code></td>
<td>number</td>
<td><code>1.0</code></td>
<td>-</td>
</tr>
<tr>
<td><code>x</code>, <code>y</code>, <code>width</code>,
<code>height</code></td>
<td>number</td>
<td>-</td>
<td>Optional geometry.</td>
</tr>
<tr>
<td><code>spec</code></td>
<td>object</td>
<td>-</td>
<td>Full animated text spec (see below).</td>
</tr>
<tr>
<td><code>text</code></td>
<td>string</td>
<td>-</td>
<td>Convenience: text content if you aren’t sending
<code>spec</code>.</td>
</tr>
<tr>
<td><code>segments</code></td>
<td>array</td>
<td>-</td>
<td>Optional rich text segments (overrides <code>text</code>).</td>
</tr>
<tr>
<td><code>layout</code></td>
<td>object</td>
<td>-</td>
<td>Layout config.</td>
</tr>
<tr>
<td><code>style</code></td>
<td>object</td>
<td>-</td>
<td>Text styling.</td>
</tr>
<tr>
<td><code>tokenization</code></td>
<td>object</td>
<td>-</td>
<td>Tokenization config.</td>
</tr>
<tr>
<td><code>timeline</code></td>
<td>object</td>
<td>-</td>
<td>Timeline config.</td>
</tr>
<tr>
<td><code>effects</code></td>
<td>array</td>
<td>-</td>
<td>Effect list.</td>
</tr>
<tr>
<td><code>audio</code></td>
<td>object</td>
<td>-</td>
<td>Audio config.</td>
</tr>
<tr>
<td><code>lod</code></td>
<td>object</td>
<td>-</td>
<td>LOD config.</td>
</tr>
<tr>
<td><code>mqtt</code></td>
<td>object</td>
<td>-</td>
<td>Stored in state; not used for auto-subscribe in current
implementation.</td>
</tr>
<tr>
<td><code>animation</code></td>
<td>object</td>
<td>-</td>
<td>Accepts <code>{ preset: "..." }</code> as shorthand.</td>
</tr>
<tr>
<td><code>preset</code></td>
<td>string</td>
<td>-</td>
<td>Preset name (see below).</td>
</tr>
<tr>
<td><code>id</code></td>
<td>string</td>
<td>-</td>
<td>Optional spec id.</td>
</tr>
<tr>
<td><code>correlation_id</code></td>
<td>string</td>
<td>-</td>
<td>Optional tracking id for response.</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td><code>kingkiosk/{device}/system/response</code></td>
<td>Override response topic.</td>
</tr>
</tbody>
</table>
<p>Notes: - <code>window_id</code> is also used as
<code>element_id</code>/<code>widget_id</code> for element commands. -
You can provide either a full <code>spec</code> object or top-level keys
(they are merged into the spec). - Close with <code>close_window</code>
on <code>kingkiosk/{device_id}/system/cmd</code> using
<code>window_id</code>.</p>
<h4 data-number="1.13.6.2" id="animated-text-spec-spec"><span
class="header-section-number">1.13.6.2</span> Animated Text Spec
(<code>spec</code>)</h4>
<p>This widget’s core configuration is a single <code>spec</code>
object. The system <code>open_animated_text</code> command accepts
either: - a full <code>spec</code> object (in <code>spec</code>), plus
optional top-level overrides, or - top-level spec fields without
<code>spec</code>.</p>
<p>Spec keys:</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>string</td>
<td><code>{window_id}</code></td>
<td>If omitted, falls back to the window id.</td>
</tr>
<tr>
<td><code>text</code></td>
<td>string</td>
<td><code>""</code></td>
<td>Plain text content (ignored when <code>segments</code> is
non-empty).</td>
</tr>
<tr>
<td><code>segments</code></td>
<td>array</td>
<td><code>[]</code></td>
<td>Rich segments (see below).</td>
</tr>
<tr>
<td><code>layout</code></td>
<td>object</td>
<td>-</td>
<td>Layout config (see below).</td>
</tr>
<tr>
<td><code>style</code></td>
<td>object</td>
<td>-</td>
<td>Base style (see below).</td>
</tr>
<tr>
<td><code>tokenization</code></td>
<td>object</td>
<td>-</td>
<td>Tokenization config (see below).</td>
</tr>
<tr>
<td><code>timeline</code></td>
<td>object</td>
<td>-</td>
<td>Timeline config (see below).</td>
</tr>
<tr>
<td><code>effects</code></td>
<td>array</td>
<td><code>[]</code></td>
<td>Effect stack (see below).</td>
</tr>
<tr>
<td><code>audio</code></td>
<td>object</td>
<td>-</td>
<td>Optional audio config (see below).</td>
</tr>
<tr>
<td><code>lod</code></td>
<td>object</td>
<td>-</td>
<td>Optional LOD config (see below).</td>
</tr>
<tr>
<td><code>mqtt</code></td>
<td>object</td>
<td>-</td>
<td>Stored in state; not auto-subscribed in current implementation.</td>
</tr>
<tr>
<td><code>preset</code></td>
<td>string</td>
<td>-</td>
<td>Preset name (applied at create time or via
<code>set_preset</code>).</td>
</tr>
</tbody>
</table>
<p>Segments schema (<code>segments[]</code>):</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>text</code></td>
<td>string</td>
<td><code>""</code></td>
<td>Segment content.</td>
</tr>
<tr>
<td><code>style</code></td>
<td>object</td>
<td><code>{}</code></td>
<td>Partial style patch applied only for this segment (same keys as
<code>style</code>).</td>
</tr>
</tbody>
</table>
<p>Layout schema (<code>layout</code>):</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>wrap</code></td>
<td>string</td>
<td><code>word</code></td>
<td>Controls line wrapping; set to <code>none</code> to disable
wrapping.</td>
</tr>
<tr>
<td><code>maxLines</code> / <code>max_lines</code></td>
<td>int</td>
<td>-</td>
<td>Max visible lines.</td>
</tr>
<tr>
<td><code>alignment</code></td>
<td>string</td>
<td><code>left</code></td>
<td><code>left</code>, <code>center</code>, <code>right</code>.</td>
</tr>
<tr>
<td><code>lineHeight</code> / <code>line_height</code></td>
<td>number</td>
<td><code>1.0</code></td>
<td>-</td>
</tr>
<tr>
<td><code>letterSpacing</code> / <code>letter_spacing</code></td>
<td>number</td>
<td><code>0.0</code></td>
<td>-</td>
</tr>
<tr>
<td><code>wordSpacing</code> / <code>word_spacing</code></td>
<td>number</td>
<td><code>0.0</code></td>
<td>-</td>
</tr>
<tr>
<td><code>overflow</code></td>
<td>string</td>
<td><code>clip</code></td>
<td>Stored only; renderer currently uses clipping.</td>
</tr>
</tbody>
</table>
<p>Style schema (<code>style</code>):</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>fontFamily</code> / <code>font_family</code></td>
<td>string</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td><code>fontSize</code> / <code>font_size</code></td>
<td>number</td>
<td><code>32.0</code></td>
<td>-</td>
</tr>
<tr>
<td><code>weight</code></td>
<td>string</td>
<td><code>600</code></td>
<td>Passed through to Flutter’s <code>FontWeight</code> parsing.</td>
</tr>
<tr>
<td><code>color</code></td>
<td>string</td>
<td><code>#FFFFFFFF</code></td>
<td><code>#RRGGBB</code> or <code>#AARRGGBB</code>.</td>
</tr>
<tr>
<td><code>stroke</code></td>
<td>object</td>
<td>-</td>
<td>See below.</td>
</tr>
<tr>
<td><code>shadow</code></td>
<td>object</td>
<td>-</td>
<td>See below.</td>
</tr>
</tbody>
</table>
<p>Stroke schema (<code>style.stroke</code>):</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>width</code></td>
<td>number</td>
<td><code>0.0</code></td>
<td>-</td>
</tr>
<tr>
<td><code>color</code></td>
<td>string</td>
<td><code>#00000000</code></td>
<td>Stroke color.</td>
</tr>
</tbody>
</table>
<p>Shadow schema (<code>style.shadow</code>):</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>blur</code></td>
<td>number</td>
<td><code>0.0</code></td>
<td>Blur radius.</td>
</tr>
<tr>
<td><code>dx</code></td>
<td>number</td>
<td><code>0.0</code></td>
<td>X offset.</td>
</tr>
<tr>
<td><code>dy</code></td>
<td>number</td>
<td><code>0.0</code></td>
<td>Y offset.</td>
</tr>
<tr>
<td><code>color</code></td>
<td>string</td>
<td><code>#00000000</code></td>
<td>Shadow color.</td>
</tr>
</tbody>
</table>
<p>Tokenization schema (<code>tokenization</code>):</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>mode</code></td>
<td>string</td>
<td><code>grapheme</code></td>
<td><code>grapheme</code>, <code>word</code>, <code>line</code>,
<code>segment</code>.</td>
</tr>
<tr>
<td><code>animateBy</code> / <code>animate_by</code></td>
<td>string</td>
<td><code>character</code></td>
<td>Stored only (not currently used).</td>
</tr>
<tr>
<td><code>preserveSpaces</code> / <code>preserve_spaces</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>When true, spaces become tokens and can animate.</td>
</tr>
<tr>
<td><code>rtl</code></td>
<td>string</td>
<td><code>auto</code></td>
<td>Stored only (not currently used).</td>
</tr>
</tbody>
</table>
<p>Timeline schema (<code>timeline</code>):</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>mode</code></td>
<td>string</td>
<td><code>once</code></td>
<td><code>once</code> or <code>loop</code>.</td>
</tr>
<tr>
<td><code>loopCount</code> / <code>loop_count</code></td>
<td>int</td>
<td><code>0</code></td>
<td>Stored only (not currently enforced).</td>
</tr>
<tr>
<td><code>direction</code></td>
<td>string</td>
<td><code>forward</code></td>
<td>Stored only (not currently enforced).</td>
</tr>
<tr>
<td><code>delayMs</code> / <code>delay_ms</code></td>
<td>int</td>
<td><code>0</code></td>
<td>Delay before effects start.</td>
</tr>
<tr>
<td><code>repeatDelayMs</code> / <code>repeat_delay_ms</code></td>
<td>int</td>
<td><code>0</code></td>
<td>Delay between loops.</td>
</tr>
</tbody>
</table>
<p>Effects schema (<code>effects[]</code>):</p>
<p>Common keys:</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>type</code></td>
<td>string</td>
<td><code>fade</code></td>
<td>See supported types below.</td>
</tr>
<tr>
<td><code>durationMs</code> / <code>duration_ms</code></td>
<td>int</td>
<td><code>500</code></td>
<td>-</td>
</tr>
<tr>
<td><code>startOffsetMs</code> / <code>start_offset_ms</code> /
<code>startOffset</code></td>
<td>int</td>
<td><code>0</code></td>
<td>-</td>
</tr>
<tr>
<td><code>easing</code></td>
<td>string</td>
<td><code>linear</code></td>
<td>Supported: <code>linear</code>, <code>easeOutCubic</code>,
<code>easeInOutCubic</code>, <code>easeOutBack</code>.</td>
</tr>
<tr>
<td><code>stagger</code></td>
<td>object</td>
<td>-</td>
<td><code>{ "by": "tokenIndex", "eachMs": 0 }</code> (alias:
<code>each_ms</code>). Only <code>eachMs</code> is used by the
renderer.</td>
</tr>
</tbody>
</table>
<p>Supported effect types: - <code>fade</code>: uses numeric
<code>from</code>/<code>to</code>
(<code>effect.from.opacity</code>/<code>effect.to.opacity</code> also
accepted). - <code>typewriter</code>: treated like <code>fade</code>
(typically paired with token staggering). - <code>slide</code>: uses
<code>from: {x,y}</code>, <code>to: {x,y}</code> in pixels. -
<code>scale</code>: uses numeric <code>from</code>/<code>to</code>. -
<code>colorize</code>: set <code>mode: "solidLerp"</code> with
<code>from</code>/<code>to</code> colors, or set
<code>mode: "paletteCycle"</code> with
<code>colors: ["#...","#..."]</code> for palette interpolation. -
<code>marquee</code>: scrolls the whole text group; uses
<code>speedPxPerSec</code> (default <code>90</code>), <code>gapPx</code>
(default <code>48</code>), and <code>direction</code>
(<code>left</code>/<code>right</code>).</p>
<p>Audio schema (<code>audio</code>):</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>enabled</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>-</td>
</tr>
<tr>
<td><code>mode</code></td>
<td>string</td>
<td><code>perCharacter</code></td>
<td>Stored only; the renderer emits at most one sound per token
step.</td>
</tr>
<tr>
<td><code>sound</code></td>
<td>string</td>
<td><code>notification</code></td>
<td>AudioService key.</td>
</tr>
<tr>
<td><code>volume</code></td>
<td>number</td>
<td><code>0.2</code></td>
<td>Stored only; AudioService implementation decides final mix.</td>
</tr>
<tr>
<td><code>rateLimit</code></td>
<td>object</td>
<td>-</td>
<td><code>{ "maxPerSecond": 12, "burst": 4 }</code> (alias:
<code>max_per_second</code> for <code>maxPerSecond</code>).</td>
</tr>
</tbody>
</table>
<p>LOD schema (<code>lod</code>):</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>maxGraphemes</code> / <code>max_graphemes</code></td>
<td>int</td>
<td><code>0</code></td>
<td>If &gt; 0 and the text exceeds this, the renderer falls back.</td>
</tr>
<tr>
<td><code>fallbackAnimateBy</code> /
<code>fallback_animate_by</code></td>
<td>string</td>
<td><code>word</code></td>
<td>Used as the fallback tokenization mode.</td>
</tr>
</tbody>
</table>
<p>MQTT schema (<code>mqtt</code>):</p>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 35%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>subscribe.textTopic</code> /
<code>subscribe.text_topic</code></td>
<td>string</td>
<td>Stored only.</td>
</tr>
<tr>
<td><code>subscribe.styleTopic</code> /
<code>subscribe.style_topic</code></td>
<td>string</td>
<td>Stored only.</td>
</tr>
<tr>
<td><code>subscribe.effectTopic</code> /
<code>subscribe.effect_topic</code></td>
<td>string</td>
<td>Stored only.</td>
</tr>
<tr>
<td><code>subscribe.triggerTopic</code> /
<code>subscribe.trigger_topic</code></td>
<td>string</td>
<td>Stored only.</td>
</tr>
<tr>
<td><code>publish.eventsTopic</code> /
<code>publish.events_topic</code></td>
<td>string</td>
<td>Stored only.</td>
</tr>
</tbody>
</table>
<p>Background decoration keys (not part of <code>spec</code>, stored on
the tile metadata):</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>background_mode</code></td>
<td>string</td>
<td><code>color</code></td>
<td><code>transparent</code>, <code>color</code>, <code>gradient</code>,
<code>image</code>.</td>
</tr>
<tr>
<td><code>background_color</code></td>
<td>string</td>
<td><code>#000000</code></td>
<td>Base color for <code>color</code>/<code>gradient</code>.</td>
</tr>
<tr>
<td><code>background_opacity</code></td>
<td>number</td>
<td><code>0.8</code></td>
<td>Clamped to <code>0.0</code>–<code>1.0</code>.</td>
</tr>
<tr>
<td><code>background_image_url</code></td>
<td>string</td>
<td>-</td>
<td>Used when <code>background_mode: image</code>.</td>
</tr>
</tbody>
</table>
<h4 data-number="1.13.6.3" id="element-commands-3"><span
class="header-section-number">1.13.6.3</span> Element Commands</h4>
<p>Element commands are sent to
<code>kingkiosk/{device_id}/element/{element_id}/cmd</code> after the
widget is created/registered.</p>
<table>
<colgroup>
<col style="width: 26%" />
<col style="width: 35%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr>
<th>Command</th>
<th>Parameters</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>configure</code></td>
<td>any spec fields</td>
<td>Replaces the entire spec from the payload (missing fields fall back
to defaults). Prefer <code>set_*</code> commands for targeted
updates.</td>
</tr>
<tr>
<td><code>set_text</code></td>
<td><code>text</code></td>
<td>Replace text content.</td>
</tr>
<tr>
<td><code>set_segments</code></td>
<td><code>segments</code></td>
<td>Replace segment list.</td>
</tr>
<tr>
<td><code>set_style</code></td>
<td><code>style</code></td>
<td>Replace text style.</td>
</tr>
<tr>
<td><code>set_layout</code></td>
<td><code>layout</code></td>
<td>Replace layout config.</td>
</tr>
<tr>
<td><code>set_tokenization</code></td>
<td><code>tokenization</code></td>
<td>Replace tokenization config.</td>
</tr>
<tr>
<td><code>set_timeline</code></td>
<td><code>timeline</code></td>
<td>Replace timeline config.</td>
</tr>
<tr>
<td><code>set_effects</code></td>
<td><code>effects</code></td>
<td>Replace effects list.</td>
</tr>
<tr>
<td><code>set_audio</code></td>
<td><code>audio</code></td>
<td>Replace audio config.</td>
</tr>
<tr>
<td><code>set_preset</code></td>
<td><code>preset</code></td>
<td>Apply a preset (see below).</td>
</tr>
<tr>
<td><code>trigger</code></td>
<td>optional <code>source</code></td>
<td>Restarts animation sequence and publishes
<code>event: play</code>.</td>
</tr>
</tbody>
</table>
<p>Preset names currently supported: - <code>typewriterShimmer</code> -
<code>neonPulse</code> - <code>bounceCascade</code> -
<code>alertFlash</code> - <code>tickerMarquee</code></p>
<h4 data-number="1.13.6.4"
id="state-fields-published-on-element-state-topic-2"><span
class="header-section-number">1.13.6.4</span> State fields (published on
element state topic)</h4>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>type</code></td>
<td>string</td>
<td><code>animatedText</code></td>
</tr>
<tr>
<td><code>element_id</code></td>
<td>string</td>
<td>Same as window_id.</td>
</tr>
<tr>
<td><code>widget_id</code></td>
<td>string</td>
<td>Same as window_id.</td>
</tr>
<tr>
<td><code>spec</code></td>
<td>object</td>
<td>Full animated text spec currently applied.</td>
</tr>
</tbody>
</table>
<h4 data-number="1.13.6.5" id="animated-text-events"><span
class="header-section-number">1.13.6.5</span> Animated Text Events</h4>
<p>Standard widget lifecycle events apply (<code>created</code>,
<code>closed</code>, <code>error</code>). This widget also
publishes:</p>
<table>
<thead>
<tr>
<th>Event</th>
<th>Description</th>
<th>Fields</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>doc_changed</code></td>
<td>Spec updated via MQTT</td>
<td><code>source</code></td>
</tr>
<tr>
<td><code>play</code></td>
<td>Triggered animation restart</td>
<td><code>source</code></td>
</tr>
</tbody>
</table>
<h3 data-number="1.13.7" id="clock"><span
class="header-section-number">1.13.7</span> Clock</h3>
<p><strong>Widget Type:</strong> <code>clock</code></p>
<h4 data-number="1.13.7.1"
id="createopen-system-command-open_clock"><span
class="header-section-number">1.13.7.1</span> Create/Open (system
command: <code>open_clock</code>)</h4>
<p>Top-level keys:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td>Must be <code>open_clock</code>.</td>
</tr>
<tr>
<td><code>title</code></td>
<td>string</td>
<td><code>Analog Clock</code></td>
<td>Window title.</td>
</tr>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td>(auto)</td>
<td>If provided, creates with that ID.</td>
</tr>
<tr>
<td><code>opacity</code></td>
<td>number</td>
<td><code>1.0</code></td>
<td>-</td>
</tr>
<tr>
<td><code>x</code>, <code>y</code>, <code>width</code>,
<code>height</code></td>
<td>number</td>
<td>-</td>
<td>Optional geometry.</td>
</tr>
<tr>
<td><code>mode</code></td>
<td>string</td>
<td>-</td>
<td><code>analog</code> or <code>digital</code>.</td>
</tr>
<tr>
<td><code>image_url</code></td>
<td>string</td>
<td>-</td>
<td>Network image URL.</td>
</tr>
<tr>
<td><code>theme</code></td>
<td>string</td>
<td>-</td>
<td><code>auto</code>, <code>light</code>, <code>dark</code>.</td>
</tr>
<tr>
<td><code>show_numbers</code></td>
<td>bool/string</td>
<td>-</td>
<td>Truthy values accepted.</td>
</tr>
<tr>
<td><code>show_second_hand</code></td>
<td>bool/string</td>
<td>-</td>
<td>Truthy values accepted.</td>
</tr>
</tbody>
</table>
<h4 data-number="1.13.7.2" id="element-commands-4"><span
class="header-section-number">1.13.7.2</span> Element Commands</h4>
<p>This widget may optionally support element-scoped commands on
<code>kingkiosk/{device_id}/element/{element_id}/cmd</code> <strong>only
if it registers</strong> a handler with
<code>MqttWidgetRouter.registerWidget(...)</code>.</p>
<p>Clock configuration keys (used by <code>open_clock</code>):</p>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 35%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>mode</code></td>
<td>string</td>
<td><code>analog</code> or <code>digital</code>.</td>
</tr>
<tr>
<td><code>image_url</code></td>
<td>string</td>
<td>Sets <code>network_image_url</code>.</td>
</tr>
<tr>
<td><code>show_numbers</code></td>
<td>bool/string</td>
<td>Truthy values accepted.</td>
</tr>
<tr>
<td><code>show_second_hand</code></td>
<td>bool/string</td>
<td>Truthy values accepted.</td>
</tr>
<tr>
<td><code>theme</code></td>
<td>string</td>
<td>-</td>
</tr>
<tr>
<td><code>background_mode</code></td>
<td>string</td>
<td>One of: <code>transparent</code>, <code>gradient</code>,
<code>color</code>, <code>image</code>.</td>
</tr>
<tr>
<td><code>background_color</code></td>
<td>string</td>
<td><code>#RRGGBB</code> or <code>#AARRGGBB</code>.</td>
</tr>
<tr>
<td><code>background_opacity</code></td>
<td>number/string</td>
<td>Clamped to <code>0.0</code>–<code>1.0</code>.</td>
</tr>
<tr>
<td><code>background_image_url</code></td>
<td>string</td>
<td>-</td>
</tr>
<tr>
<td><code>visible</code></td>
<td>bool</td>
<td>-</td>
</tr>
</tbody>
</table>
<h4 data-number="1.13.7.3"
id="element-commands-topic-kingkioskdevice_idelementelement_idcmd"><span
class="header-section-number">1.13.7.3</span> Element Commands (topic:
<code>kingkiosk/{device_id}/element/{element_id}/cmd</code>)</h4>
<p>Clock currently implements element commands via the per-element
router.</p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Parameters</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>set_mode</code></td>
<td><code>mode</code></td>
<td>Set display mode.</td>
</tr>
<tr>
<td><code>toggle_mode</code></td>
<td>-</td>
<td>Toggle analog/digital.</td>
</tr>
<tr>
<td><code>configure</code></td>
<td>see <code>configure</code> keys above</td>
<td>Configure appearance.</td>
</tr>
<tr>
<td><code>minimize</code></td>
<td>-</td>
<td>Minimize/hide.</td>
</tr>
<tr>
<td><code>maximize</code> / <code>restore</code></td>
<td>-</td>
<td>Restore.</td>
</tr>
<tr>
<td><code>close</code></td>
<td>-</td>
<td>Close.</td>
</tr>
</tbody>
</table>
<h4 data-number="1.13.7.4"
id="state-fields-published-on-element-widget-state-topics"><span
class="header-section-number">1.13.7.4</span> State fields (published on
element + widget state topics)</h4>
<div class="sourceCode" id="cb49"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;clock&quot;</span><span class="fu">,</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;element_id&quot;</span><span class="fu">:</span> <span class="st">&quot;clock-1&quot;</span><span class="fu">,</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;widget_id&quot;</span><span class="fu">:</span> <span class="st">&quot;clock-1&quot;</span><span class="fu">,</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;mode&quot;</span><span class="fu">:</span> <span class="st">&quot;analog&quot;</span><span class="fu">,</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;visible&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;minimized&quot;</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;show_numbers&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;show_second_hand&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;theme&quot;</span><span class="fu">:</span> <span class="st">&quot;auto&quot;</span><span class="fu">,</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;background_mode&quot;</span><span class="fu">:</span> <span class="st">&quot;transparent&quot;</span><span class="fu">,</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;background_opacity&quot;</span><span class="fu">:</span> <span class="fl">0.6</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<hr />
<h3 data-number="1.13.8" id="weather-openweather"><span
class="header-section-number">1.13.8</span> Weather (OpenWeather)</h3>
<p><strong>Widget Type:</strong> <code>weather</code></p>
<h4 data-number="1.13.8.1"
id="createopen-system-command-open_weather_client"><span
class="header-section-number">1.13.8.1</span> Create/Open (system
command: <code>open_weather_client</code>)</h4>
<p>Top-level keys used:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td>Must be <code>open_weather_client</code>.</td>
</tr>
<tr>
<td><code>name</code></td>
<td>string</td>
<td><code>Weather</code></td>
<td>Window title.</td>
</tr>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td>(auto)</td>
<td>-</td>
</tr>
<tr>
<td><code>opacity</code></td>
<td>number</td>
<td><code>1.0</code></td>
<td>-</td>
</tr>
<tr>
<td><code>x</code>, <code>y</code>, <code>width</code>,
<code>height</code></td>
<td>number</td>
<td>-</td>
<td>Optional geometry.</td>
</tr>
<tr>
<td><code>api_key</code></td>
<td>string</td>
<td>-</td>
<td>OpenWeather API key.</td>
</tr>
<tr>
<td><code>location</code></td>
<td>string</td>
<td>-</td>
<td>City name (alternative to coordinates).</td>
</tr>
<tr>
<td><code>units</code></td>
<td>string</td>
<td><code>imperial</code></td>
<td><code>metric</code>, <code>imperial</code>, or
<code>standard</code>.</td>
</tr>
<tr>
<td><code>language</code></td>
<td>string</td>
<td><code>en</code></td>
<td>Controller maps: <code>en</code>, <code>de</code>, <code>fr</code>,
<code>es</code>, <code>it</code>; others default to
<code>en</code>.</td>
</tr>
<tr>
<td><code>show_forecast</code></td>
<td>bool/string/int</td>
<td><code>false</code></td>
<td>Accepts <code>true/false</code>, <code>"true"/"false"</code>,
<code>"yes"/"on"</code>, <code>1/0</code>.</td>
</tr>
<tr>
<td><code>auto_refresh</code></td>
<td>bool/int</td>
<td><code>true</code></td>
<td>If int &gt; 0, treated as refresh interval seconds.</td>
</tr>
<tr>
<td><code>refresh_interval</code></td>
<td>int/string</td>
<td><code>3600</code> (default)</td>
<td>Parsed as int; controller fallback is <code>300</code> if parse
fails.</td>
</tr>
</tbody>
</table>
<h4 data-number="1.13.8.2" id="element-commands-5"><span
class="header-section-number">1.13.8.2</span> Element Commands</h4>
<p>Element-scoped commands on
<code>kingkiosk/{device_id}/element/{element_id}/cmd</code>:</p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Parameters</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>configure</code></td>
<td>Any config keys below</td>
<td>Update widget configuration.</td>
</tr>
<tr>
<td><code>refresh</code></td>
<td>-</td>
<td>Force a weather data refresh.</td>
</tr>
<tr>
<td><code>toggle_forecast</code></td>
<td>-</td>
<td>Toggle forecast panel visibility.</td>
</tr>
<tr>
<td><code>set_location</code></td>
<td><code>location</code> (string)</td>
<td>Change weather location.</td>
</tr>
<tr>
<td><code>hide</code></td>
<td>-</td>
<td>Hide the widget.</td>
</tr>
<tr>
<td><code>show</code></td>
<td>-</td>
<td>Show the widget.</td>
</tr>
</tbody>
</table>
<p>Weather configuration keys (used by <code>open_weather_client</code>
and <code>configure</code>):</p>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 35%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>api_key</code></td>
<td>string</td>
<td>Required for fetching.</td>
</tr>
<tr>
<td><code>location</code></td>
<td>string</td>
<td>City name.</td>
</tr>
<tr>
<td><code>latitude</code>, <code>longitude</code></td>
<td>number/string</td>
<td>Coordinate alternative.</td>
</tr>
<tr>
<td><code>units</code></td>
<td>string</td>
<td><code>metric</code>, <code>imperial</code>, <code>standard</code>
(default: <code>imperial</code>).</td>
</tr>
<tr>
<td><code>language</code></td>
<td>string</td>
<td>Mapped set; defaults to <code>en</code>.</td>
</tr>
<tr>
<td><code>show_forecast</code></td>
<td>bool/string/int</td>
<td>Accepts <code>true/false</code>, <code>"true"/"false"</code>,
<code>1/0</code>.</td>
</tr>
<tr>
<td><code>auto_refresh</code></td>
<td>bool/int</td>
<td>If int &gt; 0, also sets refresh interval seconds.</td>
</tr>
<tr>
<td><code>refresh_interval</code></td>
<td>int/string</td>
<td>Parsed int; default fallback <code>300</code>.</td>
</tr>
<tr>
<td><code>allow_bad_cert</code></td>
<td>bool/string/int</td>
<td>DEV ONLY. Accepts <code>true/false</code>,
<code>"true"/"false"</code>, <code>"yes"/"on"</code>,
<code>1/0</code>.</td>
</tr>
</tbody>
</table>
<p>Note: <code>latitude</code>, <code>longitude</code>, and
<code>allow_bad_cert</code> are only processed via element-level
<code>configure</code> commands; they are <strong>not</strong> passed
through the <code>open_weather_client</code> system command handler.</p>
<hr />
<h3 data-number="1.13.9" id="alarmo"><span
class="header-section-number">1.13.9</span> Alarmo</h3>
<p><strong>Widget Type:</strong> <code>alarmo</code></p>
<h4 data-number="1.13.9.1"
id="createopen-system-command-alarmo-alarmo_widget"><span
class="header-section-number">1.13.9.1</span> Create/Open (system
command: <code>alarmo</code> / <code>alarmo_widget</code>)</h4>
<p>Top-level keys used:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td><code>alarmo</code> or <code>alarmo_widget</code>.</td>
</tr>
<tr>
<td><code>name</code></td>
<td>string</td>
<td><code>Alarmo</code></td>
<td>Window title.</td>
</tr>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td>(auto)</td>
<td>-</td>
</tr>
<tr>
<td><code>opacity</code></td>
<td>number</td>
<td><code>1.0</code></td>
<td>-</td>
</tr>
<tr>
<td><code>x</code>, <code>y</code>, <code>width</code>,
<code>height</code></td>
<td>number</td>
<td>-</td>
<td>Optional geometry.</td>
</tr>
<tr>
<td><code>entity</code></td>
<td>string</td>
<td>-</td>
<td>Home Assistant entity id.</td>
</tr>
<tr>
<td><code>require_code</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>Legacy shorthand — sets both <code>require_code_to_arm</code>
<strong>and</strong> <code>require_code_to_disarm</code>.</td>
</tr>
<tr>
<td><code>require_code_to_arm</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>Whether a PIN is required for <strong>arming</strong>. Overrides
<code>require_code</code>.</td>
</tr>
<tr>
<td><code>require_code_to_disarm</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>Whether a PIN is required for <strong>disarming</strong>. Overrides
<code>require_code</code>.</td>
</tr>
<tr>
<td><code>code_required_modes</code></td>
<td>object</td>
<td><code>{}</code></td>
<td>Per-mode override map,
e.g. <code>{"away": true, "home": false}</code>. Keys are mode names
(<code>away</code>, <code>home</code>, <code>night</code>,
<code>vacation</code>, <code>custom</code>). When a mode is present in
this map its value takes precedence over
<code>require_code_to_arm</code>.</td>
</tr>
<tr>
<td><code>code_length</code></td>
<td>int</td>
<td><code>4</code></td>
<td>PIN digit count.</td>
</tr>
<tr>
<td><code>mqtt_base_topic</code></td>
<td>string</td>
<td><code>"alarmo"</code></td>
<td>Used by controller to construct state/command/event topics.</td>
</tr>
<tr>
<td><code>state_topic</code> / <code>command_topic</code> /
<code>event_topic</code></td>
<td>string</td>
<td>legacy</td>
<td>Accepted by create handler for backward compatibility.</td>
</tr>
<tr>
<td><code>area</code></td>
<td>string</td>
<td>optional</td>
<td>For multi-area Alarmo. Slug format (lowercase, underscores).</td>
</tr>
<tr>
<td><code>available_modes</code></td>
<td>array</td>
<td><code>["armed_away"]</code></td>
<td>Strings like <code>armed_away</code>, <code>armed_home</code>,
<code>armed_night</code>, <code>armed_vacation</code>,
<code>armed_custom_bypass</code>.</td>
</tr>
<tr>
<td><code>auto_recovery</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>Enables auto recovery on arm failure.</td>
</tr>
<tr>
<td><code>force</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>Default state for “force arm” (bypass open sensors). Can be toggled
in the UI.</td>
</tr>
<tr>
<td><code>skip_delay</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>Default state for “skip exit delay”. Can be toggled in the UI.</td>
</tr>
</tbody>
</table>
<h4 data-number="1.13.9.2" id="element-commands-6"><span
class="header-section-number">1.13.9.2</span> Element Commands</h4>
<p>Element-scoped commands on
<code>kingkiosk/{device_id}/element/{element_id}/cmd</code>:</p>
<table>
<colgroup>
<col style="width: 26%" />
<col style="width: 35%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr>
<th>Command</th>
<th>Parameters</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>configure</code></td>
<td>Any config keys below</td>
<td>Update widget configuration.</td>
</tr>
<tr>
<td><code>arm</code></td>
<td><code>mode</code> (string, e.g. <code>away</code>), optional
<code>code</code> (string), optional <code>force</code> (bool), optional
<code>skip_delay</code> (bool)</td>
<td>Arm the alarm. <code>force</code> bypasses open sensors;
<code>skip_delay</code> skips exit delay.</td>
</tr>
<tr>
<td><code>disarm</code></td>
<td>optional <code>code</code> (string)</td>
<td>Disarm the alarm.</td>
</tr>
<tr>
<td><code>set_force</code> / <code>force_arm</code></td>
<td><code>value</code> (bool)</td>
<td>Enable/disable force arm toggle.</td>
</tr>
<tr>
<td><code>set_skip_delay</code> / <code>skip_delay</code></td>
<td><code>value</code> (bool)</td>
<td>Enable/disable skip delay toggle.</td>
</tr>
<tr>
<td><code>minimize</code></td>
<td>—</td>
<td>Minimize the window.</td>
</tr>
<tr>
<td><code>maximize</code> / <code>restore</code></td>
<td>—</td>
<td>Restore the window.</td>
</tr>
<tr>
<td><code>close</code></td>
<td>—</td>
<td>Close the window.</td>
</tr>
</tbody>
</table>
<p>Alarmo configuration keys (used by <code>alarmo</code> /
<code>alarmo_widget</code> create/open):</p>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 35%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entity</code></td>
<td>string</td>
<td>Home Assistant entity id.</td>
</tr>
<tr>
<td><code>require_code</code></td>
<td>bool</td>
<td>Legacy shorthand — sets both arm and disarm code requirement.</td>
</tr>
<tr>
<td><code>require_code_to_arm</code></td>
<td>bool</td>
<td>Overrides <code>require_code</code> for arming.</td>
</tr>
<tr>
<td><code>require_code_to_disarm</code></td>
<td>bool</td>
<td>Overrides <code>require_code</code> for disarming.</td>
</tr>
<tr>
<td><code>code_required_modes</code></td>
<td>object</td>
<td>Per-mode override map,
e.g. <code>{"away": true, "home": false}</code>.</td>
</tr>
<tr>
<td><code>code_length</code></td>
<td>int</td>
<td>PIN digit count (default 4).</td>
</tr>
<tr>
<td><code>mqtt_base_topic</code></td>
<td>string</td>
<td>Base topic (default <code>alarmo</code>).</td>
</tr>
<tr>
<td><code>area</code></td>
<td>string</td>
<td>Area name for multi-area setups.</td>
</tr>
<tr>
<td><code>auto_recovery</code></td>
<td>bool</td>
<td>Enable auto recovery on failure.</td>
</tr>
<tr>
<td><code>available_modes</code></td>
<td>array</td>
<td>Strings starting with <code>armed_</code> are parsed into allowed
arm modes.</td>
</tr>
<tr>
<td><code>force</code></td>
<td>bool</td>
<td>Default force arm state (bypass open sensors).</td>
</tr>
<tr>
<td><code>skip_delay</code></td>
<td>bool</td>
<td>Default skip exit delay state.</td>
</tr>
</tbody>
</table>
<hr />
<h3 data-number="1.13.10" id="mqtt-button-mqtt-action-status"><span
class="header-section-number">1.13.10</span> MQTT Button (MQTT Action
Status)</h3>
<p><strong>Widget Type:</strong> <code>mqtt_action_status</code>
(preferred system command name: <code>mqtt_button</code>)</p>
<h4 data-number="1.13.10.1"
id="createconfigure-system-command-mqtt_button-mqtt_action_status-action_status"><span
class="header-section-number">1.13.10.1</span> Create/Configure (system
command: <code>mqtt_button</code> / <code>mqtt_action_status</code> /
<code>action_status</code>)</h4>
<p>This handler supports “create on configure”: if
<code>action == configure</code> and <code>window_id</code> does not
exist, it will create a new tile.</p>
<p>Top-level keys used:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td><code>mqtt_button</code> / <code>mqtt_action_status</code> /
<code>action_status</code>.</td>
</tr>
<tr>
<td><code>action</code></td>
<td>string</td>
<td><code>trigger</code></td>
<td>Common values: <code>configure</code> (alias:
<code>update_config</code>), <code>trigger</code> (alias:
<code>execute</code>), <code>publish</code>/<code>send</code>,
<code>toggle</code>, <code>set_status</code>.</td>
</tr>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td>-</td>
<td>Required for window-scoped actions; optional for generic
publish.</td>
</tr>
<tr>
<td><code>topic</code></td>
<td>string</td>
<td>-</td>
<td>Convenience alias for <code>publish_topic</code>.</td>
</tr>
<tr>
<td><code>payload</code></td>
<td>any</td>
<td>-</td>
<td>Convenience alias for <code>publish_payload</code>.</td>
</tr>
<tr>
<td><code>publish_topic</code> / <code>publishTopic</code></td>
<td>string</td>
<td>-</td>
<td>MQTT topic to publish when triggered.</td>
</tr>
<tr>
<td><code>publish_payload</code> / <code>publishPayload</code></td>
<td>object/any</td>
<td>-</td>
<td>MQTT payload published.</td>
</tr>
<tr>
<td><code>subscription_topic</code></td>
<td>string</td>
<td>-</td>
<td>Topic to subscribe to for status.</td>
</tr>
<tr>
<td><code>label</code></td>
<td>string</td>
<td>-</td>
<td>UI label.</td>
</tr>
<tr>
<td><code>mode</code> / <code>display_mode</code></td>
<td>string</td>
<td>-</td>
<td><code>toggle</code>/<code>switch</code> or
<code>icon_button</code>/<code>button</code>.</td>
</tr>
<tr>
<td><code>icon_on</code>, <code>icon_off</code></td>
<td>string</td>
<td>-</td>
<td>Icon names (controller maps these to icons).</td>
</tr>
<tr>
<td><code>color_on</code>, <code>color_off</code></td>
<td>string</td>
<td>-</td>
<td>Named color string (e.g., <code>red</code>, <code>green</code>,
<code>blue</code>, <code>grey</code>), hex string (<code>#RRGGBB</code>,
<code>#AARRGGBB</code>), or <code>0x</code> prefixed string.</td>
</tr>
<tr>
<td><code>size</code></td>
<td>number</td>
<td><code>48.0</code></td>
<td>Icon size. Clamped to [16.0, 128.0].</td>
</tr>
<tr>
<td><code>confirm</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>If true, publishes an acknowledgement to
<code>kingkiosk/{device}/system/response</code>.</td>
</tr>
</tbody>
</table>
<h4 data-number="1.13.10.2" id="element-commands-7"><span
class="header-section-number">1.13.10.2</span> Element Commands</h4>
<p>This widget may optionally support element-scoped commands on
<code>kingkiosk/{device_id}/element/{element_id}/cmd</code> <strong>only
if it registers</strong> a handler with
<code>MqttWidgetRouter.registerWidget(...)</code>.</p>
<hr />
<h3 data-number="1.13.11" id="charts"><span
class="header-section-number">1.13.11</span> Charts</h3>
<p>Charts are managed via the chart command set.</p>
<p>Rendering defaults now use a dark panel, animated transitions
(400ms), gradient fills, rounded bars, styled tooltips, and a larger
donut-style pie center.</p>
<h4 data-number="1.13.11.1" id="visual-defaults"><span
class="header-section-number">1.13.11.1</span> Visual Defaults</h4>
<table>
<thead>
<tr>
<th>Element</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>Panel background</td>
<td><code>#161A24 → #0F1117</code> vertical gradient</td>
</tr>
<tr>
<td>Primary color</td>
<td><code>#6366F1</code> (indigo)</td>
</tr>
<tr>
<td>Accent color</td>
<td><code>#06B6D4</code> (cyan)</td>
</tr>
<tr>
<td>Grid lines</td>
<td>Dashed horizontal lines (<code>#4B5568</code> with alpha)</td>
</tr>
<tr>
<td>Pie palette</td>
<td>Indigo, cyan, amber, red, violet, emerald, orange</td>
</tr>
<tr>
<td>Pie center radius</td>
<td><code>48</code></td>
</tr>
<tr>
<td>Bar corners</td>
<td>Rounded top corners (<code>6px</code>)</td>
</tr>
</tbody>
</table>
<h4 data-number="1.13.11.2" id="create_chart"><span
class="header-section-number">1.13.11.2</span>
<code>create_chart</code></h4>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>chart_id</code></td>
<td>string</td>
<td>(required)</td>
<td>Identifier.</td>
</tr>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td><code>chart_id</code></td>
<td>-</td>
</tr>
<tr>
<td><code>chart_type</code></td>
<td>string</td>
<td>-</td>
<td>Preferred. Alias: <code>type</code>.</td>
</tr>
<tr>
<td><code>type</code></td>
<td>string</td>
<td>-</td>
<td>Alias for <code>chart_type</code>.</td>
</tr>
<tr>
<td><code>max_points</code></td>
<td>int</td>
<td><code>60</code></td>
<td>Max points retained.</td>
</tr>
<tr>
<td><code>mqtt_topic_prefix</code></td>
<td>string</td>
<td><code>kingkiosk</code></td>
<td>Used for publish/subscribe topic construction.</td>
</tr>
<tr>
<td><code>title</code></td>
<td>string</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td><code>opacity</code>, <code>x</code>, <code>y</code>,
<code>width</code>, <code>height</code></td>
<td>number</td>
<td>-</td>
<td>Optional geometry.</td>
</tr>
</tbody>
</table>
<h4 data-number="1.13.11.3" id="append_chart_data"><span
class="header-section-number">1.13.11.3</span>
<code>append_chart_data</code></h4>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>chart_id</code></td>
<td>string</td>
<td>Required.</td>
</tr>
<tr>
<td><code>value</code></td>
<td>number</td>
<td>Required.</td>
</tr>
<tr>
<td><code>mqtt_topic_prefix</code></td>
<td>string</td>
<td>Optional.</td>
</tr>
</tbody>
</table>
<h4 data-number="1.13.11.4" id="replace_chart_data"><span
class="header-section-number">1.13.11.4</span>
<code>replace_chart_data</code></h4>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>chart_id</code></td>
<td>string</td>
<td>Required.</td>
</tr>
<tr>
<td><code>values</code></td>
<td>array<number></td>
<td>Required.</td>
</tr>
<tr>
<td><code>mqtt_topic_prefix</code></td>
<td>string</td>
<td>Optional.</td>
</tr>
</tbody>
</table>
<h4 data-number="1.13.11.5" id="update_pie_chart"><span
class="header-section-number">1.13.11.5</span>
<code>update_pie_chart</code></h4>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>chart_id</code></td>
<td>string</td>
<td>Required.</td>
</tr>
<tr>
<td><code>slices</code></td>
<td>array<object></td>
<td>Required.</td>
</tr>
<tr>
<td><code>mqtt_topic_prefix</code></td>
<td>string</td>
<td>Optional (default <code>kingkiosk</code>).</td>
</tr>
</tbody>
</table>
<p>Slice schema:</p>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 35%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>value</code></td>
<td>number</td>
<td>Required.</td>
</tr>
<tr>
<td><code>label</code></td>
<td>string</td>
<td>Optional.</td>
</tr>
<tr>
<td><code>color</code></td>
<td>string/int</td>
<td>Optional. Accepts <code>#RRGGBB</code>, <code>#AARRGGBB</code>, or
int ARGB.</td>
</tr>
</tbody>
</table>
<h4 data-number="1.13.11.6" id="configure_chart"><span
class="header-section-number">1.13.11.6</span>
<code>configure_chart</code></h4>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>chart_id</code></td>
<td>string</td>
<td>Required.</td>
</tr>
<tr>
<td><code>config</code></td>
<td>object</td>
<td>Required.</td>
</tr>
<tr>
<td><code>mqtt_topic_prefix</code></td>
<td>string</td>
<td>Optional (default <code>kingkiosk</code>).</td>
</tr>
</tbody>
</table>
<p>Known <code>configure_chart</code> command config keys:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>type</code></td>
<td>string</td>
<td><code>bar</code>, <code>pie</code>, <code>line</code>.</td>
</tr>
<tr>
<td><code>primaryColor</code></td>
<td>string/int</td>
<td>Color.</td>
</tr>
</tbody>
</table>
<p>Note: <code>configure_chart</code> (system command) currently applies
<code>type</code> and <code>primaryColor</code>. For <code>title</code>
and full visual options, publish directly to the chart config topic
below.</p>
<h4 data-number="1.13.11.7" id="reset_chart"><span
class="header-section-number">1.13.11.7</span>
<code>reset_chart</code></h4>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>chart_id</code></td>
<td>string</td>
<td>Required.</td>
</tr>
<tr>
<td><code>mqtt_topic_prefix</code></td>
<td>string</td>
<td>Optional (default <code>kingkiosk</code>).</td>
</tr>
</tbody>
</table>
<h4 data-number="1.13.11.8" id="delete_chart"><span
class="header-section-number">1.13.11.8</span>
<code>delete_chart</code></h4>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>chart_id</code></td>
<td>string</td>
<td>Required.</td>
</tr>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td>Optional (defaults to <code>chart_id</code>).</td>
</tr>
<tr>
<td><code>mqtt_topic_prefix</code></td>
<td>string</td>
<td>Optional (default <code>kingkiosk</code>).</td>
</tr>
</tbody>
</table>
<h4 data-number="1.13.11.9" id="list_charts"><span
class="header-section-number">1.13.11.9</span>
<code>list_charts</code></h4>
<p>No parameters. Returns a list of all chart tiles.</p>
<h4 data-number="1.13.11.10"
id="direct-mqtt-chart-topics-controller-level"><span
class="header-section-number">1.13.11.10</span> Direct MQTT Chart Topics
(Controller-Level)</h4>
<p>These topics are also supported by the chart controller and expose
the full config surface.</p>
<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 40%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th>Topic</th>
<th>Direction</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>{prefix}/chart/{chartId}/config</code></td>
<td>Subscribe</td>
<td>Apply chart configuration</td>
</tr>
<tr>
<td><code>{prefix}/chart/{chartId}/data</code></td>
<td>Subscribe</td>
<td>Append/replace time-series data</td>
</tr>
<tr>
<td><code>{prefix}/chart/{chartId}/pie</code></td>
<td>Subscribe</td>
<td>Replace pie slices</td>
</tr>
<tr>
<td><code>{prefix}/chart/{chartId}/reset</code></td>
<td>Subscribe</td>
<td>Clear chart data</td>
</tr>
</tbody>
</table>
<p>Config topic keys (<code>{prefix}/chart/{chartId}/config</code>):</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>type</code></td>
<td>string</td>
<td><code>line</code>, <code>bar</code>, <code>pie</code></td>
</tr>
<tr>
<td><code>title</code> / <code>chart_title</code></td>
<td>string</td>
<td>In-panel chart title</td>
</tr>
<tr>
<td><code>primaryColor</code></td>
<td>string/int</td>
<td>Primary chart color</td>
</tr>
<tr>
<td><code>showGrid</code></td>
<td>bool</td>
<td>Show dashed horizontal grid lines</td>
</tr>
<tr>
<td><code>showAxes</code></td>
<td>bool</td>
<td>Show axis labels</td>
</tr>
<tr>
<td><code>showDots</code></td>
<td>bool</td>
<td>Line chart dots</td>
</tr>
<tr>
<td><code>curvedLines</code></td>
<td>bool</td>
<td>Curved line interpolation</td>
</tr>
<tr>
<td><code>fillBelow</code></td>
<td>bool</td>
<td>Gradient fill under line</td>
</tr>
<tr>
<td><code>lineStrokeWidth</code></td>
<td>number</td>
<td>Line thickness</td>
</tr>
<tr>
<td><code>barWidth</code></td>
<td>number</td>
<td>Bar width</td>
</tr>
<tr>
<td><code>minY</code>, <code>maxY</code></td>
<td>number</td>
<td>Fixed y-axis bounds</td>
</tr>
<tr>
<td><code>showLabels</code></td>
<td>bool</td>
<td>Pie labels</td>
</tr>
<tr>
<td><code>pieCenterSpaceRadius</code></td>
<td>number</td>
<td>Donut center radius</td>
</tr>
<tr>
<td><code>pieSectionsSpace</code></td>
<td>number</td>
<td>Gap between pie slices</td>
</tr>
<tr>
<td><code>pieRadius</code></td>
<td>number</td>
<td>Pie slice radius</td>
</tr>
</tbody>
</table>
<p>Data topic payloads (<code>{prefix}/chart/{chartId}/data</code>):</p>
<ul>
<li>Append: <code>{ "append": 72.5 }</code></li>
<li>Replace: <code>{ "replace": [68, 70, 72] }</code></li>
<li>Replace (array form): <code>[68, 70, 72]</code></li>
</ul>
<hr />
<h3 data-number="1.13.12" id="mqtt-gauges"><span
class="header-section-number">1.13.12</span> MQTT Gauges</h3>
<p>The Gauge widget provides visual representation of values within a
range, supporting multiple display styles and interactive controls.
Designed for kiosk applications like thermostats, meters, and
dashboards.</p>
<p>Rendering is now fully custom-painted (no third-party gauge package),
with animated value transitions (600ms, <code>easeOutCubic</code>) for
both primary values and pointers.</p>
<h4 data-number="1.13.12.1" id="core-features"><span
class="header-section-number">1.13.12.1</span> Core Features</h4>
<ul>
<li><strong>Display Styles</strong>: linear, circular/radial,
semicircular, thermostat</li>
<li><strong>Interactive Mode</strong>: User can adjust values via
remote/touch/keyboard</li>
<li><strong>Locked Mode</strong>: Display-only, values controlled via
MQTT</li>
<li><strong>Multi-Pointer Support</strong>: Multiple indicators on
single gauge (e.g., current temp + setpoints)</li>
<li><strong>Thresholds/Zones</strong>: Color zones based on value
ranges</li>
<li><strong>MQTT Bidirectional</strong>: Subscribes to value updates,
publishes user changes</li>
<li><strong>Thermostat Dual Setpoint Mode</strong>: Heat/cool range arc
with current pointer and mode indicator (<code>Heating</code> /
<code>Cooling</code> / <code>Idle</code>)</li>
<li><strong>Safe Thermostat Interaction</strong>: In multi-pointer
thermostat mode, setpoints update only when dragging a pointer handle
(background taps do not change values)</li>
</ul>
<h4 data-number="1.13.12.2" id="visual-defaults-1"><span
class="header-section-number">1.13.12.2</span> Visual Defaults</h4>
<table>
<thead>
<tr>
<th>Element</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>Track background</td>
<td><code>#2A2D35</code></td>
</tr>
<tr>
<td>Value color theme</td>
<td><code>#6366F1 → #06B6D4</code></td>
</tr>
<tr>
<td>Label color</td>
<td><code>#B0B8C8</code></td>
</tr>
<tr>
<td>Track thickness</td>
<td><code>12px</code></td>
</tr>
<tr>
<td>Thermostat heat color</td>
<td><code>#FF6B35</code></td>
</tr>
<tr>
<td>Thermostat cool color</td>
<td><code>#4FC3F7</code></td>
</tr>
</tbody>
</table>
<h4 data-number="1.13.12.3"
id="create-gauge-create_gauge-create_mqtt_gauge"><span
class="header-section-number">1.13.12.3</span> Create Gauge
(<code>create_gauge</code>, <code>create_mqtt_gauge</code>)</h4>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>gauge_id</code></td>
<td>string</td>
<td>(required*)</td>
<td>Unique identifier for the gauge</td>
</tr>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td><code>gauge_id</code></td>
<td>Window/tile identifier</td>
</tr>
<tr>
<td><code>title</code></td>
<td>string</td>
<td><code>"Gauge {gauge_id}"</code></td>
<td>Display title</td>
</tr>
<tr>
<td><code>gauge_type</code></td>
<td>string</td>
<td><code>"linear"</code></td>
<td>Style: <code>"linear"</code>, <code>"circular"</code>,
<code>"radial"</code>, <code>"semicircular"</code>,
<code>"thermostat"</code></td>
</tr>
<tr>
<td><code>orientation</code></td>
<td>string</td>
<td><code>"horizontal"</code></td>
<td>Linear gauge orientation: <code>"horizontal"</code> or
<code>"vertical"</code> (only applies to
<code>gauge_type: "linear"</code>)</td>
</tr>
<tr>
<td><code>startAngle</code></td>
<td>number</td>
<td>(per type)</td>
<td>Arc start angle in degrees (radial/semicircular/thermostat).
Defaults: radial <code>-30</code>, circular <code>0</code>, semicircular
<code>180</code>, thermostat <code>135</code>.</td>
</tr>
<tr>
<td><code>endAngle</code></td>
<td>number</td>
<td>(per type)</td>
<td>Arc end angle in degrees. Defaults: radial <code>210</code>,
circular <code>360</code>, semicircular <code>0</code>, thermostat
<code>405</code>. Override both to reposition the arc
(e.g. <code>startAngle: 0, endAngle: 180</code> for a bottom
semicircle).</td>
</tr>
<tr>
<td><code>min</code></td>
<td>number</td>
<td><code>0</code></td>
<td>Minimum value</td>
</tr>
<tr>
<td><code>max</code></td>
<td>number</td>
<td><code>100</code></td>
<td>Maximum value</td>
</tr>
<tr>
<td><code>default_value</code></td>
<td>number</td>
<td><code>0</code></td>
<td>Initial value (alias: <code>value</code>)</td>
</tr>
<tr>
<td><code>value</code></td>
<td>number</td>
<td><code>0</code></td>
<td>Alias for <code>default_value</code></td>
</tr>
<tr>
<td><code>unit</code></td>
<td>string</td>
<td><code>""</code></td>
<td>Unit label (e.g., <code>"°F"</code>, <code>"%"</code>,
<code>"kW"</code>)</td>
</tr>
<tr>
<td><code>interactive</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>Allow user to adjust value</td>
</tr>
<tr>
<td><code>locked</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>Lock primary value (read-only display)</td>
</tr>
<tr>
<td><code>step_size</code></td>
<td>number</td>
<td><code>null</code></td>
<td>Increment step for user adjustments (alias: <code>stepSize</code>).
If omitted/null, values are continuous (no snapping).</td>
</tr>
<tr>
<td><code>decimals</code></td>
<td>number</td>
<td><code>0</code></td>
<td>Decimal places to display (0-4)</td>
</tr>
<tr>
<td><code>mqtt_topic_prefix</code></td>
<td>string</td>
<td><code>"kingkiosk"</code></td>
<td>Base topic for pub/sub</td>
</tr>
<tr>
<td><code>color_mode</code></td>
<td>string</td>
<td>-</td>
<td><code>"gradient"</code>, <code>"thresholds"</code>,
<code>"solid"</code>, <code>"zones"</code></td>
</tr>
<tr>
<td><code>show_min_max</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>Show min/max labels</td>
</tr>
<tr>
<td><code>show_value</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>Show current value</td>
</tr>
<tr>
<td><code>thresholds</code></td>
<td>array</td>
<td>-</td>
<td>Color threshold definitions (see below)</td>
</tr>
<tr>
<td><code>zones</code></td>
<td>array</td>
<td>-</td>
<td>Color zone definitions (see below)</td>
</tr>
<tr>
<td><code>backgroundColor</code></td>
<td>string</td>
<td><code>"#2A2D35"</code></td>
<td>Track/arc background color. Use <code>"#00000000"</code> for fully
transparent. Accepts <code>#RRGGBB</code> or
<code>#AARRGGBB</code>.</td>
</tr>
<tr>
<td><code>valueBarColor</code></td>
<td>string</td>
<td><code>"#6366F1"</code></td>
<td>Value bar/arc fill color.</td>
</tr>
<tr>
<td><code>thickness</code></td>
<td>number</td>
<td><code>12</code></td>
<td>Track thickness in pixels.</td>
</tr>
<tr>
<td><code>valueBarThickness</code></td>
<td>number</td>
<td><code>12</code></td>
<td>Value bar thickness in pixels.</td>
</tr>
<tr>
<td><code>borderRadius</code></td>
<td>number</td>
<td><code>12</code></td>
<td>Corner radius for the widget.</td>
</tr>
<tr>
<td><code>enableAnimation</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>Enable animated value transitions.</td>
</tr>
<tr>
<td><code>animationDuration</code></td>
<td>int</td>
<td><code>1000</code></td>
<td>Animation duration in milliseconds.</td>
</tr>
<tr>
<td><code>showLabels</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>Show tick/ruler labels.</td>
</tr>
<tr>
<td><code>rulerPosition</code></td>
<td>string</td>
<td><code>"bottom"</code></td>
<td>Ruler label position: <code>"top"</code>, <code>"bottom"</code>,
<code>"left"</code>, <code>"right"</code>, <code>"center"</code>.</td>
</tr>
<tr>
<td><code>inverseRulers</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>Invert ruler direction.</td>
</tr>
<tr>
<td><code>labelFontSize</code></td>
<td>number</td>
<td><code>12</code></td>
<td>Label font size.</td>
</tr>
<tr>
<td><code>labelColor</code></td>
<td>string</td>
<td><code>"#B0B8C8"</code></td>
<td>Label text color.</td>
</tr>
<tr>
<td><code>config</code></td>
<td>object</td>
<td>-</td>
<td>Additional configuration (pointers, zones)</td>
</tr>
<tr>
<td><code>os_widget</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>Create native OS widget (Android/iOS home screen)</td>
</tr>
<tr>
<td><code>mqtt_topic</code></td>
<td>string</td>
<td>-</td>
<td>MQTT topic for OS widget to subscribe to (required if
<code>os_widget: true</code>)</td>
</tr>
<tr>
<td><code>json_field</code></td>
<td>string</td>
<td>-</td>
<td>OS widget JSON extraction path (for <code>os_widget</code>). In-app
multi-pointer extraction uses <code>pointers[].json_field</code>.</td>
</tr>
<tr>
<td><code>opacity</code>, <code>x</code>, <code>y</code>,
<code>width</code>, <code>height</code></td>
<td>number</td>
<td>-</td>
<td>Optional geometry</td>
</tr>
</tbody>
</table>
<p>Important: In-app gauges do not use top-level
<code>subscribe_topic</code> / <code>publish_topic</code>. Use
pointer-level MQTT fields in <code>pointers[]</code>.</p>
<p><strong>Threshold Object:</strong></p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Required</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>value</code></td>
<td>number</td>
<td>Yes</td>
<td>Threshold value</td>
</tr>
<tr>
<td><code>color</code></td>
<td>string</td>
<td>Yes</td>
<td>Hex color (e.g., <code>"#3498db"</code>)</td>
</tr>
<tr>
<td><code>label</code></td>
<td>string</td>
<td>No</td>
<td>Optional label (e.g., <code>"Cold"</code>)</td>
</tr>
</tbody>
</table>
<p><strong>Zone Object:</strong></p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Required</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>min</code></td>
<td>number</td>
<td>Yes</td>
<td>Zone start value</td>
</tr>
<tr>
<td><code>max</code></td>
<td>number</td>
<td>Yes</td>
<td>Zone end value</td>
</tr>
<tr>
<td><code>color</code></td>
<td>string</td>
<td>Yes</td>
<td>Hex color</td>
</tr>
<tr>
<td><code>label</code></td>
<td>string</td>
<td>No</td>
<td>Optional label</td>
</tr>
</tbody>
</table>
<p><strong>Example: Create Thermostat Gauge (Dual Setpoints + Current
Pointer + Humidity)</strong></p>
<div class="sourceCode" id="cb50"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;create_gauge&quot;</span><span class="fu">,</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;gauge_id&quot;</span><span class="fu">:</span> <span class="st">&quot;upstairs-thermostat&quot;</span><span class="fu">,</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="st">&quot;Upstairs&quot;</span><span class="fu">,</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;gauge_type&quot;</span><span class="fu">:</span> <span class="st">&quot;thermostat&quot;</span><span class="fu">,</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;min&quot;</span><span class="fu">:</span> <span class="dv">50</span><span class="fu">,</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;max&quot;</span><span class="fu">:</span> <span class="dv">90</span><span class="fu">,</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;unit&quot;</span><span class="fu">:</span> <span class="st">&quot;°F&quot;</span><span class="fu">,</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;step_size&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;mqtt_topic_prefix&quot;</span><span class="fu">:</span> <span class="st">&quot;kingkiosk&quot;</span><span class="fu">,</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;pointers&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;current&quot;</span><span class="fu">,</span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;label&quot;</span><span class="fu">:</span> <span class="st">&quot;Current&quot;</span><span class="fu">,</span></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;style&quot;</span><span class="fu">:</span> <span class="st">&quot;needle&quot;</span><span class="fu">,</span></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;color&quot;</span><span class="fu">:</span> <span class="st">&quot;#E5E7EB&quot;</span><span class="fu">,</span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;locked&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;subscribe_topic&quot;</span><span class="fu">:</span> <span class="st">&quot;kingkiosk/ha/state/climate/upstairs&quot;</span><span class="fu">,</span></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;json_field&quot;</span><span class="fu">:</span> <span class="st">&quot;attributes.current_temperature&quot;</span></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;heat&quot;</span><span class="fu">,</span></span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;label&quot;</span><span class="fu">:</span> <span class="st">&quot;Heat&quot;</span><span class="fu">,</span></span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;style&quot;</span><span class="fu">:</span> <span class="st">&quot;dot&quot;</span><span class="fu">,</span></span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;color&quot;</span><span class="fu">:</span> <span class="st">&quot;#FF6B35&quot;</span><span class="fu">,</span></span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;locked&quot;</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span></span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;subscribe_topic&quot;</span><span class="fu">:</span> <span class="st">&quot;kingkiosk/ha/state/climate/upstairs&quot;</span><span class="fu">,</span></span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;publish_topic&quot;</span><span class="fu">:</span> <span class="st">&quot;kingkiosk/ha/command/climate/upstairs&quot;</span><span class="fu">,</span></span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;json_field&quot;</span><span class="fu">:</span> <span class="st">&quot;attributes.target_temp_low&quot;</span></span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;cool&quot;</span><span class="fu">,</span></span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;label&quot;</span><span class="fu">:</span> <span class="st">&quot;Cool&quot;</span><span class="fu">,</span></span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;style&quot;</span><span class="fu">:</span> <span class="st">&quot;dot&quot;</span><span class="fu">,</span></span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;color&quot;</span><span class="fu">:</span> <span class="st">&quot;#4FC3F7&quot;</span><span class="fu">,</span></span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;locked&quot;</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span></span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;subscribe_topic&quot;</span><span class="fu">:</span> <span class="st">&quot;kingkiosk/ha/state/climate/upstairs&quot;</span><span class="fu">,</span></span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;publish_topic&quot;</span><span class="fu">:</span> <span class="st">&quot;kingkiosk/ha/command/climate/upstairs&quot;</span><span class="fu">,</span></span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;json_field&quot;</span><span class="fu">:</span> <span class="st">&quot;attributes.target_temp_high&quot;</span></span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;humidity&quot;</span><span class="fu">,</span></span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;label&quot;</span><span class="fu">:</span> <span class="st">&quot;Humidity&quot;</span><span class="fu">,</span></span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;style&quot;</span><span class="fu">:</span> <span class="st">&quot;dot&quot;</span><span class="fu">,</span></span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;color&quot;</span><span class="fu">:</span> <span class="st">&quot;#94A3B8&quot;</span><span class="fu">,</span></span>
<span id="cb50-46"><a href="#cb50-46" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;locked&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb50-47"><a href="#cb50-47" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;subscribe_topic&quot;</span><span class="fu">:</span> <span class="st">&quot;kingkiosk/ha/state/climate/upstairs&quot;</span><span class="fu">,</span></span>
<span id="cb50-48"><a href="#cb50-48" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;json_field&quot;</span><span class="fu">:</span> <span class="st">&quot;attributes.current_humidity&quot;</span></span>
<span id="cb50-49"><a href="#cb50-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb50-50"><a href="#cb50-50" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb50-51"><a href="#cb50-51" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Thermostat dual-mode detection: - <code>current &lt; heat</code>
=&gt; <code>Heating</code> - <code>current &gt; cool</code> =&gt;
<code>Cooling</code> - otherwise =&gt; <code>Idle</code></p>
<p>Thermostat center text behavior: - Dual setpoint:
<code>HEAT ... COOL</code>, <code>DRAG DOT TO ADJUST</code>, plus mode
text (<code>Heating</code>/<code>Cooling</code>/<code>Idle</code>) - If
a humidity pointer is present, the center also shows
<code>HUMIDITY xx%</code></p>
<p><strong>Example: Create Gauge with Native OS Widget</strong></p>
<div class="sourceCode" id="cb51"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;create_gauge&quot;</span><span class="fu">,</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;gauge_id&quot;</span><span class="fu">:</span> <span class="st">&quot;outdoor_temp&quot;</span><span class="fu">,</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="st">&quot;Outdoor Temperature&quot;</span><span class="fu">,</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;gauge_type&quot;</span><span class="fu">:</span> <span class="st">&quot;radial&quot;</span><span class="fu">,</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;min&quot;</span><span class="fu">:</span> <span class="dv">-20</span><span class="fu">,</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;max&quot;</span><span class="fu">:</span> <span class="dv">120</span><span class="fu">,</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;unit&quot;</span><span class="fu">:</span> <span class="st">&quot;°F&quot;</span><span class="fu">,</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;decimals&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;color_mode&quot;</span><span class="fu">:</span> <span class="st">&quot;thresholds&quot;</span><span class="fu">,</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;thresholds&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span><span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">32</span><span class="fu">,</span> <span class="dt">&quot;color&quot;</span><span class="fu">:</span> <span class="st">&quot;#3498db&quot;</span><span class="fu">,</span> <span class="dt">&quot;label&quot;</span><span class="fu">:</span> <span class="st">&quot;Freezing&quot;</span><span class="fu">}</span><span class="ot">,</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span><span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">70</span><span class="fu">,</span> <span class="dt">&quot;color&quot;</span><span class="fu">:</span> <span class="st">&quot;#2ecc71&quot;</span><span class="fu">,</span> <span class="dt">&quot;label&quot;</span><span class="fu">:</span> <span class="st">&quot;Comfortable&quot;</span><span class="fu">}</span><span class="ot">,</span></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span><span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">90</span><span class="fu">,</span> <span class="dt">&quot;color&quot;</span><span class="fu">:</span> <span class="st">&quot;#e74c3c&quot;</span><span class="fu">,</span> <span class="dt">&quot;label&quot;</span><span class="fu">:</span> <span class="st">&quot;Hot&quot;</span><span class="fu">}</span></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;os_widget&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;mqtt_topic&quot;</span><span class="fu">:</span> <span class="st">&quot;weather/outdoor/temperature&quot;</span><span class="fu">,</span></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;json_field&quot;</span><span class="fu">:</span> <span class="st">&quot;temp_f&quot;</span></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>This creates both an in-app gauge and registers it as a native OS
widget that can be added to the Android home screen or iOS home/lock
screen. The widget independently subscribes to
<code>weather/outdoor/temperature</code> and extracts the value from the
<code>temp_f</code> JSON field.</p>
<h4 data-number="1.13.12.4"
id="update-gauge-value-set_value-set_gauge_value-update_gauge_value"><span
class="header-section-number">1.13.12.4</span> Update Gauge Value
(<code>set_value</code>, <code>set_gauge_value</code>,
<code>update_gauge_value</code>)</h4>
<table style="width:100%;">
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 37%" />
<col style="width: 22%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Required</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>gauge_id</code></td>
<td>string</td>
<td>Yes*</td>
<td>Gauge identifier</td>
</tr>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td>Yes*</td>
<td>Alias for <code>gauge_id</code></td>
</tr>
<tr>
<td><code>value</code></td>
<td>number</td>
<td>Yes</td>
<td>New value to display</td>
</tr>
<tr>
<td><code>mqtt_topic_prefix</code></td>
<td>string</td>
<td>No</td>
<td>Default <code>"kingkiosk"</code>. Used to construct controller
tag.</td>
</tr>
</tbody>
</table>
<p>*Either <code>gauge_id</code> or <code>window_id</code> is
required</p>
<h4 data-number="1.13.12.5"
id="configure-gauge-set_gauge_config-configure_gauge"><span
class="header-section-number">1.13.12.5</span> Configure Gauge
(<code>set_gauge_config</code>, <code>configure_gauge</code>)</h4>
<table style="width:100%;">
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 37%" />
<col style="width: 22%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Required</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>gauge_id</code> / <code>window_id</code></td>
<td>string</td>
<td>Yes*</td>
<td>Gauge identifier</td>
</tr>
<tr>
<td><code>config</code></td>
<td>object</td>
<td>No</td>
<td>Optional nested config object (merged with top-level keys).</td>
</tr>
<tr>
<td><code>mqtt_topic_prefix</code></td>
<td>string</td>
<td>No</td>
<td>Default <code>"kingkiosk"</code>. Used to construct controller
tag.</td>
</tr>
<tr>
<td><code>min</code></td>
<td>number</td>
<td>No</td>
<td>Minimum value</td>
</tr>
<tr>
<td><code>max</code></td>
<td>number</td>
<td>No</td>
<td>Maximum value</td>
</tr>
<tr>
<td><code>value</code></td>
<td>number</td>
<td>No</td>
<td>Current value</td>
</tr>
<tr>
<td><code>unit</code></td>
<td>string</td>
<td>No</td>
<td>Unit label</td>
</tr>
<tr>
<td><code>label</code></td>
<td>string</td>
<td>No</td>
<td>Additional label text</td>
</tr>
<tr>
<td><code>gauge_type</code></td>
<td>string</td>
<td>No</td>
<td>Display style</td>
</tr>
<tr>
<td><code>orientation</code></td>
<td>string</td>
<td>No</td>
<td>Linear gauge orientation: <code>"horizontal"</code> or
<code>"vertical"</code></td>
</tr>
<tr>
<td><code>startAngle</code></td>
<td>number</td>
<td>No</td>
<td>Arc start angle in degrees (radial/semicircular/thermostat)</td>
</tr>
<tr>
<td><code>endAngle</code></td>
<td>number</td>
<td>No</td>
<td>Arc end angle in degrees</td>
</tr>
<tr>
<td><code>interactive</code></td>
<td>bool</td>
<td>No</td>
<td>Allow user interaction</td>
</tr>
<tr>
<td><code>locked</code></td>
<td>bool</td>
<td>No</td>
<td>Lock value display</td>
</tr>
<tr>
<td><code>step_size</code></td>
<td>number</td>
<td>No</td>
<td>Step increment</td>
</tr>
<tr>
<td><code>decimals</code></td>
<td>number</td>
<td>No</td>
<td>Decimal places</td>
</tr>
<tr>
<td><code>show_min_max</code></td>
<td>bool</td>
<td>No</td>
<td>Show min/max labels</td>
</tr>
<tr>
<td><code>show_value</code></td>
<td>bool</td>
<td>No</td>
<td>Show current value</td>
</tr>
<tr>
<td><code>color_mode</code></td>
<td>string</td>
<td>No</td>
<td><code>"gradient"</code>, <code>"thresholds"</code>,
<code>"solid"</code>, <code>"zones"</code></td>
</tr>
<tr>
<td><code>thresholds</code></td>
<td>array</td>
<td>No</td>
<td>Color threshold definitions</td>
</tr>
<tr>
<td><code>zones</code></td>
<td>array</td>
<td>No</td>
<td>Color zone definitions</td>
</tr>
<tr>
<td><code>pointers</code></td>
<td>array</td>
<td>No</td>
<td>Pointer definitions</td>
</tr>
<tr>
<td><code>backgroundColor</code></td>
<td>string</td>
<td>No</td>
<td>Track/arc background color (<code>#RRGGBB</code> or
<code>#AARRGGBB</code>). Use <code>"#00000000"</code> for fully
transparent.</td>
</tr>
<tr>
<td><code>valueBarColor</code></td>
<td>string</td>
<td>No</td>
<td>Value bar/arc fill color</td>
</tr>
<tr>
<td><code>thickness</code></td>
<td>number</td>
<td>No</td>
<td>Track thickness in pixels</td>
</tr>
<tr>
<td><code>valueBarThickness</code></td>
<td>number</td>
<td>No</td>
<td>Value bar thickness in pixels</td>
</tr>
<tr>
<td><code>borderRadius</code></td>
<td>number</td>
<td>No</td>
<td>Corner radius</td>
</tr>
<tr>
<td><code>enableAnimation</code></td>
<td>bool</td>
<td>No</td>
<td>Enable animated value transitions</td>
</tr>
<tr>
<td><code>animationDuration</code></td>
<td>int</td>
<td>No</td>
<td>Animation duration in milliseconds</td>
</tr>
<tr>
<td><code>showLabels</code></td>
<td>bool</td>
<td>No</td>
<td>Show tick/ruler labels</td>
</tr>
<tr>
<td><code>rulerPosition</code></td>
<td>string</td>
<td>No</td>
<td><code>"top"</code>, <code>"bottom"</code>, <code>"left"</code>,
<code>"right"</code>, <code>"center"</code></td>
</tr>
<tr>
<td><code>inverseRulers</code></td>
<td>bool</td>
<td>No</td>
<td>Invert ruler direction</td>
</tr>
<tr>
<td><code>labelFontSize</code></td>
<td>number</td>
<td>No</td>
<td>Label font size</td>
</tr>
<tr>
<td><code>labelColor</code></td>
<td>string</td>
<td>No</td>
<td>Label text color</td>
</tr>
</tbody>
</table>
<h4 data-number="1.13.12.6" id="lockunlock-commands"><span
class="header-section-number">1.13.12.6</span> Lock/Unlock Commands</h4>
<p><strong><code>lock_gauge</code></strong>: Lock gauge to prevent user
interaction</p>
<div class="sourceCode" id="cb52"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;lock_gauge&quot;</span><span class="fu">,</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;gauge_id&quot;</span><span class="fu">:</span> <span class="st">&quot;thermostat-1&quot;</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong><code>unlock_gauge</code></strong>: Unlock gauge to allow
user interaction</p>
<p><strong><code>toggle_gauge_lock</code></strong>: Toggle the lock
state</p>
<h4 data-number="1.13.12.7" id="multi-pointer-support"><span
class="header-section-number">1.13.12.7</span> Multi-Pointer
Support</h4>
<p>For thermostat-style gauges with multiple indicators (current
temperature + setpoints):</p>
<p><strong>Pointer Properties:</strong></p>
<table>
<colgroup>
<col style="width: 24%" />
<col style="width: 14%" />
<col style="width: 24%" />
<col style="width: 21%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr>
<th>Property</th>
<th>Type</th>
<th>Required</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>string</td>
<td>Yes</td>
<td>-</td>
<td>Unique pointer identifier</td>
</tr>
<tr>
<td><code>value</code></td>
<td>number</td>
<td>No</td>
<td><code>0</code></td>
<td>Initial value</td>
</tr>
<tr>
<td><code>label</code></td>
<td>string</td>
<td>No</td>
<td><code>""</code></td>
<td>Pointer label</td>
</tr>
<tr>
<td><code>color</code></td>
<td>string</td>
<td>No</td>
<td><code>"#00BFFF"</code></td>
<td>Hex color</td>
</tr>
<tr>
<td><code>icon</code></td>
<td>string</td>
<td>No</td>
<td>-</td>
<td>Icon name</td>
</tr>
<tr>
<td><code>locked</code></td>
<td>bool</td>
<td>No</td>
<td><code>false</code></td>
<td>Prevent user adjustment</td>
</tr>
<tr>
<td><code>style</code></td>
<td>string</td>
<td>No</td>
<td><code>"needle"</code></td>
<td><code>"needle"</code>, <code>"dot"</code>, <code>"triangle"</code>,
<code>"line"</code>, <code>"target"</code></td>
</tr>
<tr>
<td><code>subscribe_topic</code></td>
<td>string</td>
<td>No</td>
<td>-</td>
<td>MQTT topic to receive value updates</td>
</tr>
<tr>
<td><code>publish_topic</code></td>
<td>string</td>
<td>No</td>
<td>-</td>
<td>MQTT topic to publish user changes</td>
</tr>
<tr>
<td><code>publish_payload</code></td>
<td>object</td>
<td>No</td>
<td>-</td>
<td>Optional custom payload template. Supports <code>{{value}}</code>,
<code>{{pointer_id}}</code>, <code>{{gauge_id}}</code>,
<code>{{timestamp}}</code>, <code>{{current}}</code>,
<code>{{heat}}</code>, <code>{{cool}}</code> tokens.</td>
</tr>
<tr>
<td><code>json_field</code></td>
<td>string</td>
<td>No</td>
<td>-</td>
<td>Dot-path field extractor for JSON payloads (aliases:
<code>json_path</code>, <code>value_path</code>)</td>
</tr>
</tbody>
</table>
<p>For Home Assistant climate payloads, a common mapping is: -
<code>current</code> -&gt; <code>attributes.current_temperature</code> -
<code>heat</code>/<code>low</code> -&gt;
<code>attributes.target_temp_low</code> -
<code>cool</code>/<code>high</code> -&gt;
<code>attributes.target_temp_high</code> - <code>humidity</code> -&gt;
<code>attributes.current_humidity</code> (renders as center text on
thermostat gauges)</p>
<p>Auxiliary pointer values such as humidity are not clamped to gauge
<code>min</code>/<code>max</code>; temperature-related pointers continue
to clamp to the configured range.</p>
<p>All pointers may share one <code>subscribe_topic</code>; the
controller de-duplicates subscriptions and updates each pointer using
its own <code>json_field</code>.</p>
<p>Interaction behavior for thermostat multi-pointer gauges: - Drag must
begin on/near an unlocked setpoint handle to adjust - Tap/click on the
dial background does not change setpoints</p>
<p>When <code>publish_topic</code> matches
<code>*/ha/command/climate/*</code> and <code>publish_payload</code> is
not provided, the gauge now publishes Home Assistant bridge-compatible
commands by default:</p>
<div class="sourceCode" id="cb53"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;service&quot;</span><span class="fu">:</span> <span class="st">&quot;set_temperature&quot;</span><span class="fu">,</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;data&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;target_temp_low&quot;</span><span class="fu">:</span> <span class="dv">68</span><span class="fu">,</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;target_temp_high&quot;</span><span class="fu">:</span> <span class="dv">76</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>For single-setpoint pointers, fallback payload is:</p>
<div class="sourceCode" id="cb54"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;service&quot;</span><span class="fu">:</span> <span class="st">&quot;set_temperature&quot;</span><span class="fu">,</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;data&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;temperature&quot;</span><span class="fu">:</span> <span class="dv">72</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Custom range thermostat <code>publish_payload</code> examples:</p>
<p>Heat pointer template:</p>
<div class="sourceCode" id="cb55"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;heat&quot;</span><span class="fu">,</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;publish_topic&quot;</span><span class="fu">:</span> <span class="st">&quot;kingkiosk/ha/command/climate/upstairs&quot;</span><span class="fu">,</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;publish_payload&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;service&quot;</span><span class="fu">:</span> <span class="st">&quot;set_temperature&quot;</span><span class="fu">,</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;data&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;target_temp_low&quot;</span><span class="fu">:</span> <span class="st">&quot;{{value}}&quot;</span><span class="fu">,</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;target_temp_high&quot;</span><span class="fu">:</span> <span class="st">&quot;{{cool}}&quot;</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Cool pointer template:</p>
<div class="sourceCode" id="cb56"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;cool&quot;</span><span class="fu">,</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;publish_topic&quot;</span><span class="fu">:</span> <span class="st">&quot;kingkiosk/ha/command/climate/upstairs&quot;</span><span class="fu">,</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;publish_payload&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;service&quot;</span><span class="fu">:</span> <span class="st">&quot;set_temperature&quot;</span><span class="fu">,</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;data&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;target_temp_low&quot;</span><span class="fu">:</span> <span class="st">&quot;{{heat}}&quot;</span><span class="fu">,</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;target_temp_high&quot;</span><span class="fu">:</span> <span class="st">&quot;{{value}}&quot;</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Template variables accepted in <code>publish_payload</code>: -
<code>{{value}}</code>, <code>{{pointer_id}}</code>,
<code>{{gauge_id}}</code>, <code>{{timestamp}}</code> -
<code>{{current}}</code>, <code>{{heat}}</code>,
<code>{{cool}}</code></p>
<p><strong><code>set_pointer_value</code></strong>: Update a specific
pointer’s value</p>
<div class="sourceCode" id="cb57"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;set_pointer_value&quot;</span><span class="fu">,</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;gauge_id&quot;</span><span class="fu">:</span> <span class="st">&quot;nest-thermostat&quot;</span><span class="fu">,</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;pointer_id&quot;</span><span class="fu">:</span> <span class="st">&quot;current&quot;</span><span class="fu">,</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">72</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong><code>add_pointer</code></strong>: Add a new pointer to a
gauge</p>
<div class="sourceCode" id="cb58"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;add_pointer&quot;</span><span class="fu">,</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;gauge_id&quot;</span><span class="fu">:</span> <span class="st">&quot;nest-thermostat&quot;</span><span class="fu">,</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;pointer&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;humidity&quot;</span><span class="fu">,</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;label&quot;</span><span class="fu">:</span> <span class="st">&quot;Humidity&quot;</span><span class="fu">,</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;color&quot;</span><span class="fu">:</span> <span class="st">&quot;#9b59b6&quot;</span><span class="fu">,</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;locked&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;style&quot;</span><span class="fu">:</span> <span class="st">&quot;dot&quot;</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong><code>remove_pointer</code></strong>: Remove a pointer from a
gauge</p>
<div class="sourceCode" id="cb59"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;remove_pointer&quot;</span><span class="fu">,</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;gauge_id&quot;</span><span class="fu">:</span> <span class="st">&quot;nest-thermostat&quot;</span><span class="fu">,</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;pointer_id&quot;</span><span class="fu">:</span> <span class="st">&quot;humidity&quot;</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h4 data-number="1.13.12.8" id="other-gauge-commands"><span
class="header-section-number">1.13.12.8</span> Other Gauge Commands</h4>
<ul>
<li><code>delete_gauge</code>: Remove a gauge widget</li>
<li><code>list_gauges</code>: List all active gauge instances</li>
</ul>
<h4 data-number="1.13.12.9" id="state-publishing"><span
class="header-section-number">1.13.12.9</span> State Publishing</h4>
<p>When <code>mqtt_topic_prefix</code> is set, the gauge publishes state
updates to:</p>
<p><code>{mqtt_topic_prefix}/state</code></p>
<p><strong>Published State Format:</strong></p>
<div class="sourceCode" id="cb60"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;widget_id&quot;</span><span class="fu">:</span> <span class="st">&quot;thermostat-1&quot;</span><span class="fu">,</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;gauge&quot;</span><span class="fu">,</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">72</span><span class="fu">,</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;min&quot;</span><span class="fu">:</span> <span class="dv">50</span><span class="fu">,</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;max&quot;</span><span class="fu">:</span> <span class="dv">90</span><span class="fu">,</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;percentage&quot;</span><span class="fu">:</span> <span class="dv">55</span><span class="fu">,</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;unit&quot;</span><span class="fu">:</span> <span class="st">&quot;°F&quot;</span><span class="fu">,</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;label&quot;</span><span class="fu">:</span> <span class="st">&quot;Living Room&quot;</span><span class="fu">,</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;style&quot;</span><span class="fu">:</span> <span class="st">&quot;thermostat&quot;</span><span class="fu">,</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;gauge_type&quot;</span><span class="fu">:</span> <span class="st">&quot;thermostat&quot;</span><span class="fu">,</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;color_mode&quot;</span><span class="fu">:</span> <span class="st">&quot;zones&quot;</span><span class="fu">,</span></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;decimals&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;formatted_value&quot;</span><span class="fu">:</span> <span class="st">&quot;72 °F&quot;</span><span class="fu">,</span></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;interactive&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;locked&quot;</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;step_size&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;show_min_max&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;show_value&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;pointers&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;current&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">72</span><span class="fu">,</span> <span class="dt">&quot;locked&quot;</span><span class="fu">:</span> <span class="kw">true</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;setpoint_high&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">76</span><span class="fu">,</span> <span class="dt">&quot;locked&quot;</span><span class="fu">:</span> <span class="kw">false</span> <span class="fu">}</span></span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;current_threshold&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">70</span><span class="fu">,</span></span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;color&quot;</span><span class="fu">:</span> <span class="st">&quot;#2ecc71&quot;</span><span class="fu">,</span></span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;label&quot;</span><span class="fu">:</span> <span class="st">&quot;Comfort&quot;</span></span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="dv">1704153600</span></span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h4 data-number="1.13.12.10" id="user-interaction-publishing"><span
class="header-section-number">1.13.12.10</span> User Interaction
Publishing</h4>
<p>When a user adjusts an interactive pointer, the gauge publishes
to:</p>
<p><code>{mqtt_topic_prefix}/user_input</code></p>
<div class="sourceCode" id="cb61"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;gauge_id&quot;</span><span class="fu">:</span> <span class="st">&quot;nest-thermostat&quot;</span><span class="fu">,</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;pointer_id&quot;</span><span class="fu">:</span> <span class="st">&quot;setpoint_high&quot;</span><span class="fu">,</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">75</span><span class="fu">,</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;previous_value&quot;</span><span class="fu">:</span> <span class="dv">76</span><span class="fu">,</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="dv">1704153600</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h4 data-number="1.13.12.11" id="mqtt-topics"><span
class="header-section-number">1.13.12.11</span> MQTT Topics</h4>
<table>
<colgroup>
<col style="width: 28%" />
<col style="width: 44%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr>
<th>Topic</th>
<th>Direction</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>{prefix}/gauge/{gaugeId}/value</code></td>
<td>Subscribe</td>
<td>Receive value updates</td>
</tr>
<tr>
<td><code>{prefix}/gauge/{gaugeId}/config</code></td>
<td>Subscribe</td>
<td>Receive configuration</td>
</tr>
<tr>
<td><code>{prefix}/gauge/{gaugeId}/status</code></td>
<td>Publish</td>
<td>Publish status updates</td>
</tr>
<tr>
<td><code>{prefix}/gauge/{gaugeId}/set</code></td>
<td>Publish</td>
<td>Publish user-set values</td>
</tr>
<tr>
<td><code>{prefix}/state</code></td>
<td>Publish</td>
<td>Full state (retained)</td>
</tr>
<tr>
<td><code>{prefix}/user_input</code></td>
<td>Publish</td>
<td>User interaction events</td>
</tr>
</tbody>
</table>
<h4 data-number="1.13.12.12" id="platform-notes"><span
class="header-section-number">1.13.12.12</span> Platform Notes</h4>
<ul>
<li><strong>tvOS</strong>: Use Siri Remote D-pad to select pointers and
adjust values</li>
<li><strong>iOS</strong>: Touch/swipe on gauge to adjust, tap pointers
to select</li>
<li><strong>macOS</strong>: Keyboard arrows to adjust, mouse click to
select pointers</li>
</ul>
<hr />
<h3 data-number="1.13.13" id="carousels"><span
class="header-section-number">1.13.13</span> Carousels</h3>
<h4 data-number="1.13.13.1"
id="create-create_carousel-create_video_carousel-create_image_carousel-create_widget_carousel"><span
class="header-section-number">1.13.13.1</span> Create
(<code>create_carousel</code>, <code>create_video_carousel</code>,
<code>create_image_carousel</code>,
<code>create_widget_carousel</code>)</h4>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td>Required.</td>
</tr>
<tr>
<td><code>title</code></td>
<td>string</td>
<td>Optional.</td>
</tr>
<tr>
<td><code>items</code></td>
<td>array</td>
<td>Optional.</td>
</tr>
<tr>
<td><code>config</code></td>
<td>object</td>
<td>Optional; see below.</td>
</tr>
<tr>
<td><code>opacity</code>, <code>x</code>, <code>y</code>,
<code>width</code>, <code>height</code></td>
<td>number</td>
<td>Optional geometry.</td>
</tr>
</tbody>
</table>
<p>Carousel <code>config</code> keys:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>auto_play</code></td>
<td>bool</td>
<td>-</td>
</tr>
<tr>
<td><code>interval</code></td>
<td>int</td>
<td>-</td>
</tr>
<tr>
<td><code>viewport_fraction</code></td>
<td>number</td>
<td>-</td>
</tr>
<tr>
<td><code>infinite_scroll</code></td>
<td>bool</td>
<td>-</td>
</tr>
<tr>
<td><code>reverse</code></td>
<td>bool</td>
<td>-</td>
</tr>
<tr>
<td><code>scroll_direction</code></td>
<td>string</td>
<td><code>vertical</code> or <code>horizontal</code>.</td>
</tr>
<tr>
<td><code>enlarge_center_page</code></td>
<td>bool</td>
<td>-</td>
</tr>
<tr>
<td><code>show_indicator</code></td>
<td>bool</td>
<td>-</td>
</tr>
<tr>
<td><code>pause_on_interaction</code></td>
<td>bool</td>
<td>-</td>
</tr>
<tr>
<td><code>resume_timeout</code></td>
<td>int</td>
<td>-</td>
</tr>
<tr>
<td><code>enable_manual_control</code></td>
<td>bool</td>
<td>-</td>
</tr>
<tr>
<td><code>disable_center</code></td>
<td>bool</td>
<td>-</td>
</tr>
<tr>
<td><code>pad_ends</code></td>
<td>bool</td>
<td>-</td>
</tr>
<tr>
<td><code>page_snapping</code></td>
<td>bool</td>
<td>-</td>
</tr>
<tr>
<td><code>layout_mode</code></td>
<td>string</td>
<td>-</td>
</tr>
</tbody>
</table>
<p>Other carousel commands: <code>add_carousel_item</code>,
<code>remove_carousel_item</code>, <code>update_carousel</code>,
<code>delete_carousel</code>, <code>list_carousels</code>, plus
navigation (<code>navigate_carousel</code>/<code>goto_carousel</code>)
with <code>index</code> or <code>target_id</code> and optional
<code>animate</code> + <code>duration</code> (ms).</p>
<p>Config/status commands: <code>set_carousel_config</code>,
<code>get_carousel_status</code>.</p>
<ul>
<li>Both route to the same implementation which <strong>updates</strong>
the carousel configuration by <code>window_id</code>.</li>
<li><code>get_carousel_status</code> currently does not publish a status
payload; it simply returns a generic
<code>{success:true, command, timestamp}</code> on
<code>response_topic</code>.</li>
</ul>
<p>Top-level keys for <code>set_carousel_config</code> /
<code>get_carousel_status</code>:</p>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 35%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td>Required.</td>
</tr>
<tr>
<td><code>auto_play</code></td>
<td>bool</td>
<td>Optional.</td>
</tr>
<tr>
<td><code>interval</code></td>
<td>int</td>
<td>Optional.</td>
</tr>
<tr>
<td><code>viewport_fraction</code></td>
<td>number</td>
<td>Optional.</td>
</tr>
<tr>
<td><code>infinite_scroll</code></td>
<td>bool</td>
<td>Optional.</td>
</tr>
<tr>
<td><code>reverse</code></td>
<td>bool</td>
<td>Optional.</td>
</tr>
<tr>
<td><code>scroll_direction</code></td>
<td>string</td>
<td><code>vertical</code> or <code>horizontal</code>. Note: omitting
this defaults to <code>horizontal</code> (overrides any existing
value).</td>
</tr>
<tr>
<td><code>enlarge_center_page</code></td>
<td>bool</td>
<td>Optional.</td>
</tr>
<tr>
<td><code>show_indicator</code></td>
<td>bool</td>
<td>Optional.</td>
</tr>
<tr>
<td><code>pause_on_interaction</code></td>
<td>bool</td>
<td>Optional.</td>
</tr>
<tr>
<td><code>resume_timeout</code></td>
<td>int</td>
<td>Optional.</td>
</tr>
<tr>
<td><code>enable_manual_control</code></td>
<td>bool</td>
<td>Optional.</td>
</tr>
</tbody>
</table>
<hr />
<h3 data-number="1.13.14" id="media-videoaudioimageweb"><span
class="header-section-number">1.13.14</span> Media
(Video/Audio/Image/Web)</h3>
<h4 data-number="1.13.14.1" id="play_media"><span
class="header-section-number">1.13.14.1</span>
<code>play_media</code></h4>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>type</code></td>
<td>string</td>
<td>inferred</td>
<td><code>video</code>, <code>audio</code>, <code>image</code>,
<code>web</code>, <code>webrtc</code>.</td>
</tr>
<tr>
<td><code>url</code></td>
<td>string</td>
<td>(required)</td>
<td>Media URL.</td>
</tr>
<tr>
<td><code>style</code></td>
<td>string</td>
<td>-</td>
<td>For audio: <code>window</code> or <code>visualizer</code>; for
video: <code>window</code> or <code>fullscreen</code> (fullscreen not
implemented).</td>
</tr>
<tr>
<td><code>loop</code></td>
<td>bool/string</td>
<td><code>false</code></td>
<td>Truthy string accepted.</td>
</tr>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td>-</td>
<td>For tiled display.</td>
</tr>
<tr>
<td><code>title</code></td>
<td>string</td>
<td>varies</td>
<td>Defaults: <code>Kiosk Video</code> / <code>Kiosk Audio</code> /
<code>MQTT Image</code> / <code>WebRTC Stream</code>.</td>
</tr>
<tr>
<td><code>opacity</code>, <code>x</code>, <code>y</code>,
<code>width</code>, <code>height</code></td>
<td>number</td>
<td>-</td>
<td>Optional geometry.</td>
</tr>
<tr>
<td><code>hardware_accel</code></td>
<td>bool/string</td>
<td>-</td>
<td>Temporary hardware accel preference for this request.</td>
</tr>
<tr>
<td><code>allow_bad_cert</code></td>
<td>bool/string</td>
<td><code>false</code></td>
<td>Applies to background audio playback (<code>type: audio</code>
without window style).</td>
</tr>
</tbody>
</table>
<p>Audio visualizer options (when <code>type == audio</code> and
<code>style == visualizer</code>):</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>visualizer_type</code></td>
<td>string</td>
<td><code>fft</code></td>
</tr>
<tr>
<td><code>bars</code></td>
<td>int</td>
<td><code>64</code></td>
</tr>
<tr>
<td><code>smoothing</code></td>
<td>number</td>
<td><code>0.8</code></td>
</tr>
<tr>
<td><code>color_scheme</code></td>
<td>string</td>
<td><code>rainbow</code></td>
</tr>
<tr>
<td><code>show_peaks</code></td>
<td>bool</td>
<td><code>true</code></td>
</tr>
<tr>
<td><code>peak_decay</code></td>
<td>number</td>
<td><code>0.95</code></td>
</tr>
<tr>
<td><code>update_frequency</code></td>
<td>int</td>
<td><code>60</code></td>
</tr>
</tbody>
</table>
<h4 data-number="1.13.14.2" id="youtube"><span
class="header-section-number">1.13.14.2</span> <code>youtube</code></h4>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>url</code></td>
<td>string</td>
<td>(required)</td>
<td>YouTube URL.</td>
</tr>
<tr>
<td><code>title</code></td>
<td>string</td>
<td><code>YouTube</code></td>
<td>-</td>
</tr>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td>(auto)</td>
<td>If omitted, auto-generated.</td>
</tr>
<tr>
<td><code>opacity</code>, <code>x</code>, <code>y</code>,
<code>width</code>, <code>height</code></td>
<td>number</td>
<td>-</td>
<td>Optional geometry.</td>
</tr>
</tbody>
</table>
<h4 data-number="1.13.14.3"
id="media-window-control-play-pause-close-plus-enter_fullscreenexit_fullscreentoggle_fullscreen"><span
class="header-section-number">1.13.14.3</span> Media window control
(<code>play</code>, <code>pause</code>, <code>close</code>, plus
<code>enter_fullscreen</code>/<code>exit_fullscreen</code>/<code>toggle_fullscreen</code>)</h4>
<p>These are window-id based and routed to the appropriate window
controller.</p>
<p>Legacy compatibility:</p>
<ul>
<li><code>pause_media</code> is accepted but
<strong>deprecated</strong>. It logs a warning and routes to the same
handler as <code>{command:'pause', window_id: ...}</code>.</li>
</ul>
<hr />
<h4 data-number="1.13.14.4"
id="background-audio-control-play_audio-pause_audio-stop_audio-seek_audio"><span
class="header-section-number">1.13.14.4</span> Background audio control
(<code>play_audio</code>, <code>pause_audio</code>,
<code>stop_audio</code>, <code>seek_audio</code>)</h4>
<p>These commands control the background audio playback service.</p>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td>One of <code>play_audio</code>, <code>pause_audio</code>,
<code>stop_audio</code>, <code>seek_audio</code>.</td>
</tr>
<tr>
<td><code>url</code></td>
<td>string</td>
<td>-</td>
<td>For <code>play_audio</code>: optional URL to play. If omitted,
resumes current audio.</td>
</tr>
<tr>
<td><code>loop</code></td>
<td>bool/string</td>
<td><code>false</code></td>
<td>For <code>play_audio</code>: loop playback. Truthy string
accepted.</td>
</tr>
<tr>
<td><code>allow_bad_cert</code></td>
<td>bool/string</td>
<td><code>false</code></td>
<td>For <code>play_audio</code>: allow invalid SSL certificates.</td>
</tr>
<tr>
<td><code>position</code></td>
<td>number/string</td>
<td><code>0</code></td>
<td>Only used by <code>seek_audio</code> (seconds).</td>
</tr>
</tbody>
</table>
<p>Notes:</p>
<ul>
<li>These handlers perform actual media control actions via
<code>MediaControlService</code>, but do not publish MQTT success/error
responses.</li>
</ul>
<hr />
<h4 data-number="1.13.14.5" id="emergency-media-reset-reset_media"><span
class="header-section-number">1.13.14.5</span> Emergency media reset
(<code>reset_media</code>)</h4>
<p>This triggers the media recovery service to reset media
resources.</p>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td>Must be <code>reset_media</code>.</td>
</tr>
<tr>
<td><code>force</code></td>
<td>bool/string</td>
<td><code>false</code></td>
<td>If true, forces reset behavior in the recovery service.</td>
</tr>
<tr>
<td><code>test</code></td>
<td>bool/string</td>
<td><code>false</code></td>
<td>If true, runs a health report only (no reset).</td>
</tr>
</tbody>
</table>
<p>Published topics:</p>
<ul>
<li>If <code>test == true</code>, publishes health status to
<code>kingkiosk/{device}/status/media_health</code>.</li>
<li>If a reset is performed successfully, publishes a report to
<code>kingkiosk/{device}/status/media_reset</code> with:
<code>{success:true, timestamp, resetCount, forced, audioRestored, audioUrl}</code>.</li>
</ul>
<p>Notes:</p>
<ul>
<li>The handler attempts to capture/restore background audio across the
reset when possible.</li>
</ul>
<hr />
<h3 data-number="1.13.15" id="web-pdf"><span
class="header-section-number">1.13.15</span> Web / PDF</h3>
<h4 data-number="1.13.15.1"
id="open_browser-open_web-open_simple_web"><span
class="header-section-number">1.13.15.1</span> <code>open_browser</code>
/ <code>open_web</code> / <code>open_simple_web</code></h4>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>url</code> / <code>initial_url</code></td>
<td>string</td>
<td>(required)</td>
</tr>
<tr>
<td><code>title</code></td>
<td>string</td>
<td><code>Simple Web</code></td>
</tr>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td>(auto)</td>
</tr>
<tr>
<td><code>opacity</code>, <code>x</code>, <code>y</code>,
<code>width</code>, <code>height</code></td>
<td>number</td>
<td>-</td>
</tr>
</tbody>
</table>
<p>Note (tvOS): Apple TV maps <code>open_browser</code> /
<code>open_web</code> / <code>open_simple_web</code> to
<code>create_remote_browser</code>.</p>
<p>Note (Flutter): <code>open_browser</code> / <code>open_web</code> are
aliases for <code>open_simple_web</code> (SimpleWeb).</p>
<h4 data-number="1.13.15.2" id="webrtc_player"><span
class="header-section-number">1.13.15.2</span>
<code>webrtc_player</code></h4>
<p>Opens a native WHEP WebRTC stream tile for low-latency streaming.</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>url</code></td>
<td>string</td>
<td>(required)</td>
</tr>
<tr>
<td><code>webrtc_url</code></td>
<td>string</td>
<td>-</td>
</tr>
<tr>
<td><code>title</code></td>
<td>string</td>
<td><code>WebRTC Player</code></td>
</tr>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td>(auto)</td>
</tr>
<tr>
<td><code>opacity</code>, <code>x</code>, <code>y</code>,
<code>width</code>, <code>height</code></td>
<td>number</td>
<td>-</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="sourceCode" id="cb62"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;webrtc_player&quot;</span><span class="fu">,</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;url&quot;</span><span class="fu">:</span> <span class="st">&quot;http://192.168.0.199:1984/webrtc.html?src=Backyard_Camera&quot;</span><span class="fu">,</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="st">&quot;Backyard Camera&quot;</span><span class="fu">,</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;x&quot;</span><span class="fu">:</span> <span class="dv">100</span><span class="fu">,</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;y&quot;</span><span class="fu">:</span> <span class="dv">100</span><span class="fu">,</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;width&quot;</span><span class="fu">:</span> <span class="dv">640</span><span class="fu">,</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;height&quot;</span><span class="fu">:</span> <span class="dv">480</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h4 data-number="1.13.15.3" id="open_pdf"><span
class="header-section-number">1.13.15.3</span>
<code>open_pdf</code></h4>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>url</code></td>
<td>string</td>
<td>(required)</td>
</tr>
<tr>
<td><code>title</code></td>
<td>string</td>
<td><code>PDF Document</code></td>
</tr>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td>(auto)</td>
</tr>
<tr>
<td><code>opacity</code>, <code>x</code>, <code>y</code>,
<code>width</code>, <code>height</code></td>
<td>number</td>
<td>-</td>
</tr>
</tbody>
</table>
<p>Note: runtime web/PDF actions (refresh, paging, etc.) are not
currently exposed as a canonical MQTT command surface. Treat these
windows as configured via their <code>open_*</code> system commands.</p>
<hr />
<h3 data-number="1.13.16" id="calendar"><span
class="header-section-number">1.13.16</span> Calendar</h3>
<p>System command: <code>calendar</code></p>
<p>Top-level keys:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>action</code></td>
<td>string</td>
<td>-</td>
<td><code>show</code>, <code>create</code>, <code>hide</code>,
<code>add_event</code>, <code>remove_event</code>,
<code>clear_events</code>, <code>go_to_date</code>,
<code>format</code>.</td>
</tr>
<tr>
<td><code>name</code></td>
<td>string</td>
<td><code>Calendar</code></td>
<td>-</td>
</tr>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td>(auto)</td>
<td>Used for create/hide.</td>
</tr>
<tr>
<td><code>opacity</code>, <code>x</code>, <code>y</code>,
<code>width</code>, <code>height</code></td>
<td>number</td>
<td>-</td>
<td>Optional geometry.</td>
</tr>
</tbody>
</table>
<p>Event management actions are forwarded to
<code>CalendarController.handleMqttCalendarCommand(...)</code>.</p>
<hr />
<h3 data-number="1.13.17" id="timers-stopwatch"><span
class="header-section-number">1.13.17</span> Timers / Stopwatch</h3>
<p>System commands:</p>
<table>
<colgroup>
<col style="width: 57%" />
<col style="width: 42%" />
</colgroup>
<thead>
<tr>
<th>Command</th>
<th>Keys</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>stopwatch</code></td>
<td><code>name</code>, <code>window_id</code>, <code>config</code>
(object), plus common geometry keys</td>
</tr>
<tr>
<td><code>timer_widget</code></td>
<td><code>name</code>, <code>window_id</code>, <code>config</code>
(object), plus common geometry keys</td>
</tr>
<tr>
<td><code>timer_control</code></td>
<td><code>timer_id</code> (required), <code>action</code> (required),
plus any additional keys forwarded to the timer window</td>
</tr>
</tbody>
</table>
<hr />
<h3 data-number="1.13.18" id="games"><span
class="header-section-number">1.13.18</span> Games</h3>
<p>System commands:</p>
<table>
<colgroup>
<col style="width: 57%" />
<col style="width: 42%" />
</colgroup>
<thead>
<tr>
<th>Command</th>
<th>Keys</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>stop_the_missiles</code></td>
<td><code>title</code>, optional <code>window_id</code>, optional
<code>game_type</code> (default <code>missile_command</code>), optional
<code>config</code> (object), optional <code>opacity</code>. Note:
geometry keys (<code>x</code>, <code>y</code>, <code>width</code>,
<code>height</code>) are parsed but <strong>not passed</strong> to the
tile creator.</td>
</tr>
<tr>
<td><code>game_control</code></td>
<td><code>window_id</code>, <code>action</code>
(<code>start</code>/<code>restart</code>/<code>stop</code>/<code>pause</code>/<code>resume</code>/<code>toggle_sound</code>/<code>set_transparent</code>/<code>set_background_mode</code>/<code>set_background_opacity</code>),
plus payload forwarded</td>
</tr>
<tr>
<td><code>close_all_games</code></td>
<td>No keys. Closes all game tiles.</td>
</tr>
<tr>
<td><code>game_state_query</code></td>
<td><code>window_id</code> (required). Publishes game state to
<code>kingkiosk/{device}/game_state</code>.</td>
</tr>
</tbody>
</table>
<hr />
<h3 data-number="1.13.19" id="mqtt-image-tile"><span
class="header-section-number">1.13.19</span> MQTT Image Tile</h3>
<p>System command: <code>mqtt_image</code></p>
<p>This command creates and manages a tile that updates its displayed
image based on MQTT messages.</p>
<p>Top-level keys used:</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 34%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>string</td>
<td>(required)</td>
<td>Must be <code>mqtt_image</code>.</td>
</tr>
<tr>
<td><code>action</code></td>
<td>string</td>
<td><code>open</code></td>
<td><code>open</code>/<code>create</code>, <code>update_topic</code>,
<code>close</code>.</td>
</tr>
<tr>
<td><code>window_name</code></td>
<td>string</td>
<td>auto</td>
<td>Preferred name key.</td>
</tr>
<tr>
<td><code>name</code></td>
<td>string</td>
<td>-</td>
<td>Alias for <code>window_name</code>.</td>
</tr>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td>-</td>
<td>If provided, used as the tile ID and registers a window controller
for basic window actions. Otherwise, <code>window_name</code> is used as
the tile ID.</td>
</tr>
<tr>
<td><code>mqtt_topic</code></td>
<td>string</td>
<td>(required)</td>
<td>Topic to subscribe for image updates.</td>
</tr>
<tr>
<td><code>json_field</code></td>
<td>string</td>
<td>-</td>
<td>Optional. Extracts image data from JSON using dot notation
(e.g. <code>data.image</code>). If omitted, common keys are
auto-detected.</td>
</tr>
<tr>
<td><code>is_base64</code></td>
<td>bool/string</td>
<td><code>false</code></td>
<td>Parsed by <code>toString().toLowerCase() == 'true'</code>.</td>
</tr>
<tr>
<td><code>initial_image</code> / <code>url</code></td>
<td>string</td>
<td>-</td>
<td>Optional initial display content.</td>
</tr>
<tr>
<td><code>update_interval</code></td>
<td>int/string</td>
<td><code>0</code></td>
<td>Milliseconds; stored on the tile when <code>&gt; 0</code>.</td>
</tr>
<tr>
<td><code>opacity</code></td>
<td>number/string</td>
<td><code>1.0</code></td>
<td>-</td>
</tr>
<tr>
<td><code>x</code>, <code>y</code></td>
<td>number/string</td>
<td><code>100</code></td>
<td>-</td>
</tr>
<tr>
<td><code>width</code>, <code>height</code></td>
<td>number/string</td>
<td><code>800</code> / <code>600</code></td>
<td>-</td>
</tr>
<tr>
<td><code>response_topic</code></td>
<td>string</td>
<td><code>kingkiosk/{device}/system/response</code></td>
<td>Receives
<code>{success, command:'mqtt_image', action, window_name, timestamp}</code>.</td>
</tr>
</tbody>
</table>
<p>Image payload behavior:</p>
<ul>
<li>If <code>json_field</code> is provided (or payload looks like JSON),
the handler tries to parse JSON and extract the image value.</li>
<li>If <code>is_base64 == true</code> and the extracted value is not a
<code>data:</code> URL, the handler will prefix
<code>data:image/png;base64,</code>.</li>
<li>If <code>is_base64 == false</code>, the handler may still
auto-detect large base64 payloads and treat them as
<code>data:image/png;base64,...</code>.</li>
</ul>
<hr />
<h3 data-number="1.13.20"
id="led-panel-programmable-light-display"><span
class="header-section-number">1.13.20</span> LED Panel (Programmable
Light Display)</h3>
<p>A virtual programmable LED light panel. Renders a grid of illuminated
shapes (squares, triangles, hexagons) that can be driven by built-in
preset animations, per-cell MQTT color control, a JSON expression
scripting engine, or scrolling pixel-font text.</p>
<p>Widget type: <code>ledPanel</code></p>
<h4 data-number="1.13.20.1" id="system-commands-1"><span
class="header-section-number">1.13.20.1</span> System Commands</h4>
<h5 data-number="1.13.20.1.1" id="create_led_panel"><span
class="header-section-number">1.13.20.1.1</span>
<code>create_led_panel</code></h5>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td>auto-generated</td>
<td>Unique window identifier.</td>
</tr>
<tr>
<td><code>title</code></td>
<td>string</td>
<td><code>"LED Panel"</code></td>
<td>Display name.</td>
</tr>
<tr>
<td><code>shape</code></td>
<td>string</td>
<td><code>"hexagon"</code></td>
<td>Cell shape: <code>square</code>, <code>triangle</code>,
<code>hexagon</code>.</td>
</tr>
<tr>
<td><code>rows</code></td>
<td>int</td>
<td><code>8</code></td>
<td>Number of rows (1-100).</td>
</tr>
<tr>
<td><code>cols</code></td>
<td>int</td>
<td><code>12</code></td>
<td>Number of columns (1-100).</td>
</tr>
<tr>
<td><code>gap</code></td>
<td>number</td>
<td><code>2</code></td>
<td>Gap between cells in pixels (0-20).</td>
</tr>
<tr>
<td><code>render_mode</code></td>
<td>string</td>
<td><code>"flat"</code></td>
<td><code>flat</code> (2D) or <code>wall3d</code> (3D with
shadows/glow).</td>
</tr>
<tr>
<td><code>brightness</code></td>
<td>number</td>
<td><code>1.0</code></td>
<td>Global brightness multiplier (0.0-1.0).</td>
</tr>
<tr>
<td><code>preset</code></td>
<td>string</td>
<td>-</td>
<td>Optional preset to start immediately.</td>
</tr>
<tr>
<td><code>preset_speed</code></td>
<td>number</td>
<td><code>1.0</code></td>
<td>Speed multiplier for the initial preset.</td>
</tr>
<tr>
<td><code>text</code></td>
<td>string</td>
<td>-</td>
<td>Optional text to display immediately.</td>
</tr>
<tr>
<td><code>scroll</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>Whether initial text should scroll.</td>
</tr>
<tr>
<td><code>scroll_speed</code></td>
<td>number</td>
<td><code>50</code></td>
<td>Scroll speed for initial text.</td>
</tr>
<tr>
<td><code>opacity</code></td>
<td>number</td>
<td><code>1.0</code></td>
<td>Window opacity.</td>
</tr>
<tr>
<td><code>x</code>, <code>y</code></td>
<td>number</td>
<td>-</td>
<td>Optional window position.</td>
</tr>
<tr>
<td><code>width</code>, <code>height</code></td>
<td>number</td>
<td><code>400</code>x<code>300</code></td>
<td>Optional window size.</td>
</tr>
</tbody>
</table>
<h5 data-number="1.13.20.1.2" id="configure_led_panel"><span
class="header-section-number">1.13.20.1.2</span>
<code>configure_led_panel</code></h5>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td>Required. Target panel.</td>
</tr>
<tr>
<td>Any key from <code>create_led_panel</code></td>
<td>-</td>
<td>Forwarded to panel controller.</td>
</tr>
</tbody>
</table>
<h5 data-number="1.13.20.1.3" id="delete_led_panel"><span
class="header-section-number">1.13.20.1.3</span>
<code>delete_led_panel</code></h5>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>window_id</code></td>
<td>string</td>
<td>Required. Panel to remove.</td>
</tr>
</tbody>
</table>
<h5 data-number="1.13.20.1.4" id="list_led_panels"><span
class="header-section-number">1.13.20.1.4</span>
<code>list_led_panels</code></h5>
<p>No parameters. Returns a list of all active LED panel tiles on the
device.</p>
<hr />
<h4 data-number="1.13.20.2" id="element-commands-8"><span
class="header-section-number">1.13.20.2</span> Element Commands</h4>
<p>Sent to
<code>kingkiosk/{device_id}/element/{panel_id}/cmd</code>.</p>
<h5 data-number="1.13.20.2.1" id="set_cells"><span
class="header-section-number">1.13.20.2.1</span>
<code>set_cells</code></h5>
<p>Set individual cell colors by index.</p>
<table>
<colgroup>
<col style="width: 27%" />
<col style="width: 33%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>cells</code></td>
<td>object</td>
<td>Map of cell index (string) to color. Example:
<code>{"0": "#FF0000", "5": "#00FF00"}</code>.</td>
</tr>
</tbody>
</table>
<h5 data-number="1.13.20.2.2" id="set_all"><span
class="header-section-number">1.13.20.2.2</span>
<code>set_all</code></h5>
<p>Fill all cells with a single color.</p>
<table>
<colgroup>
<col style="width: 27%" />
<col style="width: 33%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>color</code></td>
<td>string/int</td>
<td>Color value. Accepts <code>#RGB</code>, <code>#RRGGBB</code>,
<code>#AARRGGBB</code>, or int ARGB.</td>
</tr>
</tbody>
</table>
<h5 data-number="1.13.20.2.3" id="set_row"><span
class="header-section-number">1.13.20.2.3</span>
<code>set_row</code></h5>
<p>Set all cells in a row to one color.</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>row</code></td>
<td>int</td>
<td>Required. Zero-based row index.</td>
</tr>
<tr>
<td><code>color</code></td>
<td>string/int</td>
<td>Required. Color value.</td>
</tr>
</tbody>
</table>
<h5 data-number="1.13.20.2.4" id="set_column"><span
class="header-section-number">1.13.20.2.4</span>
<code>set_column</code></h5>
<p>Set all cells in a column to one color.</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>col</code></td>
<td>int</td>
<td>Required. Zero-based column index.</td>
</tr>
<tr>
<td><code>color</code></td>
<td>string/int</td>
<td>Required. Color value.</td>
</tr>
</tbody>
</table>
<h5 data-number="1.13.20.2.5" id="set_buffer"><span
class="header-section-number">1.13.20.2.5</span>
<code>set_buffer</code></h5>
<p>Set the entire cell color buffer at once.</p>
<table>
<colgroup>
<col style="width: 27%" />
<col style="width: 33%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>colors</code></td>
<td>array</td>
<td>Array of color strings, one per cell in linear order
(row-major).</td>
</tr>
</tbody>
</table>
<h5 data-number="1.13.20.2.6" id="fill_gradient"><span
class="header-section-number">1.13.20.2.6</span>
<code>fill_gradient</code></h5>
<p>Apply a gradient fill across the panel.</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>start</code></td>
<td>string/int</td>
<td>Required. Start color.</td>
</tr>
<tr>
<td><code>end</code></td>
<td>string/int</td>
<td>Required. End color.</td>
</tr>
<tr>
<td><code>direction</code></td>
<td>string</td>
<td><code>"horizontal"</code> (default) or <code>"vertical"</code>.</td>
</tr>
</tbody>
</table>
<h5 data-number="1.13.20.2.7" id="preset"><span
class="header-section-number">1.13.20.2.7</span>
<code>preset</code></h5>
<p>Start a built-in animation preset.</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>name</code></td>
<td>string</td>
<td><code>"rainbow_wave"</code></td>
<td>Preset name (see list below).</td>
</tr>
<tr>
<td><code>speed</code></td>
<td>number</td>
<td><code>1.0</code></td>
<td>Speed multiplier.</td>
</tr>
<tr>
<td><code>color</code></td>
<td>string/int</td>
<td>-</td>
<td>Optional base color for presets that use one (solid, breathing,
color_chase, wave).</td>
</tr>
</tbody>
</table>
<p>Available presets:</p>
<table>
<thead>
<tr>
<th>Preset</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>rainbow_wave</code></td>
<td>Hue cycles across cells with spatial phase offset.</td>
</tr>
<tr>
<td><code>breathing</code></td>
<td>All cells pulse brightness in sync.</td>
</tr>
<tr>
<td><code>color_chase</code></td>
<td>A highlight chases around the perimeter.</td>
</tr>
<tr>
<td><code>sparkle</code></td>
<td>Random cells flash white briefly.</td>
</tr>
<tr>
<td><code>fire</code></td>
<td>Warm orange/red flicker simulation.</td>
</tr>
<tr>
<td><code>matrix</code></td>
<td>Green falling-code columns.</td>
</tr>
<tr>
<td><code>gradient_rotate</code></td>
<td>Slowly rotating angular gradient.</td>
</tr>
<tr>
<td><code>solid</code></td>
<td>Static single color (uses <code>color</code> parameter).</td>
</tr>
<tr>
<td><code>random</code></td>
<td>Random colors per cell, re-randomized at interval.</td>
</tr>
<tr>
<td><code>wave</code></td>
<td>Sine wave brightness pattern sweeping across grid.</td>
</tr>
</tbody>
</table>
<h5 data-number="1.13.20.2.8" id="stop"><span
class="header-section-number">1.13.20.2.8</span> <code>stop</code></h5>
<p>Stop the current animation. Cell colors are preserved.</p>
<p>No parameters.</p>
<h5 data-number="1.13.20.2.9" id="clear"><span
class="header-section-number">1.13.20.2.9</span> <code>clear</code></h5>
<p>Stop the current animation and set all cells to black (off).</p>
<p>No parameters.</p>
<h5 data-number="1.13.20.2.10" id="set_text"><span
class="header-section-number">1.13.20.2.10</span>
<code>set_text</code></h5>
<p>Display text using the built-in 5x7 pixel bitmap font.</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>text</code></td>
<td>string</td>
<td><code>""</code></td>
<td>Text to display. Supports A-Z, 0-9, common punctuation.</td>
</tr>
<tr>
<td><code>color</code></td>
<td>string/int</td>
<td><code>"#FFFFFF"</code></td>
<td>Text (foreground) color.</td>
</tr>
<tr>
<td><code>bg</code></td>
<td>string/int</td>
<td><code>"#000000"</code></td>
<td>Background color.</td>
</tr>
<tr>
<td><code>scroll</code></td>
<td>bool</td>
<td><code>false</code></td>
<td>Enable scrolling marquee.</td>
</tr>
<tr>
<td><code>speed</code></td>
<td>number</td>
<td><code>50</code></td>
<td>Scroll speed (pixels per second).</td>
</tr>
<tr>
<td><code>direction</code></td>
<td>string</td>
<td><code>"left"</code></td>
<td>Scroll direction: <code>left</code>, <code>right</code>,
<code>up</code>, <code>down</code>.</td>
</tr>
</tbody>
</table>
<h5 data-number="1.13.20.2.11" id="set_brightness"><span
class="header-section-number">1.13.20.2.11</span>
<code>set_brightness</code></h5>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>value</code></td>
<td>number</td>
<td>Brightness multiplier (0.0 = off, 1.0 = full).</td>
</tr>
</tbody>
</table>
<h5 data-number="1.13.20.2.12" id="run_script"><span
class="header-section-number">1.13.20.2.12</span>
<code>run_script</code></h5>
<p>Run a JSON expression-based animation script.</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>script</code></td>
<td>object</td>
<td>Script definition (see script format below).</td>
</tr>
</tbody>
</table>
<p>Script format:</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 22%" />
<col style="width: 33%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>fps</code></td>
<td>int</td>
<td><code>30</code></td>
<td>Target frames per second.</td>
</tr>
<tr>
<td><code>loop</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>Loop when duration expires.</td>
</tr>
<tr>
<td><code>duration</code></td>
<td>number</td>
<td><code>null</code></td>
<td>Duration in seconds. <code>null</code> = infinite.</td>
</tr>
<tr>
<td><code>variables</code></td>
<td>object</td>
<td><code>{}</code></td>
<td>User-defined variables available in expressions.</td>
</tr>
<tr>
<td><code>per_cell</code></td>
<td>object</td>
<td>(required)</td>
<td>HSL expressions evaluated per cell per frame.</td>
</tr>
<tr>
<td><code>per_cell.h</code></td>
<td>string</td>
<td><code>"0"</code></td>
<td>Hue expression (0-360).</td>
</tr>
<tr>
<td><code>per_cell.s</code></td>
<td>string</td>
<td><code>"1"</code></td>
<td>Saturation expression (0.0-1.0).</td>
</tr>
<tr>
<td><code>per_cell.l</code></td>
<td>string</td>
<td><code>"0.5"</code></td>
<td>Lightness expression (0.0-1.0).</td>
</tr>
</tbody>
</table>
<p>Built-in variables available in expressions:</p>
<table>
<thead>
<tr>
<th>Variable</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>t</code></td>
<td>Elapsed time in seconds.</td>
</tr>
<tr>
<td><code>frame</code></td>
<td>Frame number since script start.</td>
</tr>
<tr>
<td><code>cell_x</code></td>
<td>Cell column index (0-based).</td>
</tr>
<tr>
<td><code>cell_y</code></td>
<td>Cell row index (0-based).</td>
</tr>
<tr>
<td><code>cell_index</code></td>
<td>Linear cell index (row-major).</td>
</tr>
<tr>
<td><code>total_cells</code></td>
<td>Total number of cells in the grid.</td>
</tr>
<tr>
<td><code>total_rows</code></td>
<td>Number of rows.</td>
</tr>
<tr>
<td><code>total_cols</code></td>
<td>Number of columns.</td>
</tr>
<tr>
<td><code>cell_dist_center</code></td>
<td>Normalized distance from grid center (0.0-1.0).</td>
</tr>
<tr>
<td><code>cell_angle</code></td>
<td>Angle from grid center in radians.</td>
</tr>
<tr>
<td><code>PI</code></td>
<td>3.14159…</td>
</tr>
<tr>
<td>User variables</td>
<td>Any key defined in <code>variables</code> block.</td>
</tr>
</tbody>
</table>
<p>Built-in functions: <code>sin</code>, <code>cos</code>,
<code>tan</code>, <code>asin</code>, <code>acos</code>,
<code>atan</code>, <code>atan2</code>, <code>abs</code>,
<code>floor</code>, <code>ceil</code>, <code>round</code>,
<code>sqrt</code>, <code>pow</code>, <code>log</code>, <code>exp</code>,
<code>min</code>, <code>max</code>, <code>clamp</code>,
<code>lerp</code>, <code>fmod</code>, <code>mod</code>,
<code>step</code>, <code>smoothstep</code>, <code>noise</code> (2D
simplex), <code>random</code>, <code>sign</code>, <code>fract</code>,
<code>if(cond, a, b)</code>.</p>
<p>Operators: <code>+</code>, <code>-</code>, <code>*</code>,
<code>/</code>, <code>%</code>, <code>^</code> (power), <code>**</code>
(power), <code>&lt;</code>, <code>&gt;</code>, <code>&lt;=</code>,
<code>&gt;=</code>, <code>==</code>, <code>!=</code>,
<code>&amp;&amp;</code>, <code>||</code>, <code>? :</code>
(ternary).</p>
<h5 data-number="1.13.20.2.13" id="configure"><span
class="header-section-number">1.13.20.2.13</span>
<code>configure</code></h5>
<p>Reconfigure the panel at runtime.</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>shape</code></td>
<td>string</td>
<td><code>square</code>, <code>triangle</code>,
<code>hexagon</code>.</td>
</tr>
<tr>
<td><code>rows</code></td>
<td>int</td>
<td>Number of rows (1-100).</td>
</tr>
<tr>
<td><code>cols</code></td>
<td>int</td>
<td>Number of columns (1-100).</td>
</tr>
<tr>
<td><code>gap</code></td>
<td>number</td>
<td>Gap in pixels (0-20).</td>
</tr>
<tr>
<td><code>render_mode</code></td>
<td>string</td>
<td><code>flat</code> or <code>wall3d</code>.</td>
</tr>
<tr>
<td><code>brightness</code></td>
<td>number</td>
<td>Global brightness (0.0-1.0).</td>
</tr>
</tbody>
</table>
<h5 data-number="1.13.20.2.14" id="define_glyph"><span
class="header-section-number">1.13.20.2.14</span>
<code>define_glyph</code></h5>
<p>Define a custom pixel-font glyph for text rendering.</p>
<table>
<colgroup>
<col style="width: 27%" />
<col style="width: 33%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>char</code></td>
<td>string</td>
<td>Single character to define (e.g., <code>"★"</code>).</td>
</tr>
<tr>
<td><code>bitmap</code></td>
<td>array</td>
<td>2D array of 0/1 values. Each inner array is a row. Standard size: 5
wide x 7 tall.</td>
</tr>
</tbody>
</table>
<hr />
<h4 data-number="1.13.20.3" id="element-state-1"><span
class="header-section-number">1.13.20.3</span> Element State</h4>
<p>Published to
<code>kingkiosk/{device_id}/element/{panel_id}/state</code>
(retained).</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>type</code></td>
<td>string</td>
<td>Always <code>"ledPanel"</code>.</td>
</tr>
<tr>
<td><code>widget_id</code></td>
<td>string</td>
<td>Panel window ID.</td>
</tr>
<tr>
<td><code>shape</code></td>
<td>string</td>
<td>Current shape.</td>
</tr>
<tr>
<td><code>rows</code></td>
<td>int</td>
<td>Current row count.</td>
</tr>
<tr>
<td><code>cols</code></td>
<td>int</td>
<td>Current column count.</td>
</tr>
<tr>
<td><code>gap</code></td>
<td>number</td>
<td>Current gap.</td>
</tr>
<tr>
<td><code>render_mode</code></td>
<td>string</td>
<td>Current render mode.</td>
</tr>
<tr>
<td><code>brightness</code></td>
<td>number</td>
<td>Current brightness.</td>
</tr>
<tr>
<td><code>active_preset</code></td>
<td>string/null</td>
<td>Name of running preset, or null.</td>
</tr>
<tr>
<td><code>scroll_text</code></td>
<td>string</td>
<td>Currently displayed text.</td>
</tr>
<tr>
<td><code>is_scrolling</code></td>
<td>bool</td>
<td>Whether text is scrolling.</td>
</tr>
<tr>
<td><code>total_cells</code></td>
<td>int</td>
<td>Total cell count in grid.</td>
</tr>
</tbody>
</table>
<hr />
<h2 data-number="1.14" id="integration-examples"><span
class="header-section-number">1.14</span> Integration Examples</h2>
<h3 data-number="1.14.1"
id="node-red-monitor-and-control-a-clock-widget"><span
class="header-section-number">1.14.1</span> Node-RED: Monitor and
Control a Clock Widget</h3>
<div class="sourceCode" id="cb63"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="ot">[</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;clock-state-sub&quot;</span><span class="fu">,</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;mqtt in&quot;</span><span class="fu">,</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;topic&quot;</span><span class="fu">:</span> <span class="st">&quot;kingkiosk/my-device/element/clock-1/state&quot;</span><span class="fu">,</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;qos&quot;</span><span class="fu">:</span> <span class="st">&quot;1&quot;</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;clock-cmd-pub&quot;</span><span class="fu">,</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;mqtt out&quot;</span><span class="fu">,</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;topic&quot;</span><span class="fu">:</span> <span class="st">&quot;kingkiosk/my-device/element/clock-1/cmd&quot;</span><span class="fu">,</span></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;qos&quot;</span><span class="fu">:</span> <span class="st">&quot;1&quot;</span></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a><span class="ot">]</span></span></code></pre></div>
<h3 data-number="1.14.2" id="home-assistant-widget-state-sensor"><span
class="header-section-number">1.14.2</span> Home Assistant: Widget State
Sensor</h3>
<div class="sourceCode" id="cb64"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mqtt</span><span class="kw">:</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">sensor</span><span class="kw">:</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;Living Room Clock Mode&quot;</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">state_topic</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;kingkiosk/my-device/element/clock-1/state&quot;</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">value_template</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;{{ value_json.mode }}&quot;</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">json_attributes_topic</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;kingkiosk/my-device/element/clock-1/state&quot;</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">button</span><span class="kw">:</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;Toggle Clock Mode&quot;</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">command_topic</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;kingkiosk/my-device/element/clock-1/cmd&quot;</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">payload_press</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;{&quot;command&quot;: &quot;toggle_mode&quot;}&#39;</span></span></code></pre></div>
<h3 data-number="1.14.3" id="python-list-all-widgets-on-a-device"><span
class="header-section-number">1.14.3</span> Python: List All Widgets on
a Device</h3>
<div class="sourceCode" id="cb65"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> paho.mqtt.client <span class="im">as</span> mqtt</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> on_message(client, userdata, msg):</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    info <span class="op">=</span> json.loads(msg.payload)</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Device: </span><span class="sc">{</span>info[<span class="st">&#39;device_id&#39;</span>]<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Active widgets: </span><span class="sc">{</span>info[<span class="st">&#39;active_widgets&#39;</span>]<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> widget_id <span class="kw">in</span> info[<span class="st">&#39;active_widgets&#39;</span>]:</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;  - </span><span class="sc">{</span>widget_id<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> mqtt.Client()</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>client.on_message <span class="op">=</span> on_message</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>client.<span class="ex">connect</span>(<span class="st">&quot;broker.local&quot;</span>, <span class="dv">1883</span>)</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>client.subscribe(<span class="st">&quot;kingkiosk/+/info&quot;</span>)</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>client.loop_forever()</span></code></pre></div>
<hr />
<h2 data-number="1.15" id="canonical-topic-summary"><span
class="header-section-number">1.15</span> Canonical Topic Summary</h2>
<ul>
<li>Send device-wide commands to
<code>kingkiosk/{device_id}/system/cmd</code></li>
<li>Send element-scoped commands (when supported) to
<code>kingkiosk/{device_id}/element/{element_id}/cmd</code></li>
<li>Subscribe for responses on
<code>kingkiosk/{device_id}/system/response</code> and/or
<code>kingkiosk/{device_id}/element/{element_id}/response</code></li>
<li>Subscribe for retained element state on
<code>kingkiosk/{device_id}/element/{element_id}/state</code></li>
</ul>
<hr />
<h2 data-number="1.16"
id="developer-guide-adding-mqtt-support-to-widgets"><span
class="header-section-number">1.16</span> Developer Guide: Adding MQTT
Support to Widgets</h2>
<p>To add per-widget MQTT support to a widget controller:</p>
<h3 data-number="1.16.1" id="add-the-mixin"><span
class="header-section-number">1.16.1</span> 1. Add the Mixin</h3>
<div class="sourceCode" id="cb66"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="st">&#39;../../../widgets/mqtt_widget_mixin.dart&#39;</span>;</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyWidgetController <span class="kw">extends</span> GetxController</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">with</span> MqttWidgetMixin</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">implements</span> KioskWindowController <span class="op">{</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">String</span> <span class="kw">get</span> widgetId <span class="op">=&gt;</span> windowName;</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">String</span> <span class="kw">get</span> widgetType <span class="op">=&gt;</span> <span class="st">&#39;my_widget&#39;</span>;</span></code></pre></div>
<h3 data-number="1.16.2" id="register-in-oninit"><span
class="header-section-number">1.16.2</span> 2. Register in onInit</h3>
<div class="sourceCode" id="cb67"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="kw">@override</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> onInit() <span class="op">{</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">super</span><span class="op">.</span>onInit();</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>  registerWithMqtt();</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="1.16.3" id="unregister-in-onclose"><span
class="header-section-number">1.16.3</span> 3. Unregister in
onClose</h3>
<div class="sourceCode" id="cb68"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="kw">@override</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> onClose() <span class="op">{</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  unregisterFromMqtt();</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">super</span><span class="op">.</span>onClose();</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="1.16.4" id="handle-commands"><span
class="header-section-number">1.16.4</span> 4. Handle Commands</h3>
<div class="sourceCode" id="cb69"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="kw">@override</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="dt">Future</span><span class="op">&lt;</span><span class="dt">Map</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> <span class="at">dynamic</span><span class="op">&gt;?&gt;</span> handleMqttCommand(</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Map</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> <span class="at">dynamic</span><span class="op">&gt;</span> command) <span class="at">async</span> <span class="op">{</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> cmd <span class="op">=</span> command[<span class="st">&#39;command&#39;</span>] <span class="kw">as</span> <span class="dt">String</span><span class="op">?</span>;</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span> (cmd) <span class="op">{</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&#39;my_command&#39;</span><span class="op">:</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>      doSomething();</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">return</span> <span class="op">{</span><span class="st">&#39;status&#39;</span><span class="op">:</span> <span class="st">&#39;success&#39;</span><span class="op">}</span>;</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">default</span><span class="op">:</span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">return</span> <span class="cn">null</span>; <span class="co">// Let mixin handle common commands</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="1.16.5" id="build-state"><span
class="header-section-number">1.16.5</span> 5. Build State</h3>
<div class="sourceCode" id="cb70"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="kw">@override</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="dt">Map</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> <span class="at">dynamic</span><span class="op">&gt;</span> buildState() <span class="op">{</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> <span class="op">{</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;type&#39;</span><span class="op">:</span> widgetType<span class="op">,</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;widget_id&#39;</span><span class="op">:</span> widgetId<span class="op">,</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;my_value&#39;</span><span class="op">:</span> myValue<span class="op">,</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ... other state fields</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>;</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="1.16.6" id="publish-events-optional"><span
class="header-section-number">1.16.6</span> 6. Publish Events
(Optional)</h3>
<div class="sourceCode" id="cb71"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Publish custom events</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>publishEvent(<span class="op">{</span><span class="st">&#39;event&#39;</span><span class="op">:</span> <span class="st">&#39;my_event&#39;</span><span class="op">,</span> <span class="st">&#39;data&#39;</span><span class="op">:</span> someData<span class="op">}</span>);</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Convenience methods</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>publishSimpleEvent(<span class="st">&#39;clicked&#39;</span>);</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>publishError(<span class="st">&#39;Something went wrong&#39;</span><span class="op">,</span> <span class="st">&#39;ERR_CODE&#39;</span>);</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>publishStateChange(<span class="st">&#39;idle&#39;</span><span class="op">,</span> <span class="st">&#39;playing&#39;</span>);</span></code></pre></div>
<hr />
<h2 data-number="1.17"
id="appendix-a-led-panel-scripting-engine-reference"><span
class="header-section-number">1.17</span> Appendix A: LED Panel
Scripting Engine Reference</h2>
<p>The LED Panel scripting engine is a lightweight expression evaluator
that computes each cell’s color on every animation frame. Scripts are
defined as JSON and sent via the <code>run_script</code> element
command. Each cell’s color is specified in <strong>HSL</strong> (Hue,
Saturation, Lightness) by evaluating three mathematical expressions per
cell per frame.</p>
<h3 data-number="1.17.1" id="how-it-works"><span
class="header-section-number">1.17.1</span> How It Works</h3>
<ol type="1">
<li>You send a JSON script object via MQTT.</li>
<li>The engine <strong>parses</strong> the three HSL expressions once
(compile step).</li>
<li>On every frame (at the configured <code>fps</code>), for every cell
in the grid, the engine:
<ul>
<li>Sets the built-in variables (<code>t</code>, <code>cell_x</code>,
<code>cell_y</code>, etc.) to that cell’s values.</li>
<li><strong>Evaluates</strong> each expression (<code>h</code>,
<code>s</code>, <code>l</code>) to produce a number.</li>
<li>Converts the three numbers into a color:
<code>HSLColor(hue, saturation, lightness)</code>.</li>
</ul></li>
<li>The resulting color map is rendered by the painter.</li>
</ol>
<p>Because expressions are parsed once and evaluated numerically,
performance is excellent even on large grids.</p>
<h3 data-number="1.17.2" id="script-json-format"><span
class="header-section-number">1.17.2</span> Script JSON Format</h3>
<div class="sourceCode" id="cb72"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;fps&quot;</span><span class="fu">:</span> <span class="dv">30</span><span class="fu">,</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;loop&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;duration&quot;</span><span class="fu">:</span> <span class="kw">null</span><span class="fu">,</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;variables&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;speed&quot;</span><span class="fu">:</span> <span class="fl">2.0</span><span class="fu">,</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;hue_offset&quot;</span><span class="fu">:</span> <span class="dv">120</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;per_cell&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;h&quot;</span><span class="fu">:</span> <span class="st">&quot;(cell_x * 10 + t * speed + hue_offset) % 360&quot;</span><span class="fu">,</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;s&quot;</span><span class="fu">:</span> <span class="st">&quot;0.9&quot;</span><span class="fu">,</span></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;l&quot;</span><span class="fu">:</span> <span class="st">&quot;0.4 + 0.1 * sin(cell_dist_center * 6.28 - t * 3)&quot;</span></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 17%" />
<col style="width: 25%" />
<col style="width: 37%" />
</colgroup>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>fps</code></td>
<td>int</td>
<td><code>30</code></td>
<td>Target frames per second. Higher values are smoother but use more
CPU. 15-30 is usually sufficient.</td>
</tr>
<tr>
<td><code>loop</code></td>
<td>bool</td>
<td><code>true</code></td>
<td>When <code>duration</code> expires, restart from <code>t = 0</code>
if true, otherwise stop.</td>
</tr>
<tr>
<td><code>duration</code></td>
<td>number or null</td>
<td><code>null</code></td>
<td>Script duration in seconds. <code>null</code> means run forever
until stopped.</td>
</tr>
<tr>
<td><code>variables</code></td>
<td>object</td>
<td><code>{}</code></td>
<td>User-defined named constants available in all expressions. Values
must be numbers.</td>
</tr>
<tr>
<td><code>per_cell</code></td>
<td>object</td>
<td><em>(required)</em></td>
<td>Contains the three HSL expression strings.</td>
</tr>
<tr>
<td><code>per_cell.h</code></td>
<td>string</td>
<td><code>"0"</code></td>
<td><strong>Hue</strong> expression. Result is taken modulo 360. Range:
0 = red, 60 = yellow, 120 = green, 180 = cyan, 240 = blue, 300 =
magenta.</td>
</tr>
<tr>
<td><code>per_cell.s</code></td>
<td>string</td>
<td><code>"1"</code></td>
<td><strong>Saturation</strong> expression. Clamped to 0.0-1.0. 0 =
grayscale, 1 = fully saturated.</td>
</tr>
<tr>
<td><code>per_cell.l</code></td>
<td>string</td>
<td><code>"0.5"</code></td>
<td><strong>Lightness</strong> expression. Clamped to 0.0-1.0. 0 =
black, 0.5 = full color, 1 = white.</td>
</tr>
</tbody>
</table>
<h3 data-number="1.17.3" id="the-hsl-color-model"><span
class="header-section-number">1.17.3</span> The HSL Color Model</h3>
<p>HSL is used instead of RGB because it maps naturally to the way
people think about light panels:</p>
<ul>
<li><strong>Hue</strong> (0-360) is the color wheel position. Arithmetic
on hue creates smooth color transitions — just add an offset or multiply
by time.</li>
<li><strong>Saturation</strong> (0-1) controls how vivid the color is.
Useful for fading to gray.</li>
<li><strong>Lightness</strong> (0-1) controls brightness. 0 is
off/black, 0.5 is full color, 1 is white. This directly maps to “how
bright is this cell?”</li>
</ul>
<p>The engine automatically wraps negative hue values (e.g.,
<code>-30</code> becomes <code>330</code>) and clamps saturation and
lightness to valid ranges.</p>
<h3 data-number="1.17.4" id="expression-syntax"><span
class="header-section-number">1.17.4</span> Expression Syntax</h3>
<p>Expressions follow standard mathematical notation. They are parsed
using a recursive-descent parser with the following precedence (highest
to lowest):</p>
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 37%" />
<col style="width: 25%" />
<col style="width: 15%" />
</colgroup>
<thead>
<tr>
<th>Precedence</th>
<th>Operators / Constructs</th>
<th>Associativity</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>1 (highest)</td>
<td>Parentheses, function calls</td>
<td>—</td>
<td><code>sin(t)</code>, <code>(a + b)</code></td>
</tr>
<tr>
<td>2</td>
<td>Unary <code>-</code>, <code>+</code></td>
<td>Right</td>
<td><code>-cell_x</code>, <code>+1</code></td>
</tr>
<tr>
<td>3</td>
<td>Power <code>^</code>, <code>**</code></td>
<td>Right</td>
<td><code>2 ^ 3</code> = 8</td>
</tr>
<tr>
<td>4</td>
<td>Multiply <code>*</code>, divide <code>/</code>, modulo
<code>%</code></td>
<td>Left</td>
<td><code>t * 2</code>, <code>h % 360</code></td>
</tr>
<tr>
<td>5</td>
<td>Add <code>+</code>, subtract <code>-</code></td>
<td>Left</td>
<td><code>a + b - c</code></td>
</tr>
<tr>
<td>6</td>
<td>Comparison <code>&lt;</code>, <code>&gt;</code>, <code>&lt;=</code>,
<code>&gt;=</code>, <code>==</code>, <code>!=</code></td>
<td>Left</td>
<td><code>cell_x &gt; 5</code></td>
</tr>
<tr>
<td>7</td>
<td>Logical AND <code>&amp;&amp;</code></td>
<td>Left</td>
<td><code>cell_x &gt; 0 &amp;&amp; cell_y &gt; 0</code></td>
</tr>
<tr>
<td>8</td>
<td>Logical OR <code>||</code></td>
<td>Left</td>
<td><code>a &gt; 0 || b &gt; 0</code></td>
</tr>
<tr>
<td>9 (lowest)</td>
<td>Ternary <code>? :</code></td>
<td>Right</td>
<td><code>t &gt; 5 ? 1.0 : 0.0</code></td>
</tr>
</tbody>
</table>
<p><strong>Truthiness:</strong> In logical and ternary operations,
<code>0.0</code> is false and any non-zero value is true. Comparison
operators return <code>1.0</code> for true and <code>0.0</code> for
false.</p>
<p><strong>Number literals:</strong> Integers (<code>42</code>),
decimals (<code>3.14</code>), and scientific notation
(<code>1.5e3</code>, <code>2e-4</code>) are supported.</p>
<h3 data-number="1.17.5" id="built-in-variables"><span
class="header-section-number">1.17.5</span> Built-in Variables</h3>
<p>These variables are automatically set by the engine before evaluating
each cell on each frame.</p>
<h4 data-number="1.17.5.1" id="time-variables"><span
class="header-section-number">1.17.5.1</span> Time Variables</h4>
<table>
<colgroup>
<col style="width: 34%" />
<col style="width: 20%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr>
<th>Variable</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>t</code></td>
<td>float</td>
<td>Elapsed time in seconds since the script started. This is your
primary animation driver. Resets to 0 when a looping script
restarts.</td>
</tr>
<tr>
<td><code>frame</code></td>
<td>float</td>
<td>Frame number since script start (0, 1, 2, …). Useful for
frame-counting effects.</td>
</tr>
</tbody>
</table>
<h4 data-number="1.17.5.2"
id="grid-variables-constant-for-the-life-of-the-script"><span
class="header-section-number">1.17.5.2</span> Grid Variables (constant
for the life of the script)</h4>
<table>
<colgroup>
<col style="width: 34%" />
<col style="width: 20%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr>
<th>Variable</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>total_cells</code></td>
<td>float</td>
<td>Total number of cells in the grid.</td>
</tr>
<tr>
<td><code>total_rows</code></td>
<td>float</td>
<td>Number of rows in the grid.</td>
</tr>
<tr>
<td><code>total_cols</code></td>
<td>float</td>
<td>Number of columns in the grid. For triangle grids, this is the
number of triangles per row (<code>cols * 2 - 1</code>).</td>
</tr>
</tbody>
</table>
<h4 data-number="1.17.5.3"
id="per-cell-variables-change-for-each-cell"><span
class="header-section-number">1.17.5.3</span> Per-Cell Variables (change
for each cell)</h4>
<table>
<colgroup>
<col style="width: 34%" />
<col style="width: 20%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr>
<th>Variable</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>cell_x</code></td>
<td>float</td>
<td>Column index of the current cell (0-based).</td>
</tr>
<tr>
<td><code>cell_y</code></td>
<td>float</td>
<td>Row index of the current cell (0-based).</td>
</tr>
<tr>
<td><code>cell_index</code></td>
<td>float</td>
<td>Linear index of the current cell in row-major order (0, 1, 2,
…).</td>
</tr>
<tr>
<td><code>cell_dist_center</code></td>
<td>float</td>
<td>Normalized Euclidean distance from the cell to the grid center.
Ranges from 0.0 (center cell) to 1.0 (corner cell). Useful for radial
effects.</td>
</tr>
<tr>
<td><code>cell_angle</code></td>
<td>float</td>
<td>Angle in radians from the grid center to the cell, measured using
<code>atan2(row - centerRow, col - centerCol)</code>. Useful for spiral
and angular effects.</td>
</tr>
</tbody>
</table>
<h4 data-number="1.17.5.4" id="constants"><span
class="header-section-number">1.17.5.4</span> Constants</h4>
<table>
<thead>
<tr>
<th>Variable</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>PI</code></td>
<td>3.14159…</td>
<td>Mathematical constant pi.</td>
</tr>
</tbody>
</table>
<h4 data-number="1.17.5.5" id="user-variables"><span
class="header-section-number">1.17.5.5</span> User Variables</h4>
<p>Any key defined in the script’s <code>variables</code> block is
available as a named variable. User variables are set before built-in
variables, so built-in names take precedence if there’s a collision.</p>
<h3 data-number="1.17.6" id="built-in-functions"><span
class="header-section-number">1.17.6</span> Built-in Functions</h3>
<h4 data-number="1.17.6.1" id="trigonometric"><span
class="header-section-number">1.17.6.1</span> Trigonometric</h4>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 32%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Signature</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>sin(x)</code></td>
<td>1 arg</td>
<td>Sine. Input in radians. Returns -1 to 1.</td>
</tr>
<tr>
<td><code>cos(x)</code></td>
<td>1 arg</td>
<td>Cosine. Input in radians. Returns -1 to 1.</td>
</tr>
<tr>
<td><code>tan(x)</code></td>
<td>1 arg</td>
<td>Tangent. Input in radians.</td>
</tr>
<tr>
<td><code>asin(x)</code></td>
<td>1 arg</td>
<td>Arc sine. Input clamped to [-1, 1]. Returns radians.</td>
</tr>
<tr>
<td><code>acos(x)</code></td>
<td>1 arg</td>
<td>Arc cosine. Input clamped to [-1, 1]. Returns radians.</td>
</tr>
<tr>
<td><code>atan(x)</code></td>
<td>1 arg</td>
<td>Arc tangent. Returns radians.</td>
</tr>
<tr>
<td><code>atan2(y, x)</code></td>
<td>2 args</td>
<td>Two-argument arc tangent. Returns radians (-PI to PI).</td>
</tr>
</tbody>
</table>
<h4 data-number="1.17.6.2" id="rounding-and-sign"><span
class="header-section-number">1.17.6.2</span> Rounding and Sign</h4>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 32%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Signature</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>floor(x)</code></td>
<td>1 arg</td>
<td>Round down to nearest integer.</td>
</tr>
<tr>
<td><code>ceil(x)</code></td>
<td>1 arg</td>
<td>Round up to nearest integer.</td>
</tr>
<tr>
<td><code>round(x)</code></td>
<td>1 arg</td>
<td>Round to nearest integer (half-up).</td>
</tr>
<tr>
<td><code>abs(x)</code></td>
<td>1 arg</td>
<td>Absolute value.</td>
</tr>
<tr>
<td><code>sign(x)</code></td>
<td>1 arg</td>
<td>Returns -1, 0, or 1.</td>
</tr>
<tr>
<td><code>fract(x)</code></td>
<td>1 arg</td>
<td>Fractional part: <code>x - floor(x)</code>. Always in [0, 1).</td>
</tr>
</tbody>
</table>
<h4 data-number="1.17.6.3" id="exponential-and-power"><span
class="header-section-number">1.17.6.3</span> Exponential and Power</h4>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 32%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Signature</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>sqrt(x)</code></td>
<td>1 arg</td>
<td>Square root. Uses <code>abs(x)</code> to avoid NaN.</td>
</tr>
<tr>
<td><code>pow(x, y)</code></td>
<td>2 args</td>
<td><code>x</code> raised to the power <code>y</code>.</td>
</tr>
<tr>
<td><code>log(x)</code></td>
<td>1 arg</td>
<td>Natural logarithm. Returns 0 for non-positive input.</td>
</tr>
<tr>
<td><code>exp(x)</code></td>
<td>1 arg</td>
<td><code>e</code> raised to the power <code>x</code>.</td>
</tr>
</tbody>
</table>
<h4 data-number="1.17.6.4" id="clamping-and-interpolation"><span
class="header-section-number">1.17.6.4</span> Clamping and
Interpolation</h4>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 32%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Signature</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>min(a, b)</code></td>
<td>2 args</td>
<td>Smaller of <code>a</code> and <code>b</code>.</td>
</tr>
<tr>
<td><code>max(a, b)</code></td>
<td>2 args</td>
<td>Larger of <code>a</code> and <code>b</code>.</td>
</tr>
<tr>
<td><code>clamp(x, lo, hi)</code></td>
<td>3 args</td>
<td>Constrain <code>x</code> to the range <code>[lo, hi]</code>.</td>
</tr>
<tr>
<td><code>lerp(a, b, t)</code></td>
<td>3 args</td>
<td>Linear interpolation: <code>a + (b - a) * t</code>. When
<code>t</code> = 0 returns <code>a</code>, when <code>t</code> = 1
returns <code>b</code>.</td>
</tr>
<tr>
<td><code>step(edge, x)</code></td>
<td>2 args</td>
<td>Returns 1.0 if <code>x &gt;= edge</code>, else 0.0. Hard
threshold.</td>
</tr>
<tr>
<td><code>smoothstep(edge0, edge1, x)</code></td>
<td>3 args</td>
<td>Hermite interpolation between 0 and 1 when <code>x</code> is between
<code>edge0</code> and <code>edge1</code>. Produces an S-curve
transition.</td>
</tr>
</tbody>
</table>
<h4 data-number="1.17.6.5" id="modular-arithmetic"><span
class="header-section-number">1.17.6.5</span> Modular Arithmetic</h4>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 32%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Signature</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>fmod(x, y)</code></td>
<td>2 args</td>
<td>Floating-point remainder of <code>x / y</code>. Same as
<code>%</code> operator. Returns 0 if <code>y</code> is 0.</td>
</tr>
<tr>
<td><code>mod(x, y)</code></td>
<td>2 args</td>
<td>Alias for <code>fmod</code>.</td>
</tr>
</tbody>
</table>
<h4 data-number="1.17.6.6" id="noise-and-randomness"><span
class="header-section-number">1.17.6.6</span> Noise and Randomness</h4>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 32%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Signature</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>noise(x, y)</code></td>
<td>2 args</td>
<td>2D simplex noise. Returns values in approximately [-1, 1]. Smooth,
continuous, and deterministic for the same inputs. Ideal for organic,
natural-looking effects.</td>
</tr>
<tr>
<td><code>random()</code></td>
<td>0 args</td>
<td>Random number in [0, 1). Different value each call.
Non-deterministic — use <code>noise()</code> for repeatable
patterns.</td>
</tr>
</tbody>
</table>
<h4 data-number="1.17.6.7" id="conditional"><span
class="header-section-number">1.17.6.7</span> Conditional</h4>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 32%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Signature</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>if(cond, a, b)</code></td>
<td>3 args</td>
<td>If <code>cond</code> is non-zero, returns <code>a</code>, else
returns <code>b</code>. Equivalent to the ternary operator
<code>cond ? a : b</code>. Note: unlike the ternary operator, both
branches are always evaluated.</td>
</tr>
</tbody>
</table>
<h3 data-number="1.17.7" id="recipes-and-examples"><span
class="header-section-number">1.17.7</span> Recipes and Examples</h3>
<h4 data-number="1.17.7.1" id="rainbow-wave"><span
class="header-section-number">1.17.7.1</span> 1. Rainbow Wave</h4>
<p>A classic hue sweep across the grid, scrolling over time.</p>
<div class="sourceCode" id="cb73"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;per_cell&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;h&quot;</span><span class="fu">:</span> <span class="st">&quot;(cell_x * 20 + cell_y * 15 + t * 40) % 360&quot;</span><span class="fu">,</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;s&quot;</span><span class="fu">:</span> <span class="st">&quot;1.0&quot;</span><span class="fu">,</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;l&quot;</span><span class="fu">:</span> <span class="st">&quot;0.5&quot;</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>The <code>cell_x * 20</code> creates horizontal color variation,
<code>cell_y * 15</code> adds diagonal tilt, and <code>t * 40</code>
makes it move. Increase the multipliers for tighter color bands.</p>
<h4 data-number="1.17.7.2" id="pulsing-concentric-rings"><span
class="header-section-number">1.17.7.2</span> 2. Pulsing Concentric
Rings</h4>
<p>Rings of light expand outward from the center.</p>
<div class="sourceCode" id="cb74"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;variables&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ring_count&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;speed&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">},</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;per_cell&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;h&quot;</span><span class="fu">:</span> <span class="st">&quot;200&quot;</span><span class="fu">,</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;s&quot;</span><span class="fu">:</span> <span class="st">&quot;0.8&quot;</span><span class="fu">,</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;l&quot;</span><span class="fu">:</span> <span class="st">&quot;0.15 + 0.35 * (0.5 + 0.5 * sin(cell_dist_center * ring_count * 6.28 - t * speed))&quot;</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><code>cell_dist_center * ring_count * 6.28</code> creates multiple
sine wave rings. Subtracting <code>t * speed</code> makes them expand
outward. Change <code>ring_count</code> to control density.</p>
<h4 data-number="1.17.7.3" id="fire-effect"><span
class="header-section-number">1.17.7.3</span> 3. Fire Effect</h4>
<p>Warm colors flickering upward using noise.</p>
<div class="sourceCode" id="cb75"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;per_cell&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;h&quot;</span><span class="fu">:</span> <span class="st">&quot;10 + 25 * noise(cell_x * 0.5, t * 2)&quot;</span><span class="fu">,</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;s&quot;</span><span class="fu">:</span> <span class="st">&quot;1.0&quot;</span><span class="fu">,</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;l&quot;</span><span class="fu">:</span> <span class="st">&quot;clamp(0.6 * (1 - cell_y / total_rows) + 0.15 * noise(cell_x * 0.8, cell_y * 0.5 + t * 3), 0.02, 0.7)&quot;</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Hue varies between orange and red using noise. Lightness decreases
from bottom to top (fire rises), with noise adding flicker.
<code>clamp</code> prevents it from going fully black or white.</p>
<h4 data-number="1.17.7.4" id="color-zones-threshold-based"><span
class="header-section-number">1.17.7.4</span> 4. Color Zones
(Threshold-Based)</h4>
<p>Color cells based on their position — useful for status panels.</p>
<div class="sourceCode" id="cb76"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;per_cell&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;h&quot;</span><span class="fu">:</span> <span class="st">&quot;cell_x &lt; total_cols * 0.33 ? 0 : cell_x &lt; total_cols * 0.66 ? 60 : 120&quot;</span><span class="fu">,</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;s&quot;</span><span class="fu">:</span> <span class="st">&quot;0.9&quot;</span><span class="fu">,</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;l&quot;</span><span class="fu">:</span> <span class="st">&quot;0.45 + 0.05 * sin(t * 2)&quot;</span></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Left third is red (hue 0), middle is yellow (60), right is green
(120). The lightness gently pulses. Replace the thresholds with
sensor-driven user variables for a live status board.</p>
<h4 data-number="1.17.7.5" id="spiral"><span
class="header-section-number">1.17.7.5</span> 5. Spiral</h4>
<p>A color spiral rotating from the center.</p>
<div class="sourceCode" id="cb77"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;per_cell&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;h&quot;</span><span class="fu">:</span> <span class="st">&quot;(cell_angle / PI * 180 + cell_dist_center * 360 + t * 60) % 360&quot;</span><span class="fu">,</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;s&quot;</span><span class="fu">:</span> <span class="st">&quot;0.85&quot;</span><span class="fu">,</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;l&quot;</span><span class="fu">:</span> <span class="st">&quot;0.3 + 0.2 * cell_dist_center&quot;</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><code>cell_angle</code> provides the angular component,
<code>cell_dist_center</code> adds radial twist, and <code>t * 60</code>
makes it rotate. Cells further from center are slightly brighter.</p>
<h4 data-number="1.17.7.6" id="lava-lamp-smooth-organic-blobs"><span
class="header-section-number">1.17.7.6</span> 6. Lava Lamp (Smooth
Organic Blobs)</h4>
<div class="sourceCode" id="cb78"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;per_cell&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;h&quot;</span><span class="fu">:</span> <span class="st">&quot;noise(cell_x * 0.15, cell_y * 0.15 + t * 0.3) * 60 + 280&quot;</span><span class="fu">,</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;s&quot;</span><span class="fu">:</span> <span class="st">&quot;0.9&quot;</span><span class="fu">,</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;l&quot;</span><span class="fu">:</span> <span class="st">&quot;0.3 + 0.25 * smoothstep(-0.2, 0.5, noise(cell_x * 0.2 + t * 0.1, cell_y * 0.2 + t * 0.15))&quot;</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Two layers of simplex noise at different scales create slowly
drifting blobs. <code>smoothstep</code> sharpens the blob edges. Hue
stays in the purple/magenta range (280 +/- 60).</p>
<h4 data-number="1.17.7.7" id="strobe-flash-to-beat"><span
class="header-section-number">1.17.7.7</span> 7. Strobe / Flash to
Beat</h4>
<p>Flash all cells on a timed interval (e.g., every 0.5 seconds).</p>
<div class="sourceCode" id="cb79"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;variables&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;bpm&quot;</span><span class="fu">:</span> <span class="dv">120</span> <span class="fu">},</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;per_cell&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;h&quot;</span><span class="fu">:</span> <span class="st">&quot;0&quot;</span><span class="fu">,</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;s&quot;</span><span class="fu">:</span> <span class="st">&quot;0&quot;</span><span class="fu">,</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;l&quot;</span><span class="fu">:</span> <span class="st">&quot;fract(t * bpm / 60) &lt; 0.15 ? 1.0 : 0.02&quot;</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><code>t * bpm / 60</code> counts beats. <code>fract()</code> gives
position within the current beat (0-1). The first 15% of each beat is a
bright white flash, then dark. Adjust <code>0.15</code> for
longer/shorter flashes.</p>
<h4 data-number="1.17.7.8" id="matrix-digital-rain-per-column"><span
class="header-section-number">1.17.7.8</span> 8. Matrix / Digital Rain
Per Column</h4>
<div class="sourceCode" id="cb80"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;per_cell&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;h&quot;</span><span class="fu">:</span> <span class="st">&quot;120&quot;</span><span class="fu">,</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;s&quot;</span><span class="fu">:</span> <span class="st">&quot;1.0&quot;</span><span class="fu">,</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;l&quot;</span><span class="fu">:</span> <span class="st">&quot;clamp(0.5 - abs(cell_y - fmod(t * 4 + cell_x * 3.7, total_rows + 4)) * 0.15, 0.01, 0.5)&quot;</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Each column has a “raindrop” position calculated from time and a
per-column phase offset (<code>cell_x * 3.7</code>). Lightness falls off
around the drop position using <code>abs()</code>. Green hue (120) for
the classic Matrix look.</p>
<h4 data-number="1.17.7.9"
id="smooth-color-cycling-with-brightness-wave"><span
class="header-section-number">1.17.7.9</span> 9. Smooth Color Cycling
with Brightness Wave</h4>
<div class="sourceCode" id="cb81"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;per_cell&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;h&quot;</span><span class="fu">:</span> <span class="st">&quot;t * 20&quot;</span><span class="fu">,</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;s&quot;</span><span class="fu">:</span> <span class="st">&quot;0.9&quot;</span><span class="fu">,</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;l&quot;</span><span class="fu">:</span> <span class="st">&quot;0.25 + 0.25 * sin(cell_x * 0.5 + cell_y * 0.3 + t * 1.5)&quot;</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>All cells share the same slowly changing hue, but lightness varies
spatially as a diagonal sine wave. Simple yet visually rich.</p>
<h4 data-number="1.17.7.10" id="binary-clock-advanced"><span
class="header-section-number">1.17.7.10</span> 10. Binary Clock
(Advanced)</h4>
<p>Display hours and minutes as binary columns (conceptual — requires at
least 6 columns and 4 rows).</p>
<div class="sourceCode" id="cb82"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;variables&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;on_hue&quot;</span><span class="fu">:</span> <span class="dv">200</span><span class="fu">,</span> <span class="dt">&quot;off_l&quot;</span><span class="fu">:</span> <span class="fl">0.05</span> <span class="fu">},</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;per_cell&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;h&quot;</span><span class="fu">:</span> <span class="st">&quot;on_hue&quot;</span><span class="fu">,</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;s&quot;</span><span class="fu">:</span> <span class="st">&quot;0.8&quot;</span><span class="fu">,</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;l&quot;</span><span class="fu">:</span> <span class="st">&quot;fmod(floor(fmod(t / 60, 60) / pow(2, 3 - cell_y)), 2) &gt; 0.5 &amp;&amp; cell_x &lt; 6 ? 0.5 : off_l&quot;</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>This uses <code>t / 60</code> as a minute counter, divides by powers
of 2 per row to extract binary digits, and checks each bit. Each column
represents a digit, each row a bit position.</p>
<h3 data-number="1.17.8" id="performance-tips"><span
class="header-section-number">1.17.8</span> Performance Tips</h3>
<ul>
<li><strong>Keep <code>fps</code> at 30 or below.</strong> 60fps looks
no different on most LED panel grids and doubles the CPU cost.</li>
<li><strong><code>noise()</code> is the most expensive
function.</strong> One noise call per cell per frame is fine. Avoid
stacking 3+ noise calls in a single expression on large grids (500+
cells).</li>
<li><strong>Constant expressions are free.</strong>
<code>"s": "0.9"</code> is parsed once and evaluates to a constant — no
per-cell cost.</li>
<li><strong>Ternary expressions short-circuit.</strong>
<code>cell_x &gt; 5 ? expensive_expr : 0</code> still evaluates
<code>expensive_expr</code> for every cell (unlike the <code>? :</code>
operator in most programming languages). Use <code>if(cond, a, b)</code>
— it has the same behavior. Structure your grid size to minimize
unnecessary computation.</li>
<li><strong>For very large grids (1000+ cells)</strong>, consider
reducing <code>fps</code> to 15 and simplifying expressions. The engine
processes all cells sequentially on the main thread.</li>
</ul>
      <footer class="doc-footer">
        <p>
          <a href="https://kingkiosk.kallinnovations.com">KingKiosk</a>
          &mdash; The Programmable Display Runtime &mdash;
          &copy; Kall Innovations
        </p>
      </footer>
    </main>
  </div>

</div>

<!-- Back to Top -->
<button class="back-to-top" onclick="window.scrollTo({top:0,behavior:'smooth'})" aria-label="Back to top">
  &uarr;
</button>

<script>
// Back to Top visibility
const btn = document.querySelector('.back-to-top');
window.addEventListener('scroll', () => {
  btn.classList.toggle('visible', window.scrollY > 400);
});

// Active TOC highlight on scroll
const tocLinks = document.querySelectorAll('#TOC a');
const headings = [];
tocLinks.forEach(link => {
  const id = link.getAttribute('href');
  if (id && id.startsWith('#')) {
    const el = document.getElementById(id.slice(1));
    if (el) headings.push({ el, link });
  }
});

function updateActiveTOC() {
  let current = null;
  const scrollY = window.scrollY + 100;
  for (const { el, link } of headings) {
    if (el.offsetTop <= scrollY) {
      current = link;
    }
  }
  tocLinks.forEach(l => l.classList.remove('active'));
  if (current) current.classList.add('active');
}

window.addEventListener('scroll', updateActiveTOC, { passive: true });
updateActiveTOC();

// Close sidebar on mobile when clicking a link
document.querySelectorAll('.sidebar a').forEach(a => {
  a.addEventListener('click', () => {
    if (window.innerWidth <= 960) {
      document.querySelector('.sidebar').classList.remove('open');
    }
  });
});

// === Doc Nav Search ===
(function initNavSearch() {
  const input = document.getElementById('navSearchInput');
  const resultsEl = document.getElementById('navSearchResults');
  const kbdEl = document.querySelector('.nav-search-kbd');
  if (!input || !resultsEl) return;

  // Build search index from page headings + cross-doc links
  const index = [];

  // Current page headings (h2, h3, h4)
  const currentPage = location.pathname.split('/').pop() || 'index.html';
  const pageNames = {
    'index.html': 'Home',
    'KINGKIOSK_USER_GUIDE.html': 'User Guide',
    'MQTT_WIDGET_REFERENCE.html': 'MQTT Reference',
    'CUSTOM_WIDGET_SDK.html': 'Widget SDK'
  };
  const currentPageName = pageNames[currentPage] || 'Docs';

  document.querySelectorAll('h2, h3, h4').forEach(h => {
    if (!h.id) return;
    const num = h.querySelector('.header-section-number');
    const text = h.textContent.replace(/^\d+[\.\d]*\s*/, '').trim();
    if (!text) return;
    index.push({
      title: text,
      doc: currentPageName,
      url: '#' + h.id,
      isLocal: true
    });
  });

  // Cross-doc pages (always available)
  const docs = [
    { title: 'User Guide', doc: 'User Guide', url: 'KINGKIOSK_USER_GUIDE.html', isLocal: false },
    { title: 'MQTT Widget Reference', doc: 'MQTT Reference', url: 'MQTT_WIDGET_REFERENCE.html', isLocal: false },
    { title: 'Custom Widget SDK', doc: 'Widget SDK', url: 'CUSTOM_WIDGET_SDK.html', isLocal: false },
    { title: 'Documentation Home', doc: 'Home', url: 'index.html', isLocal: false }
  ];
  // Add cross-doc entries (skip current page)
  docs.forEach(d => {
    if (d.url !== currentPage) index.push(d);
  });

  // Common cross-doc topics for quick access
  const crossTopics = [
    { title: 'Getting Started', doc: 'User Guide', url: 'KINGKIOSK_USER_GUIDE.html' },
    { title: 'add_window', doc: 'MQTT Reference', url: 'MQTT_WIDGET_REFERENCE.html' },
    { title: 'remove_window', doc: 'MQTT Reference', url: 'MQTT_WIDGET_REFERENCE.html' },
    { title: 'arrange_windows', doc: 'MQTT Reference', url: 'MQTT_WIDGET_REFERENCE.html' },
    { title: 'Carousel', doc: 'MQTT Reference', url: 'MQTT_WIDGET_REFERENCE.html' },
    { title: 'Gauge Widget', doc: 'MQTT Reference', url: 'MQTT_WIDGET_REFERENCE.html' },
    { title: 'Chart Widget', doc: 'MQTT Reference', url: 'MQTT_WIDGET_REFERENCE.html' },
    { title: 'WebView', doc: 'MQTT Reference', url: 'MQTT_WIDGET_REFERENCE.html' },
    { title: 'Media Player', doc: 'MQTT Reference', url: 'MQTT_WIDGET_REFERENCE.html' },
    { title: 'Intercom', doc: 'MQTT Reference', url: 'MQTT_WIDGET_REFERENCE.html' },
    { title: 'Camera Widget', doc: 'MQTT Reference', url: 'MQTT_WIDGET_REFERENCE.html' },
    { title: 'Clock Widget', doc: 'MQTT Reference', url: 'MQTT_WIDGET_REFERENCE.html' },
    { title: 'Weather Widget', doc: 'MQTT Reference', url: 'MQTT_WIDGET_REFERENCE.html' },
    { title: 'Canvas Widget', doc: 'MQTT Reference', url: 'MQTT_WIDGET_REFERENCE.html' },
    { title: 'Animated Text', doc: 'MQTT Reference', url: 'MQTT_WIDGET_REFERENCE.html' },
    { title: 'LED Panel', doc: 'MQTT Reference', url: 'MQTT_WIDGET_REFERENCE.html' },
    { title: 'YouTube Widget', doc: 'MQTT Reference', url: 'MQTT_WIDGET_REFERENCE.html' },
    { title: 'Calendar Widget', doc: 'MQTT Reference', url: 'MQTT_WIDGET_REFERENCE.html' },
    { title: 'Map Widget', doc: 'MQTT Reference', url: 'MQTT_WIDGET_REFERENCE.html' },
    { title: 'Kiosk Mode', doc: 'User Guide', url: 'KINGKIOSK_USER_GUIDE.html' },
    { title: 'Home Assistant', doc: 'User Guide', url: 'KINGKIOSK_USER_GUIDE.html' },
    { title: 'Screen Presets', doc: 'User Guide', url: 'KINGKIOSK_USER_GUIDE.html' },
    { title: 'Scheduling', doc: 'User Guide', url: 'KINGKIOSK_USER_GUIDE.html' },
    { title: 'MQTT Connection', doc: 'User Guide', url: 'KINGKIOSK_USER_GUIDE.html' },
    { title: 'Topic Structure', doc: 'MQTT Reference', url: 'MQTT_WIDGET_REFERENCE.html' },
    { title: 'Command Envelope', doc: 'MQTT Reference', url: 'MQTT_WIDGET_REFERENCE.html' },
    { title: 'window.KingKiosk API', doc: 'Widget SDK', url: 'CUSTOM_WIDGET_SDK.html' },
    { title: 'onCommand()', doc: 'Widget SDK', url: 'CUSTOM_WIDGET_SDK.html' },
    { title: 'sendCommand()', doc: 'Widget SDK', url: 'CUSTOM_WIDGET_SDK.html' },
    { title: 'publishTelemetry()', doc: 'Widget SDK', url: 'CUSTOM_WIDGET_SDK.html' },
    { title: 'TTS / Text-to-Speech', doc: 'MQTT Reference', url: 'MQTT_WIDGET_REFERENCE.html' },
    { title: 'Screenshot', doc: 'MQTT Reference', url: 'MQTT_WIDGET_REFERENCE.html' },
    { title: 'Notification', doc: 'MQTT Reference', url: 'MQTT_WIDGET_REFERENCE.html' },
    { title: 'Apple TV / tvOS', doc: 'User Guide', url: 'KINGKIOSK_USER_GUIDE.html' },
    { title: 'Android Setup', doc: 'User Guide', url: 'KINGKIOSK_USER_GUIDE.html' },
    { title: 'iOS Setup', doc: 'User Guide', url: 'KINGKIOSK_USER_GUIDE.html' },
    { title: 'Windows Setup', doc: 'User Guide', url: 'KINGKIOSK_USER_GUIDE.html' },
    { title: 'macOS Setup', doc: 'User Guide', url: 'KINGKIOSK_USER_GUIDE.html' },
    { title: 'Linux Setup', doc: 'User Guide', url: 'KINGKIOSK_USER_GUIDE.html' },
  ];
  crossTopics.forEach(t => {
    if (t.url !== currentPage) {
      index.push({ title: t.title, doc: t.doc, url: t.url, isLocal: false });
    }
  });

  let activeIdx = -1;
  let filtered = [];
  let isOpen = false;

  function search(query) {
    const words = query.toLowerCase().trim().split(/\s+/).filter(Boolean);
    if (!words.length) return [];
    const scored = [];
    const seen = new Set();
    for (const item of index) {
      const hay = item.title.toLowerCase();
      let match = true;
      let score = 0;
      for (const w of words) {
        if (!hay.includes(w)) { match = false; break; }
        if (hay.startsWith(w)) score += 10;
        score += 5;
      }
      if (!match) continue;
      // Boost local (same-page) results
      if (item.isLocal) score += 3;
      const key = item.title + '|' + item.url;
      if (seen.has(key)) continue;
      seen.add(key);
      scored.push({ item, score });
    }
    scored.sort((a, b) => b.score - a.score);
    return scored.slice(0, 15).map(s => s.item);
  }

  function highlight(text, query) {
    const words = query.toLowerCase().trim().split(/\s+/).filter(Boolean);
    let result = text;
    for (const w of words) {
      const escaped = w.replace(/[.*+?^{}()|[\]\\]/g, '\\' + String.fromCharCode(36) + '&');
      const re = new RegExp('(' + escaped + ')', 'gi');
      result = result.replace(re, '<mark>' + String.fromCharCode(36) + '1</mark>');
    }
    return result;
  }

  function render(items, query) {
    if (!items.length) {
      resultsEl.innerHTML = '<div class="nav-search-empty">No results found</div>';
      resultsEl.classList.add('open');
      isOpen = true;
      return;
    }
    // Group: This Page vs Other Docs
    const local = items.filter(i => i.isLocal);
    const other = items.filter(i => !i.isLocal);
    let html = '';
    if (local.length) {
      html += '<div class="nav-search-group"><div class="nav-search-group-label">This Page</div>';
      local.forEach(item => {
        const idx = filtered.indexOf(item);
        html += '<a href="' + item.url + '" class="nav-search-item' + (idx === activeIdx ? ' active' : '') + '" data-idx="' + idx + '">'
          + '<div class="nav-search-item-title">' + highlight(item.title, query) + '</div>'
          + '</a>';
      });
      html += '</div>';
    }
    if (other.length) {
      html += '<div class="nav-search-group"><div class="nav-search-group-label">Other Docs</div>';
      other.forEach(item => {
        const idx = filtered.indexOf(item);
        html += '<a href="' + item.url + '" class="nav-search-item' + (idx === activeIdx ? ' active' : '') + '" data-idx="' + idx + '">'
          + '<div class="nav-search-item-title">' + highlight(item.title, query) + '</div>'
          + '<div class="nav-search-item-doc">' + item.doc + '</div>'
          + '</a>';
      });
      html += '</div>';
    }
    resultsEl.innerHTML = html;
    resultsEl.classList.add('open');
    isOpen = true;
  }

  function close() {
    resultsEl.classList.remove('open');
    resultsEl.innerHTML = '';
    isOpen = false;
    activeIdx = -1;
  }

  function updateActive() {
    resultsEl.querySelectorAll('.nav-search-item').forEach(el => {
      el.classList.toggle('active', parseInt(el.dataset.idx) === activeIdx);
    });
    const act = resultsEl.querySelector('.nav-search-item.active');
    if (act) act.scrollIntoView({ block: 'nearest' });
  }

  input.addEventListener('input', () => {
    const q = input.value.trim();
    if (!q) { close(); return; }
    filtered = search(q);
    activeIdx = -1;
    render(filtered, q);
  });

  input.addEventListener('keydown', (e) => {
    if (!isOpen) return;
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      activeIdx = Math.min(activeIdx + 1, filtered.length - 1);
      updateActive();
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      activeIdx = Math.max(activeIdx - 1, -1);
      updateActive();
    } else if (e.key === 'Enter' && activeIdx >= 0 && filtered[activeIdx]) {
      e.preventDefault();
      const entry = filtered[activeIdx];
      if (entry.isLocal) {
        const el = document.getElementById(entry.url.slice(1));
        if (el) el.scrollIntoView({ behavior: 'smooth' });
      } else {
        window.location.href = entry.url;
      }
      close();
      input.blur();
    } else if (e.key === 'Escape') {
      close();
      input.blur();
    }
  });

  document.addEventListener('click', (e) => {
    if (!e.target.closest('.nav-search-wrap')) close();
  });

  // "/" keyboard shortcut
  document.addEventListener('keydown', (e) => {
    if (e.key === '/' && !e.ctrlKey && !e.metaKey && !e.altKey) {
      const tag = document.activeElement?.tagName;
      if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;
      e.preventDefault();
      input.focus();
    }
  });

  input.addEventListener('focus', () => { if (kbdEl) kbdEl.style.opacity = '0'; });
  input.addEventListener('blur', () => { if (kbdEl && !input.value) kbdEl.style.opacity = '1'; });
})();
</script>

</body>
</html>
